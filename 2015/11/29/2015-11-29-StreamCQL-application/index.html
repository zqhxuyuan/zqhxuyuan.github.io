<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>StreamCQLæºç é˜…è¯»(4) åº”ç”¨ç¨‹åºæ‰§è¡Œ | zqhxuyuan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="StreamCQLåº”ç”¨ç¨‹åºæ‰§è¡Œæµç¨‹">
<meta name="keywords" content="storm">
<meta property="og:type" content="article">
<meta property="og:title" content="StreamCQLæºç é˜…è¯»(4) åº”ç”¨ç¨‹åºæ‰§è¡Œ">
<meta property="og:url" content="http://github.com/zqhxuyuan/2015/11/29/2015-11-29-StreamCQL-application/index.html">
<meta property="og:site_name" content="zqhxuyuan">
<meta property="og:description" content="StreamCQLåº”ç”¨ç¨‹åºæ‰§è¡Œæµç¨‹">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://images.weserv.nl/?url=http://img.blog.csdn.net/20151130093405880">
<meta property="og:image" content="https://images.weserv.nl/?url=http://img.blog.csdn.net/20151201165952194">
<meta property="og:image" content="https://images.weserv.nl/?url=http://img.blog.csdn.net/20151130172800418">
<meta property="og:updated_time" content="2019-02-14T13:42:29.197Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="StreamCQLæºç é˜…è¯»(4) åº”ç”¨ç¨‹åºæ‰§è¡Œ">
<meta name="twitter:description" content="StreamCQLåº”ç”¨ç¨‹åºæ‰§è¡Œæµç¨‹">
<meta name="twitter:image" content="https://images.weserv.nl/?url=http://img.blog.csdn.net/20151130093405880">
  
    <link rel="alternative" href="/atom.xml" title="zqhxuyuan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½</a></h1>
		</hgroup>

		
				


		
			<div id="switch-btn" class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>èœå•</li>
						<li>æ ‡ç­¾</li>
						
						
						<li>å…³äºæˆ‘</li>
						
					</ul>
				</div>
			</div>
		

		<div id="switch-area" class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">ä¸»é¡µ</a></li>
				        
							<li><a href="/archives/">å½’æ¡£</a></li>
				        
							<li><a href="/tags/">æ ‡ç­¾</a></li>
				        
							<li><a href="/about/">å…³äº</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<ul class="social">
							
								<li id="æ–°æµªå¾®åš"><a class="æ–°æµªå¾®åš" target="_blank" href="http://weibo.com/xuyuantree" title="æ–°æµªå¾®åš"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
								<li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
					        
						</ul>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/apex/" style="font-size: 10px;">apex</a> <a href="/tags/bigdata/" style="font-size: 10px;">bigdata</a> <a href="/tags/book/" style="font-size: 10px;">book</a> <a href="/tags/cassandra/" style="font-size: 18.89px;">cassandra</a> <a href="/tags/clojure/" style="font-size: 10px;">clojure</a> <a href="/tags/drill/" style="font-size: 16.67px;">drill</a> <a href="/tags/druid/" style="font-size: 13.33px;">druid</a> <a href="/tags/dubbo/" style="font-size: 10px;">dubbo</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/etl/" style="font-size: 10px;">etl</a> <a href="/tags/geode/" style="font-size: 10px;">geode</a> <a href="/tags/graph/" style="font-size: 12.22px;">graph</a> <a href="/tags/hadoop/" style="font-size: 11.11px;">hadoop</a> <a href="/tags/hbase/" style="font-size: 15.56px;">hbase</a> <a href="/tags/ignite/" style="font-size: 10px;">ignite</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/tags/kafka/" style="font-size: 20px;">kafka</a> <a href="/tags/midd/" style="font-size: 10px;">midd</a> <a href="/tags/ops/" style="font-size: 12.22px;">ops</a> <a href="/tags/redis/" style="font-size: 11.11px;">redis</a> <a href="/tags/rocketmq/" style="font-size: 10px;">rocketmq</a> <a href="/tags/scala/" style="font-size: 13.33px;">scala</a> <a href="/tags/spark/" style="font-size: 17.78px;">spark</a> <a href="/tags/storm/" style="font-size: 17.78px;">storm</a> <a href="/tags/tcc/" style="font-size: 10px;">tcc</a> <a href="/tags/timeseries/" style="font-size: 12.22px;">timeseries</a> <a href="/tags/work/" style="font-size: 14.44px;">work</a> <a href="/tags/æµå¤„ç†/" style="font-size: 11.11px;">æµå¤„ç†</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">BIG(DATA)</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"><a href="/" title="å›åˆ°ä¸»é¡µ">ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½</a></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<a href="/" class="profilepic">
				<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			</a>
			<hgroup>
			  <h1 class="header-author"><a href="/" title="å›åˆ°ä¸»é¡µ">ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½</a></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">ä¸»é¡µ</a></li>
		        
					<li><a href="/archives/">å½’æ¡£</a></li>
		        
					<li><a href="/tags/">æ ‡ç­¾</a></li>
		        
					<li><a href="/about/">å…³äº</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
						<ul class="social">
							
								<li id="æ–°æµªå¾®åš"><a class="æ–°æµªå¾®åš" target="_blank" href="http://weibo.com/xuyuantree" title="æ–°æµªå¾®åš"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
								<li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
					        
						</ul>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-2015-11-29-StreamCQL-application" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/11/29/2015-11-29-StreamCQL-application/" class="article-date">
  	<time datetime="2015-11-28T16:00:00.000Z" itemprop="datePublished">2015-11-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      StreamCQLæºç é˜…è¯»(4) åº”ç”¨ç¨‹åºæ‰§è¡Œ
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Source/">Source</a>
	</div>


        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/storm/">storm</a></li></ul>
	</div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>StreamCQLåº”ç”¨ç¨‹åºæ‰§è¡Œæµç¨‹</p>
<a id="more"></a>
<h2 id="å‰æˆ:_CQLä»£ç ç»“æ„">å‰æˆ: CQLä»£ç ç»“æ„</h2><p>ä¹‹å‰æˆ‘ä»¬å¹¶æ²¡æœ‰æ¢³ç†CQLéƒ¨åˆ†çš„ä»£ç ç»“æ„, åœ¨åˆ†æäº†å·®ä¸å¤šçš„ä»£ç ä¹‹å, æ¥çœ‹çœ‹æ¯ä¸ªéƒ¨åˆ†éƒ½ä¸€ä¸€å¯¹åº”:  </p>
<p><img src="https://images.weserv.nl/?url=http://img.blog.csdn.net/20151130093405880" alt="cql"></p>
<p>è¿˜æ²¡æœ‰æ¶‰åŠçš„åŒ…æ‹¬: PhysicalPlan,ç‰©ç†è®¡åˆ’/é€»è¾‘è®¡åˆ’ä¼˜åŒ–å™¨,executorsæ‰§è¡Œå™¨.    </p>
<h2 id="æ­£æ–‡:_submitApplication">æ­£æ–‡: submitApplication</h2><p>å†ç»åƒè¾›ä¸‡è‹¦, ç»ˆäºå›åˆ°SubmitTaskçš„submitApplication, åˆ›å»ºç‰©ç†è®¡åˆ’Executor,å¹¶æ‰§è¡ŒApplication.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">submitApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> PhysicalPlanExecutor().execute(context.getApp());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="api-Application_-&gt;_application-Application">api.Application -&gt; application.Application</h3><p>apiçš„Applicationæ˜¯æµå¤„ç†æ‰§è¡Œè®¡åˆ’åº”ç”¨ç¨‹åº, å°è£…çš„æ˜¯CQLè¯­å¥æ„å»ºè€Œæˆçš„åº”ç”¨ç¨‹åº:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;                      </span><br><span class="line">    <span class="keyword">private</span> String applicationId = <span class="keyword">null</span>;                    <span class="comment">//åº”ç”¨id</span></span><br><span class="line">    <span class="keyword">private</span> String applicationName = <span class="keyword">null</span>;                  <span class="comment">//åº”ç”¨åç§°</span></span><br><span class="line">    <span class="keyword">private</span> TreeMap&lt;String, String&gt; confs;                  <span class="comment">//æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­ç”¨åˆ°çš„é…ç½®å±æ€§,ä¹ŸåŒ…å«ç”¨æˆ·è‡ªå®šä¹‰çš„é…ç½®å±æ€§</span></span><br><span class="line">    <span class="keyword">private</span> String[] userFiles;                             <span class="comment">//ç”¨æˆ·è‡ªå®šä¹‰æ·»åŠ çš„ä¸€äº›æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;UserFunction&gt; userFunctions;               <span class="comment">//ç”¨æˆ·è‡ªå®šä¹‰çš„å‡½æ•°,udfå’Œudaféƒ½åœ¨è¿™ä¸ªé‡Œé¢</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Schema&gt; schemas = <span class="keyword">new</span> ArrayList&lt;Schema&gt;(); <span class="comment">//æ‰§è¡Œè®¡åˆ’ä¸­çš„æ‰€æœ‰çš„schema</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Operator&gt; operators = <span class="keyword">null</span>;                <span class="comment">//æ‰§è¡Œè®¡åˆ’ä¸­æ‰€æœ‰çš„æ“ä½œ,åŒ…å«è¾“å…¥ã€è¾“å‡ºå’Œè®¡ç®—æ“ä½œ      </span></span><br><span class="line">    <span class="keyword">private</span> List&lt;OperatorTransition&gt; opTransition = <span class="keyword">null</span>;   <span class="comment">//æ•´ä¸ªæ‰§è¡Œè®¡åˆ’ä¸­æ‰€æœ‰çš„è¿æ¥çº¿ï¼Œå®šä¹‰äº†operatorä¹‹é—´çš„è¿æ¥å…³ç³»</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿˜è®°å¾—ä¸Šä¸€ç¯‡ä¸­åœ¨buildApplicationæ—¶,ç”±SplitContextæ‹†åˆ†ç®—å­,ç»„åˆç®—å­ä¼šæŠŠoperatorså’Œtransitionséƒ½è®¾ç½®åˆ°Applicationé‡Œå—?  </p>
</blockquote>
<p>application.Applicationé’ˆå¯¹Schemaå’ŒOperatoré‡‡ç”¨Managerç®¡ç†ç±»(å®é™…ä¸Šåº•å±‚çš„å­˜å‚¨ç»“æ„éƒ½æ˜¯Map)æ¥æ“ä½œ:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String appName;                 <span class="comment">//åº”ç”¨ç¨‹åºåç§°</span></span><br><span class="line">    <span class="keyword">private</span> EventTypeMng streamSchema;      <span class="comment">//æ‰€æœ‰Schemaé›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> OperatorMng operatorManager;    <span class="comment">//ç®—å­é›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> StreamingConfig conf;           <span class="comment">//ç³»ç»Ÿçº§åˆ«çš„é…ç½®å±æ€§</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Applicationåœ¨<code>API</code>å’Œ<code>ç‰©ç†è®¡åˆ’</code>æ˜¯ä¸åŒçš„å¯¹è±¡, åŒæ ·APIé˜¶æ®µçš„<code>Operator</code>åœ¨ç‰©ç†è®¡åˆ’ä¸­å¯¹åº”çš„æ˜¯<code>IRichOperator</code>.  </p>
<h4 id="IRichOperator">IRichOperator</h4><p>OperatorMngç®¡ç†çš„ç®—å­åŒ…æ‹¬è¾“å…¥ç®—å­(addInputStream),è¾“å‡ºç®—å­(addOutputStream),åŠŸèƒ½ç®—å­(addFunctionStream).  </p>
<blockquote>
<p>è™½ç„¶ä¸¤ä¸ªOperatorå¤„äºä¸åŒçš„é˜¶æ®µ, ä½†æ˜¯æ€»çš„æ¥è¯´éƒ½å¯ä»¥åˆ†ä¸ºè¾“å…¥,è¾“å‡ºå’ŒFunction.  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">â‘  application â¬‡ï¸                                            â‘¡ api â¬‡ï¸</span><br><span class="line">IRichOperator (com.huawei.streaming.operator)               Operator (com.huawei.streaming.api.opereators)</span><br><span class="line">    |-- AbsOperator                                             |-- FunctionStreamOperator</span><br><span class="line">        |-- FunctionOperator                                    |-- InnerOutputSourceOperator      </span><br><span class="line">            |-- JoinFunctionOp                                  |-- SplitterOperator</span><br><span class="line">                |-- DataSourceFunctionOp                        |-- OutputStreamOperator</span><br><span class="line">            |-- AggFunctionOp                                   |-- InputStreamOperator</span><br><span class="line">            |-- SplitOp                                         |-- InnerInputSourceOperator</span><br><span class="line">            |-- UnionFunctionOp                                 |-- InnerFunctionOperator</span><br><span class="line">            |-- SelfJoinFunctionOp                                      |-- FunctorOperator</span><br><span class="line">            |-- FunctorOp                                               |-- UnionOperator</span><br><span class="line">            |-- FilterFunctionOp                                        |-- FilterOperator</span><br><span class="line">        |-- OutputOperator                                              |-- BasicAggFunctionOperator</span><br><span class="line">        |-- FunctionStreamOperator                                              |-- JoinFunctionOperator</span><br><span class="line">        |-- InputOperator                                                       |-- AggregateOperator</span><br><span class="line">                                                                                |-- BaseDataSourceOperator</span><br></pre></td></tr></table></figure>
<p><code>IRichOperatoræµå¤„ç†ç®—å­</code>åŸºæœ¬æ¥å£: æ‰€æœ‰çš„æµå¤„ç†ç›¸å…³çš„ç®—å­å®ç°ï¼Œéƒ½æ¥æºäºè¿™ä¸ªç®—å­, æ‰€æœ‰çš„å¤–éƒ¨Stormå®ç°å‡ä¾èµ–äºè¿™ä¸ªæ¥å£  </p>
<p>æ­£å¸¸çš„CQL insertè¯­å¥åªæœ‰ä¸€ä¸ªè¾“å‡º,æ‰€ä»¥åœ¨å‰é¢çš„SplitContextä¸­ä¼šæœ‰ä¸€ä¸ªoutputStreamNameå’Œä¸€ç³»åˆ—çš„operatorså’Œtransitions.<br>ä½†æ˜¯è¿™é‡Œå¯¹äºIRichOperatoræµç®—å­, å®ƒæ˜¯æ„æˆStormçš„Topologyç»„ä»¶,å°±å¿…é¡»è€ƒè™‘ç®—å­ä¹‹é—´æ•°æ®çš„æµåŠ¨,ä¸€ä¸ªBoltå¯èƒ½æœ‰å¤šä¸ªè¾“å…¥å’Œè¾“å‡º.    </p>
<p><img src="https://images.weserv.nl/?url=http://img.blog.csdn.net/20151201165952194" alt="stream_inout"></p>
<blockquote>
<p>å¯¹äºä¸€ä¸ªç®—å­è€Œè¨€,è¾“å…¥æ•°æ®å¯ä»¥æœ‰å¤šä¸ª.ä½†æ˜¯è¾“å‡ºæ˜¯åªæœ‰ä¸€ä¸ª! è¿™å°±å¥½æ¯”æœ€ç»ˆçš„selectåªä¼šæœ‰ä¸€ä¸ªè¾“å‡ºschema: selectè¾“å‡ºçš„æ•°æ®ä½œä¸ºç®—å­çš„è¾“å‡º.<br>æ‰€ä»¥IRichOperatorçš„è¾“å…¥getInputStreamå’ŒgetInputSchemaéƒ½æ˜¯é›†åˆ, è€Œè¾“å‡ºçš„getOutputStreamå’ŒgetOutputSchemaéƒ½æ˜¯å•ä¸€çš„.<br>Update: è¾“å…¥è¾“å‡ºè¿™é‡Œå…¶å®çœ‹æµï¼Œåæ­£æ˜¯ä¸€ä¸ªæµä¸€ä¸ªåç§°ã€‚éƒ½æ˜¯å…è®¸å¤šè¾“å…¥å¤šè¾“å‡ºçš„ã€‚ä¸€ä¸ªç®—å­å°±æ˜¯ä¸€ä¸ªæµï¼Œä¸€ä¸ªç®—å­çš„å¤šä¸ªå®ä¾‹éƒ½å±äºä¸€ä¸ªæµã€‚  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IRichOperator</span> <span class="keyword">extends</span> <span class="title">IOperator</span>, <span class="title">Configurable</span></span>&#123;     <span class="comment">//â‘  æµå¤„ç†ç®—å­åŸºæœ¬æ¥å£</span></span><br><span class="line">    <span class="function">String <span class="title">getOperatorId</span><span class="params">()</span></span>;                     <span class="comment">//è·å–ç®—å­id</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getParallelNumber</span><span class="params">()</span></span>;                    <span class="comment">//è·å–ç®—å­å¹¶å‘åº¦</span></span><br><span class="line">    <span class="function">List&lt;String&gt; <span class="title">getInputStream</span><span class="params">()</span></span>;              <span class="comment">//è·å–è¾“å…¥æµåç§°, å¤šä¸ªè¾“å…¥æµ</span></span><br><span class="line">    <span class="function">String <span class="title">getOutputStream</span><span class="params">()</span></span>;                   <span class="comment">//è·å–è¾“å‡ºæµåç§°</span></span><br><span class="line">    <span class="function">Map&lt;String, IEventType&gt; <span class="title">getInputSchema</span><span class="params">()</span></span>;   <span class="comment">//è·å–è¾“å…¥schema  â¬…ï¸ &lt;keyæ˜¯è¾“å…¥æµåç§°,IEventTypeæ˜¯è¾“å…¥æµçš„Schema&gt;</span></span><br><span class="line">    <span class="function">IEventType <span class="title">getOutputSchema</span><span class="params">()</span></span>;               <span class="comment">//è·å–è¾“å‡ºschema  â¬…ï¸ </span></span><br><span class="line">    <span class="function">Map&lt;String, GroupInfo&gt; <span class="title">getGroupInfo</span><span class="params">()</span></span>;      <span class="comment">//è·å–åˆ†ç»„ä¿¡æ¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Operator</span> </span>&#123;                         <span class="comment">// â‘¡ æ¯ä¸ªè®¡ç®—å•å…ƒæˆä¸ºä¸€ä¸ªOperator,å®šä¹‰äº†å„ç±»æ“ä½œ.åˆ†ä¸ºSourceå’ŒInnerFunction</span></span><br><span class="line">    <span class="keyword">private</span> String id;                          <span class="comment">//ç®—å­ID</span></span><br><span class="line">    <span class="keyword">private</span> String name;                        <span class="comment">//ç®—å­åç§°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> parallelNumber;                 <span class="comment">//å¹¶è¡Œåº¦</span></span><br><span class="line">    <span class="keyword">private</span> TreeMap&lt;String, String&gt; args;       <span class="comment">//æ¯ä¸ªoperatorçš„å‚æ•°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OperatorTransition</span> </span>&#123;               <span class="comment">// â‘¢ å„ç§Operatorçš„è¿æ¥å…³ç³»,å®šä¹‰äº†ä»ä¸€ä¸ªoperatoråˆ°å¦å¤–ä¸€ä¸ªoperatorçš„è¿æ¥</span></span><br><span class="line">    <span class="keyword">private</span> String id;                          <span class="comment">//å½“å‰è¿æ¥çš„id</span></span><br><span class="line">    <span class="keyword">private</span> String streamName;                  <span class="comment">//æµåç§°</span></span><br><span class="line">    <span class="keyword">private</span> String fromOperatorId;              <span class="comment">//å‘èµ·è¿æ¥çš„Operator id</span></span><br><span class="line">    <span class="keyword">private</span> String toOperatorId;                <span class="comment">//æ¥æ”¶è¿æ¥çš„Operator id</span></span><br><span class="line">    <span class="keyword">private</span> DistributeType distributedType;     <span class="comment">//æ•°æ®è·å–ç±»å‹,ä»…ä»…åœ¨ésourceOperatorä¸­å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">private</span> String distributedFields;           <span class="comment">//æ•°æ®åˆ†å‘å­—æ®µ, ä»…åœ¨distributedTypeä¸ºfieldçš„æ—¶å€™ç”Ÿæ•ˆ</span></span><br><span class="line">    <span class="keyword">private</span> String schemaName;                  <span class="comment">//æµä¸Šè¿›è¡Œæ•°æ®ä¼ è¾“çš„æ—¶å€™çš„schemaåç§°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿˜è®°å¾—ä¸Šä¸€ç« åœ¨åˆ›å»ºTransitionæ—¶ä¼šæŒ‡å®šåˆ†ç»„å­—æ®µå’Œåˆ†ç»„ç­–ç•¥å—? å’Œè¿™é‡Œçš„GroupByåº”è¯¥æ˜¯ä¼šæœ‰ç‚¹è¡€ç¼˜å…³ç³»çš„. å½“ç„¶ç®—å­è¿˜å°‘ä¸äº†è¾“å…¥è¾“å‡ºSchema.   </p>
</blockquote>
<h4 id="PhysicalPlanExecutor_-&gt;_ExecutorPlanGenerator">PhysicalPlanExecutor -&gt; ExecutorPlanGenerator</h4><p>PhysicalPlanExecutor.executeä¼ å…¥çš„æ˜¯APIçš„Application, è€Œsubmit(app)çš„appæ˜¯application.Application.<br>æ€ä¹ˆè½¬æ¢: é€šè¿‡ExecutorPlanGeneratorç‰©ç†è®¡åˆ’ç”Ÿæˆå™¨ç”Ÿæˆå¯æ‰§è¡Œçš„è®¡åˆ’. å¯æ‰§è¡ŒæŒ‡çš„æ˜¯å¯ä»¥è¿è¡Œåœ¨Stormå¼•æ“.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Application apiApplication)</span> </span>&#123;</span><br><span class="line">    LOG.info(<span class="string">"start to execute application &#123;&#125;"</span>, apiApplication.getApplicationId());        </span><br><span class="line">    parseUserDefineds(apiApplication, isStartFromDriver);   <span class="comment">//â‘  å‡†å¤‡å·¥ä½œ</span></span><br><span class="line">    com.huawei.streaming.application.Application app = generatorPlan(apiApplication);   <span class="comment">// â¬…ï¸ API.App-&gt;application.App</span></span><br><span class="line">    submit(app);                    <span class="comment">//â‘£ æäº¤Application</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç”±ç‰©ç†æ‰§è¡Œè®¡åˆ’api.Applicationç”Ÿæˆå¯æ‰§è¡Œè®¡åˆ’application.Application(æœ€ç»ˆç”Ÿæˆçš„ï¼Œå¯ä»¥æäº¤çš„åº”ç”¨ç¨‹åº)</span></span><br><span class="line"><span class="keyword">private</span> com.huawei.streaming.application.<span class="function">Application <span class="title">generatorPlan</span><span class="params">(Application apiApplication)</span> </span>&#123;</span><br><span class="line">    preExecute(apiApplication);     <span class="comment">//æ‰§è¡Œå™¨æ‰§è¡Œä¹‹å‰çš„é’©å­</span></span><br><span class="line">    <span class="keyword">new</span> PhysicPlanChecker().check(apiApplication);</span><br><span class="line">    <span class="comment">//â‘¡ ç”¨æˆ·è‡ªå®šä¹‰çš„å¤„ç†: æ‰§è¡Œè®¡åˆ’çš„ç»„è£…, æ„å»ºapplication, è¡¨è¾¾å¼çš„è§£æè¢«å»¶è¿Ÿåˆ°è¿™é‡Œæ¥å®ç°</span></span><br><span class="line">    com.huawei.streaming.application.Application app = generator.generate(apiApplication);  </span><br><span class="line">    preSubmit(app);                 <span class="comment">//æäº¤æ‰§è¡Œè®¡åˆ’ä¹‹å‰çš„é’©å­</span></span><br><span class="line">    executorChecker.check(app);     <span class="comment">//â‘¢ æ‰§è¡Œè®¡åˆ’æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>â‘ å‡†å¤‡å·¥ä½œ<code>parseUserDefineds</code>: æ³¨å†ŒjaråŒ…,æ³¨å†Œå‡½æ•°,æ‰“åŒ…ç­‰(ç±»ä¼¼stormä¸­éœ€è¦ä¸Šä¼ jaråŒ…).    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">2015-11-25 02:32:24 | INFO  | [main] | ğŸ‘‰ start to execute application example | com.huawei.streaming.cql.executor.PhysicalPlanExecutor (PhysicalPlanExecutor.java:127)</span><br><span class="line">2015-11-25 02:32:25 | INFO  | [main] | start to unzip jar stream-storm-1.0-jar-with-dependencies.jar | com.huawei.streaming.cql.executor.mergeuserdefinds.JarExpander (JarExpander.java:79)</span><br><span class="line">2015-11-25 02:32:25 | INFO  | [main] | unzip jar /private/var/folders/xc/x0b8crk9667ddh1zhfs29_zr0000gn/T/da6d53114b1f49458c0e6329553b1ff9/stream-storm-1.0-jar-with-dependencies.jar to /private/var/folders/xc/x0b8crk9667ddh1zhfs29_zr0000gn/T/da6d53114b1f49458c0e6329553b1ff9/jartmp | com.huawei.streaming.cql.executor.mergeuserdefinds.JarExpander (JarExpander.java:91)</span><br><span class="line">2015-11-25 02:32:30 | INFO  | [main] | finished to unzip jar to dir | com.huawei.streaming.cql.executor.mergeuserdefinds.JarExpander (JarExpander.java:84)</span><br><span class="line">2015-11-25 02:32:30 | INFO  | [main] | start to copy ch | com.huawei.streaming.cql.executor.mergeuserdefinds.JarFilesMerger (JarFilesMerger.java:82)</span><br><span class="line">...</span><br><span class="line">2015-11-25 02:32:38 | INFO  | [main] | finished to package jar | com.huawei.streaming.cql.executor.mergeuserdefinds.JarPacker (JarPacker.java:68)</span><br><span class="line"></span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | ğŸ‘‰ start to generator executor application for app example | com.huawei.streaming.cql.executor.ExecutorPlanGenerator (ExecutorPlanGenerator.java:102)</span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆçš„å¯æ‰§è¡Œè®¡åˆ’ä¼š: â‘ è®¾ç½®ç³»ç»Ÿé…ç½®å‚æ•°, è§£æApplicationä¸­çš„â‘¡<code>Schema</code>å’Œâ‘¢<code>Operators</code>, æœ€ç»ˆè¿”å›çš„æ˜¯å¯æ‰§è¡Œçš„Application.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> com.huawei.streaming.application.<span class="function">Application <span class="title">generate</span><span class="params">(Application vap)</span> </span>&#123;</span><br><span class="line">    LOG.info(<span class="string">"start to generator executor application for app "</span> + vap.getApplicationId());</span><br><span class="line">    apiApplication = vap;           <span class="comment">//è¿™ä¸ªæ˜¯APIçš„Application</span></span><br><span class="line">    createEmptyApplication(vap.getApplicationId());</span><br><span class="line">    parseUserDefineds(vap);         <span class="comment">//â‘  ç”¨æˆ·è‡ªå®šä¹‰çš„å¤„ç†(ç³»ç»Ÿé…ç½®å‚æ•°)</span></span><br><span class="line">    parseSchemas();                 <span class="comment">//â‘¡ è§£ææ‰€æœ‰çš„Schemaï¼Œæ„å»ºschemaä¿¡æ¯</span></span><br><span class="line">    parseOperators();               <span class="comment">//â‘¢ è§£ææ‰€æœ‰çš„Operator,æ„å»ºOperatorInfo. æ•´ç†Operatorä¸­çš„ä¸Šä¸‹çº§å…³ç³»</span></span><br><span class="line">    <span class="keyword">return</span> executorApp;             <span class="comment">//è¿”å›çš„æ˜¯å¯æ‰§è¡Œçš„Application</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="parseSchemas:_Schema_-&gt;_TupleEventType">parseSchemas: Schema -&gt; TupleEventType</h3><p>åœ¨ç¬¬ä¸€ç¯‡ä¸­Topologyçš„CQLè¯­å¥:  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INPUT</span> STREAM s(<span class="keyword">id</span> <span class="built_in">INT</span>, <span class="keyword">name</span> <span class="keyword">STRING</span>, <span class="keyword">type</span> <span class="built_in">INT</span>) <span class="keyword">SOURCE</span> randomgen PROPERTIES ( timeUnit = <span class="string">"SECONDS"</span>, <span class="keyword">period</span> = <span class="string">"1"</span>, eventNumPerperiod = <span class="string">"1"</span>, isSchedule = <span class="string">"true"</span> );</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OUTPUT</span> STREAM rs(<span class="keyword">type</span> <span class="built_in">INT</span>, cc <span class="built_in">INT</span>) SINK consoleOutput;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> STREAM rs               <span class="comment">#INSERT STATEMENT</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">type</span>, <span class="keyword">COUNT</span>(<span class="keyword">id</span>) <span class="keyword">as</span> cc        <span class="comment">#SELECT STATEMENT      </span></span><br><span class="line"><span class="keyword">FROM</span> s[<span class="keyword">RANGE</span> <span class="number">20</span> <span class="keyword">SECONDS</span> BATCH]      <span class="comment">#FROM CLAUSE</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">id</span> &gt; <span class="number">5</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">type</span>;         <span class="comment">#WHERE CLAUSE/GROUPBY CLAUSE</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æœ‰ä¸¤ä¸ªæµ,åˆ†åˆ«æ˜¯è¾“å…¥æµs, è¾“å‡ºæµrs. å› æ­¤ä¼šå°†è¿™ä¸¤ä¸ªSchemaæ·»åŠ åˆ°å¯æ‰§è¡ŒApplicationä¸­.       </p>
<blockquote>
<p>å¯¹äºè¾“å…¥è¾“å‡ºè€Œè¨€,æœ€é‡è¦çš„å°±æ˜¯Schemaäº†, åœ¨è¾“å…¥å’Œè¾“å‡ºè¿™ä¸€å¯¹åŒèƒèƒçœ¼ä¸­,æ•°æ®è¿›æ¥å’Œå‡ºå»çš„æ ¼å¼éå¸¸é‡è¦.<br>å› ä¸ºå¤–éƒ¨æ•°æ®è¿›æ¥,å’Œæš´éœ²æ•°æ®ç»™å¤–éƒ¨,æœ€é‡è¦çš„æ˜¯æ ¼å¼. ä½ ä¸­é—´ä¸ç®¡æ€ä¹ˆå¤„ç†,å®ƒä»¬éƒ½ä¸ç®¡. Only Schema! Give Me the Data!  </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2015-11-25 02:32:39 | INFO  | [main] | AddEventType enter, the eventtypeName is:s. | com.huawei.streaming.event.EventTypeMng (EventTypeMng.java:73)</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | AddEventType enter, the eventtypeName is:rs. | com.huawei.streaming.event.EventTypeMng (EventTypeMng.java:73)</span><br></pre></td></tr></table></figure>
<p>parseSchemaToIEventä¼šå°†APIçš„Applicationä¸­æ‰€æœ‰çš„Schemaéƒ½è½¬æ¢ä¸ºIEventäº‹ä»¶:TupleEventType.<br>Schemaä¸­çš„Columnå¯¹åº”TupleEventTypeçš„Attribute. Schemaçš„streamName/idå¯¹åº”äº†ä¸‹é¢çš„name/äº‹ä»¶ç±»å‹.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TupleEventType</span> <span class="keyword">implements</span> <span class="title">IEventType</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;                                <span class="comment">//schemaName,è¡¨å</span></span><br><span class="line">    <span class="keyword">private</span> Attribute[] schema;                         <span class="comment">//schemas, æ‰€æœ‰åˆ—</span></span><br><span class="line">    <span class="keyword">private</span> String[] attNames;                          <span class="comment">//æ‰€æœ‰åˆ—çš„åˆ—å</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt; ? &gt;[] attTypes;                      <span class="comment">//æ‰€æœ‰åˆ—çš„åˆ—ç±»å‹</span></span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String, Integer&gt; attid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Schemaçš„ç®¡ç†ç±»ç”¨Mapç»“æ„ä¿å­˜schemaName/eventTypeNameå’Œå¯¹åº”çš„Schema/TupleEventType: è¡¨å-&gt;è¡¨ç»“æ„.   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventTypeMng</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, IEventType&gt; schemas;            <span class="comment">//MAP: æ•°æ®ç±»å‹åç§° =&gt; å…·ä½“æ•°æ®ç±»å‹</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addEventType</span><span class="params">(IEventType schema)</span> </span>&#123;       <span class="comment">//â¬…ï¸ executorApp.addEventSchema(tupleEventType)</span></span><br><span class="line">        schemas.put(schema.getEventTypeName(), schema); <span class="comment">//æ•°æ®ç±»å‹|äº‹ä»¶ç±»å‹|è¡¨åschemaName|streamNameæµåç§°</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="parseOperators:_ç®—å­è§£æ">parseOperators: ç®—å­è§£æ</h3><blockquote>
<p>å‰é¢ç¬¬ä¸€ç¯‡çš„æ—¶å€™submitä¹‹å‰æ¯æ¡CQLè¯­å¥éƒ½æœ‰start to parse cqlè¿‡ä¸€æ¬¡äº†,è¿™é‡Œä¸ºä»€ä¹ˆè¿˜ä¼šå†æ¬¡parse?<br>ç­”: å‰é¢åªæ˜¯LazyTaskæ‡’è§£æ,å…¶å®è¿˜æ˜¯æ²¡æœ‰å¼€å§‹çš„. é‚£ä¸ºä»€ä¹ˆè¦åœ¨è¿™é‡Œæ‰å¼€å§‹? å› ä¸ºè§£æå®Œschemaå, å°±è¯¥è½®åˆ°operatorçš„è§£æäº†.<br>ä¸è¿‡æœ‰ä¸€ç‚¹ä¸åŒçš„æ˜¯, æœ€å¼€å§‹çš„parseæ˜¯å¯¹æ•´ä¸ªCQLè¯­å¥, è¿™é‡Œåªè§£æäº†éƒ¨åˆ†, æ¯”å¦‚è¡¨è¾¾å¼,groupby,èšåˆ.  <code>WHYYY?</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">è§£æç®—å­: 1)è§£æäºŒå…ƒè¡¨è¾¾å¼(å±æ€§å€¼è¡¨è¾¾å¼) id &gt; 5</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | start to parse cql : (s.id &gt; 5) | com.huawei.streaming.cql.semanticanalyzer.parser.ApplicationParser (ApplicationParser.java:44)</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | Parse Completed | com.huawei.streaming.cql.semanticanalyzer.parser.ApplicationParser (ApplicationParser.java:69)</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | start to create binary Expressions. | com.huawei.streaming.cql.executor.expressioncreater.PropertyValueExpressionCreator (BinaryExpressionCreator.java:54)  â¬…ï¸</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | Parse Completed, cql : s.type,  count( s.id )  | com.huawei.streaming.cql.semanticanalyzer.parser.SelectClauseParser (SelectClauseParser.java:68)</span><br><span class="line"></span><br><span class="line">2)è§£æ group by</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | start to parse cql : s.type | com.huawei.streaming.cql.semanticanalyzer.parser.GroupbyClauseParser (GroupbyClauseParser.java:45)   â¬…ï¸</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | Parse Completed | com.huawei.streaming.cql.semanticanalyzer.parser.GroupbyClauseParser (GroupbyClauseParser.java:68)</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | start to parse cql : s.type | com.huawei.streaming.cql.semanticanalyzer.parser.GroupbyClauseParser (GroupbyClauseParser.java:45)</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | Parse Completed | com.huawei.streaming.cql.semanticanalyzer.parser.GroupbyClauseParser (GroupbyClauseParser.java:68)</span><br><span class="line"></span><br><span class="line">3)èšåˆç®—å­ count(id)</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | start to create aggregate service | com.huawei.streaming.cql.executor.operatorviewscreater.AggregateServiceViewCreator (AggregateServiceViewCreator.java:89)  â¬…ï¸</span><br></pre></td></tr></table></figure>
<p>ä¸ä»…ä»…æ˜¯Driver.runè°ƒç”¨äº†ApplicationParser.parse. ä»è°ƒç”¨æ ‘è¿˜èƒ½çœ‹åˆ°æœ‰XXXInfoCreator,ViewCreator.(<code>è¿˜è®°å¾—èšåˆä¹Ÿæ˜¯ä¸€ç§æŸ¥è¯¢å—</code>)</p>
<p><img src="https://images.weserv.nl/?url=http://img.blog.csdn.net/20151130172800418" alt="stream-opinfo"></p>
<p>ç®—å­è§£æ: è¿™é‡Œçš„è§£ææ˜¯ä¸ºäº†ä½¿å¾—è¾“å…¥å’Œè¾“å‡ºç®—å­ç»Ÿä¸€ï¼Œé¿å…ç”¨æˆ·è‡ªå®šä¹‰å’Œç³»ç»Ÿå†…ç½®çš„ç®—å­å¯¹å¤–è¡¨ç°ä¸ä¸€è‡´å¤„ç†èµ·æ¥çš„éº»çƒ¦<br>ç”±äºè¾“å…¥å’Œè¾“å‡ºç®—å­ä¸­å­˜åœ¨ç‰¹ä¾‹ï¼Œå³é’ˆå¯¹æ–‡ä»¶ï¼Œtcpï¼Œkafkaç­‰ç¼–å†™äº†ç‰¹ä¾‹, æ‰€ä»¥éœ€è¦â‘ é¦–å…ˆå°†ä»–ä»¬æŠ½è±¡åŒ–ï¼Œä¹‹åå†æ¥å¤„ç†  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseOperators</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Map&lt;String, Operator&gt; opts = formatOperators();                     <span class="comment">//â‘  è¾“å…¥è¾“å‡ºç®—å­æŠ½è±¡åŒ–</span></span><br><span class="line">    Map&lt;String, AbsOperator&gt; opMappings = createOperatorInfos(opts);    <span class="comment">//â‘¡ ç®—å­è§£æ â¬…ï¸  Operator -&gt; AbsOperator</span></span><br><span class="line">    combineOperators(opMappings);                                       <span class="comment">//â‘¢ æ•´ç†ç®—å­é¡ºåº</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;String, AbsOperator&gt; et : opMappings.entrySet())&#123;        <span class="comment">//â‘£ æ·»åŠ ç®—å­åˆ°Application</span></span><br><span class="line">        IRichOperator operator = et.getValue();</span><br><span class="line">        <span class="comment">//å¦‚æœæ²¡æœ‰è¾“å…¥ï¼Œä¹Ÿç®—æ˜¯input</span></span><br><span class="line">        <span class="keyword">if</span> (operator <span class="keyword">instanceof</span> InputOperator)&#123;</span><br><span class="line">            executorApp.addInputStream(operator);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœæ²¡æœ‰è¾“å‡ºï¼Œä¹Ÿç®—æ˜¯output</span></span><br><span class="line">        <span class="keyword">if</span> (operator <span class="keyword">instanceof</span> OutputOperator)&#123;</span><br><span class="line">            executorApp.addOutputStream(operator);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä¸æ˜¯è¾“å…¥è¾“å‡º,å°±æ˜¯åŠŸèƒ½ç®—å­</span></span><br><span class="line">        executorApp.addFunctionStream(operator);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>â‘¡ Operatoræ˜¯ç®—å­, AbsOperatoråˆ™æ˜¯æµå¤„ç†ç®—å­(ç»§æ‰¿IRichOperator).å®ƒä»¬çš„è½¬æ¢ç”±createOperatorInfos-&gt;OperatorInfoCreatorFactoryå®Œæˆ.<br>â‘£ å’ŒSchemaçš„ç®¡ç†ä¸€æ ·,ç®—å­çš„ç®¡ç†ç±»OperatorMngç”¨ä¸‰ä¸ªMapåˆ†åˆ«ç®¡ç†è¾“å…¥,è¾“å‡º,åŠŸèƒ½ç®—å­. Mapçš„keyæ˜¯operatorId,valueæ˜¯Operatorç®—å­æœ¬èº«.   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OperatorMng</span></span>&#123;    </span><br><span class="line">    <span class="keyword">private</span> List&lt;IRichOperator&gt; sortedFunctions;        <span class="comment">//DFGæ’åºåçš„åŠŸèƒ½ç®—å­åˆ—è¡¨ï¼Œä½œä¸ºåˆ›å»ºStormæ‹“æ‰‘é¡ºåºçš„åŸºç¡€(è¾“å‡ºå’ŒåŠŸèƒ½ç®—å­ç»„æˆ--&gt;Bolt)</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, IRichOperator&gt; inputs;          <span class="comment">//è¾“å…¥ç®—å­ --&gt; Spout</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, IRichOperator&gt; functions;       <span class="comment">//åŠŸèƒ½ç®—å­ --&gt; Bolt</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, IRichOperator&gt; outputs;         <span class="comment">//è¾“å‡ºç®—å­ --&gt; Bolt</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸Šé¢parseOperatorsçš„ä¸¤ä¸ªMap:optså’ŒopMappingä»¥åŠOperatorMngçš„ä¸‰ä¸ªMapçš„Key,Valueéƒ½æ˜¯operatorID-&gt;AbsOperatorå®ä¾‹.  </p>
</blockquote>
<h4 id="createOperatorInfos">createOperatorInfos</h4><p>operatorsæ˜¯APIä¸­çš„ç®—å­, è¦è½¬æ¢ä¸ºå¯æ‰§è¡Œè®¡åˆ’å¯¹åº”çš„ç®—å­, é€šè¿‡OperatorInfoCreatorFactoryå·¥å‚ç±»æ ¹æ®operatorä¸Šçš„æ³¨è§£<br>å…ˆå–å¾—OperatorInfoCreatorçš„å…·ä½“å®ç°ç±»,å†è°ƒç”¨createInstance, åœ¨å…·ä½“çš„OperatorInfoCreatorå®ç°ç±»ä¸­æ‰å®Œæˆè½¬æ¢.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, AbsOperator&gt; <span class="title">createOperatorInfos</span><span class="params">(Map&lt;String, Operator&gt; operators)</span> </span>&#123;</span><br><span class="line">    Map&lt;String, AbsOperator&gt; opMappings = Maps.newHashMap();</span><br><span class="line">    <span class="keyword">for</span> (Operator op : operators.values()) &#123;</span><br><span class="line">        AbsOperator opinfo = createOperatorInfo(op);</span><br><span class="line">        opMappings.put(opinfo.getOperatorId(), opinfo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> opMappings;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> AbsOperator <span class="title">createOperatorInfo</span><span class="params">(Operator operator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> OperatorInfoCreatorFactory.createOperatorInfo(apiApplication, operator, executorApp.getStreamSchema(), <span class="keyword">this</span>.systemConfig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‡è®¾Operatoræ˜¯AggregateOperator,å®ƒçš„æ³¨è§£æ˜¯AggregaterInfoCreator.æ‰€ä»¥æœ€ç»ˆè°ƒç”¨çš„æ˜¯AggregaterInfoCreator.createInstanceåˆ›å»ºAggFunctionOp.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@OperatorInfoCreatorAnnotation(AggregaterInfoCreator.class)</span><br><span class="line">public class AggregateOperator extends BasicAggFunctionOperator</span><br></pre></td></tr></table></figure>
<p>æ¥å£OperatorInfoCreatoråˆ›å»ºæ¯ä¸ªç®—å­çš„å®ä¾‹, createInstanceå‚æ•°åˆ†åˆ«æ˜¯: æ‰§è¡Œè®¡åˆ’ä¿¡æ¯,xmlæ‰§è¡Œè®¡åˆ’ä¸­çš„ç®—å­ä¿¡æ¯(å“ªé‡Œçš„xml?),schemaä¿¡æ¯,ç³»ç»Ÿé…ç½®ä¿¡æ¯.<br>ä¸‹å›¾æ˜¯OperatorInfoCreatorçš„å®ç°ç±», åˆ›å»ºçš„ç®—å­å®ä¾‹é™¤äº†FunctionOperator,è¿˜æœ‰InputOperator,OutputOperator,FunctionStreamOperator.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">OperatorInfoCreator (c.h.s.c.e.operatorinfocreater)     åˆ›å»ºçš„ç®—å­å®ä¾‹               çˆ¶ç±»</span><br><span class="line">    |-- AggregaterInfoCreator                           AggFunctionOp           &gt;&gt; FunctionOperator</span><br><span class="line">    |-- DataSourceInfoOperatorCreator                   FunctionOperator        -- FunctionOperator</span><br><span class="line">    |-- FunctorInfoCreator                              FunctorOp               &gt;&gt; FunctionOperator</span><br><span class="line">    |-- FilterInfoCreator                               FilterFunctionOp        &gt;&gt; FunctionOperator     </span><br><span class="line">    |-- InputInfoCreator                                                           InputOperator</span><br><span class="line">    |-- UnionInfoCreator                                UnionFunctionOp         &gt;&gt; FunctionOperator</span><br><span class="line">    |-- OutputInfoCreator                                                          OutputOperator</span><br><span class="line">    |-- SplitterInfoCreator                             SplitOp                 &gt;&gt; FunctionOperator</span><br><span class="line">    |-- JoinInfoOperatorCreator                         JoinFunctionOp          &gt;&gt; FunctionOperator</span><br><span class="line">    |-- FunctionStreamInfoCreator                                                  FunctionStreamOperator</span><br></pre></td></tr></table></figure>
<p>ä»¥AggregaterInfoCreatorå°†<code>AggregateOperator</code>è½¬æ¢ä¸º<code>AggFunctionOp</code>ä¸ºä¾‹: ç”±äºAggregateOperatoræœ¬èº«åŒ…å«äº†Windowå¯¹è±¡<br>ä»¥åŠfilterBeforeAggregate,filterAfterAggregateç­‰å­—ç¬¦ä¸², æ‰€ä»¥æ ¹æ®è¿™äº›æ•°æ®æ„é€ ç›¸åº”çš„å¯¹è±¡,å¹¶æœ€ç»ˆæ„é€ å‡ºAggFunctionOp.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AbsOperator <span class="title">createInstance</span><span class="params">(Application vapp, Operator operator, EventTypeMng streamschema, Map&lt;String, String&gt; systemConfig)</span> </span>&#123;</span><br><span class="line">    LOG.debug(<span class="string">"start to create aggregate operator"</span>);        <span class="comment">//LOG</span></span><br><span class="line">    prepare(vapp, operator, systemConfig);</span><br><span class="line">    <span class="comment">//çª—å£,è¿‡æ»¤,è¡¨è¾¾å¼     </span></span><br><span class="line">    WindowViewCreator creater = <span class="keyword">new</span> WindowViewCreator();</span><br><span class="line">    IWindow window = creater.create(inputSchemas, aggOperator.getWindow(), <span class="keyword">this</span>.applicationConfig);</span><br><span class="line">    FilterView filterView = createFilterView();</span><br><span class="line">    IExpression bexpr = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (filterView != <span class="keyword">null</span>) bexpr = filterView.getBoolexpr();</span><br><span class="line">    <span class="comment">//èšåˆç»“æœåˆå¹¶     </span></span><br><span class="line">    AggResultSetParameters pars = createResultSetMergeParmeters(streamschema, window, bexpr);</span><br><span class="line">    IAggResultSetMerge resultSetMerge = <span class="keyword">new</span> AggResultSetMergeViewCreator(pars).create();        <span class="comment">// â¬…ï¸ </span></span><br><span class="line">    <span class="comment">//èšåˆç®—å­</span></span><br><span class="line">    AggFunctionOp aggFunctionOp = <span class="keyword">new</span> AggFunctionOp(window, filterView, resultSetMerge, OutputTypeAnalyzer.createOutputType(aggOperator.getWindow()));</span><br><span class="line">    <span class="comment">//ç³»ç»Ÿå‚æ•°</span></span><br><span class="line">    StreamingConfig config = <span class="keyword">new</span> StreamingConfig();</span><br><span class="line">    <span class="keyword">if</span> (operator.getArgs() != <span class="keyword">null</span>) config.putAll(operator.getArgs());</span><br><span class="line">    config.putAll(<span class="keyword">this</span>.applicationConfig);</span><br><span class="line">    aggFunctionOp.setConfig(config);</span><br><span class="line">    <span class="comment">//è®¾ç½®å¹¶è¡Œåº¦å’ŒID,å®Œæˆæµç®—å­çš„æ„å»º</span></span><br><span class="line">    <span class="keyword">return</span> OperatorInfoCreatorFactory.buildStreamOperator(operator, aggFunctionOp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ç”ŸæˆAggFunctionOpåŠ¨ç”¨äº†WindowViewCreatoråˆ›å»ºWindow,FilterView,AggResultSetMergeViewCreatoråˆ›å»ºIAggResultSetMerge. æœ€åç»„è£…æˆAggFunctionOp.   </p>
<blockquote>
<p>ä¸Šä¸€ç« AggregateSplitteræ‹†åˆ†ç®—å­çš„æ—¶å€™è§£æFromå­å¥æ—¶å°±åˆ›å»ºäº†FilterBeforeWindowçš„FilterOperatorå’ŒAggregateOperator,<br>è¿™é‡Œä¹Ÿæœ‰Windowå’ŒFilter,ä¸è¿‡æ˜¯FilterBeforeAggregate. è¿™ä¸¤ä¸ªå¯¹è±¡åˆ†åˆ«å¯¹åº”äº†AggregateOperatorçš„Windowå¯¹è±¡å’ŒfilterBeforeAggregateå­—ç¬¦ä¸².<br>è¿™æ˜¯å› ä¸ºæ‹†åˆ†ç®—å­çš„æ—¶å€™åˆ›å»ºçš„FilterOperatoræ˜¯FilterBeforeWindow, åˆ›å»ºçš„AggregateOperatoræœ¬èº«åŒ…å«äº†FilterBeforeAggregateå’ŒWindow.   </p>
</blockquote>
<blockquote>
<p>IAggResultSetMergeè¡¨ç¤ºèšåˆç»“æœåˆå¹¶. å°†IAggResultSetMergeè®¾ç½®ç»™AggFunctionOp, åé¢åˆå§‹åŒ–Opçš„æ—¶å€™ä¼šç”¨åˆ°è¿™ä¸ªå¯¹è±¡æ¥åˆ›å»ºå¤„ç†è§†å›¾.<br>A.ç»“åˆå‰é¢çš„ä»£ç é˜…è¯»ä½“éªŒ, æ¯”å¦‚ç¬¬ä¸€ç« åˆ›å»ºå®ŒTaskå’ŒSemanticAnalyzeréƒ½ä¼šåˆå§‹åŒ–.è¿™é‡Œåˆ›å»ºå®ŒOpä¹Ÿä¼šåˆå§‹åŒ–æµè®¡ç®—ç®—å­.<br>B.å®é™…ä¸Šå¯¹è±¡åˆ›å»ºå®Œä¸å°±æ˜¯è¢«ä½¿ç”¨å˜›! å¦‚æœæœ‰ä¾èµ–çš„å¯¹è±¡,å¯ä»¥è®¾ç½®åˆ°æ„é€ å‡½æ•°ä¸­,åœ¨å®é™…ä½¿ç”¨å¯¹è±¡çš„æ—¶å€™è·å–ä¾èµ–å¯¹è±¡è¿›è¡Œå¿…è¦è®¡ç®—,å……åˆ†ä½“ç°JAVAçš„é¢å‘å¯¹è±¡æ€æƒ³.<br>C.æ•°æ®çš„ä¼ é€’:ä»è¯­æ³•è§£æç»“æœåˆ°è¯­ä¹‰è§£æç»“æœåˆ°æ‹†åˆ†çš„ç®—å­å†åˆ°è¿™é‡Œçš„æµè®¡ç®—ç®—å­. æ•°æ®éƒ½æ˜¯å±‚å±‚ä¼ é€’å¹¶ä¸æ–­æ›´æ–°æˆ–æ·»åŠ æ–°çš„æ•°æ®ç»“æ„æ»¡è¶³ä¸åŒé˜¶æ®µçš„å¯¹è±¡æ„å»º.     </p>
</blockquote>
<blockquote>
<p>é‚£ä¹ˆè¯è¯´AbsOperatoræ¯”å¦‚AggFunctionOpæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–çš„? ç­”æ¡ˆæ˜¯: åœ¨StormSpout/StormBoltçš„prepareä¸­åˆå§‹åŒ–.  </p>
</blockquote>
<h4 id="combineOperators">combineOperators</h4><p>ä¸Šä¸€ç¯‡é‡ç‚¹ä»‹ç»äº†æ‹†åˆ†ç®—å­SplitContext(Operator)å’Œç»„åˆç®—å­OperatorCombiner(è¿çº¿). è¿™é‡Œä¹Ÿä¸ä¾‹å¤–,åœ¨åˆ›å»ºå®Œå…·ä½“çš„AbsOperatorç®—å­å,ä¹Ÿéœ€è¦ç»„åˆ.<br>è¿™é‡Œçš„ç»„åˆä¸å†éœ€è¦åˆ›å»ºTransitionäº†. å› ä¸ºOperatorTransitionæ˜¯é’ˆå¯¹Operator. è€ŒAbsOperatoræ˜¯æ²¡æœ‰Transitionçš„.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">combineOperators</span><span class="params">(Map&lt;String, AbsOperator&gt; operatorInfos)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//ç®—å­ä¹‹é—´çš„è¿æ¥, è·å–ç®—å­é€šè¿‡apiApplication.getOperators(), è·å–è¿çº¿ä¹Ÿæ˜¯é€šè¿‡apiApplication</span></span><br><span class="line">    <span class="keyword">for</span> (OperatorTransition ot : apiApplication.getOpTransition()) &#123;</span><br><span class="line">        <span class="comment">//è·å–è¿æ¥çš„å…¥å£å’Œå‡ºå£ç®—å­</span></span><br><span class="line">        String fromOpId = ot.getFromOperatorId();</span><br><span class="line">        String toOpId = ot.getToOperatorId();</span><br><span class="line">        String streamName = ot.getStreamName();</span><br><span class="line">        DistributeType distributedType = ot.getDistributedType();</span><br><span class="line">        String distributedFields = ot.getDistributedFields();</span><br><span class="line">        <span class="comment">//è¿æ¥çš„Schema, å¯¹äºFromå’ŒToéƒ½æ˜¯ä½¿ç”¨ç›¸åŒçš„Schema</span></span><br><span class="line">        String outputSchemaName = ot.getSchemaName();</span><br><span class="line">        distributedFields = ExecutorUtils.removeStreamName(distributedFields);            </span><br><span class="line">        TupleEventType outputSchema = (TupleEventType)(executorApp.getEventType(outputSchemaName));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//operatorInfosæ˜¯æ‰€æœ‰çš„ç®—å­é›†åˆ, æ ¹æ®ä¼ å…¥çš„fromOpIdæˆ–è€…toOpId,ä»é›†åˆä¸­æ‰¾å‡ºå¯¹åº”çš„ç®—å­</span></span><br><span class="line">        combineFromTransition(operatorInfos, fromOpId, streamName, outputSchema);</span><br><span class="line">        combineToTransition(operatorInfos, toOpId, streamName, distributedType, distributedFields, outputSchema);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FromTransition: è¿çº¿çš„fromç®—å­çš„è¾“å‡ºæ˜¯outputSchema<br>ToTransition: è¿çº¿çš„toç®—å­çš„è¾“å…¥æ˜¯outputSchema. <code>è¿™é‡ŒoutputSchemaå‘½åä¸ºschemaä¼¼ä¹æ›´å¥½</code>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">combineFromTransition</span><span class="params">(Map&lt;String, AbsOperator&gt; operatorInfos, String fromOpId, String streamName, TupleEventType outputSchema)</span></span>&#123;</span><br><span class="line">    AbsOperator sopInfo = operatorInfos.get(fromOpId);</span><br><span class="line">    StreamingConfig sConfig = sopInfo.getConfig();</span><br><span class="line">    sConfig = (sConfig == <span class="keyword">null</span> ? <span class="keyword">new</span> StreamingConfig() : sConfig);</span><br><span class="line">    sConfig.put(StreamingConfig.STREAMING_INNER_OUTPUT_SCHEMA, outputSchema);</span><br><span class="line">    sConfig.put(StreamingConfig.STREAMING_INNER_OUTPUT_STREAM_NAME, streamName);</span><br><span class="line">    sopInfo.setConfig(sConfig);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">combineToTransition</span><span class="params">(Map&lt;String, AbsOperator&gt; operatorInfos, String toOpId, String streamName,</span></span></span><br><span class="line"><span class="function"><span class="params">    DistributeType distributedType, String distributedFields, TupleEventType outputSchema)</span> </span>&#123;</span><br><span class="line">    AbsOperator fopInfo = operatorInfos.get(toOpId);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(distributedFields)) &#123;</span><br><span class="line">        fopInfo.setGroupInfo(streamName, distributedType, distributedFields.split(<span class="string">","</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fopInfo.setGroupInfo(streamName, distributedType, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    StreamingConfig sConfig = fopInfo.getConfig();</span><br><span class="line">    sConfig = (sConfig == <span class="keyword">null</span> ? <span class="keyword">new</span> StreamingConfig() : sConfig);</span><br><span class="line">    sConfig.put(StreamingConfig.STREAMING_INNER_INPUT_STREAM_NAME, streamName);</span><br><span class="line">    sConfig.put(StreamingConfig.STREAMING_INNER_INPUT_SCHEMA, outputSchema);</span><br><span class="line">    fopInfo.setConfig(sConfig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç±»ä¼¼äºGraphä¸­çš„é¡¶ç‚¹A -&gt; è¾¹ -&gt; é¡¶ç‚¹B. Transitionå°±ç±»ä¼¼äºè¾¹, è¿æ¥ç€å·¦å³ä¸¤è¾¹çš„ç®—å­, åˆ†åˆ«æ˜¯Fromç®—å­å’ŒToç®—å­.  </p>
<h2 id="StormApplication">StormApplication</h2><p>SubmitTask.submitApplication -&gt; PhysicalPlanExecutor.execute -&gt; PhysicalPlanExecutor.submit(application.Application) -&gt;<br>StormApplication.launch -&gt; createTopology åˆ›å»ºæ‹“æ‰‘, å¯¹äºStormçš„ç¨‹åºè€Œè¨€, æ„æˆæ‹“æ‰‘çš„ç»„ä»¶åŒ…æ‹¬Spoutså’ŒBolts.<br>è¿™äº›æ•°æ®éƒ½æ¥è‡ªäºApplicationçš„è¾“å…¥,è¾“å‡ºå’ŒåŠŸèƒ½ç®—å­. ç”±äºStormåªæœ‰ä¸¤ç§ç»„ä»¶Spoutå’ŒBolt, æ‰€ä»¥è¾“å…¥ç®—å­å½’äºSpout,è¾“å‡ºå’ŒåŠŸèƒ½ç®—å­éƒ½å±äºBolt.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createSpouts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt; ? extends IRichOperator&gt; sources = getInputStreams(); <span class="comment">//è·å¾—æ‰€æœ‰æºç®—å­ä¿¡æ¯: OperatorMng.inputs â¬…ï¸</span></span><br><span class="line">    checkInputStreams(sources);</span><br><span class="line">    <span class="keyword">for</span> (IRichOperator input : sources) &#123;</span><br><span class="line">        StormSpout spout = <span class="keyword">new</span> StormSpout();                    <span class="comment">//å°†ç®—å­è®¾ç½®åˆ°ä¸ºStormSpoutä¸­</span></span><br><span class="line">        spout.setOperator(input);                               <span class="comment">//Spoutæ¥æ”¶æ•°æ®æ—¶,å°†ä½¿ç”¨è®¾ç½®çš„ç®—å­å¼€å§‹å¤„ç†</span></span><br><span class="line">        builder.setSpout(input.getOperatorId(), spout, input.getParallelNumber());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createBolts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;IRichOperator&gt; orderedFunOp = genFunctionOpsOrder();   <span class="comment">//è·å–å·²ç»æ’å¥½åºçš„åŠŸèƒ½ç®—å­,åŒ…å«outputç®—å­  â¬…ï¸</span></span><br><span class="line">    <span class="keyword">for</span> (IRichOperator operator : orderedFunOp) &#123;</span><br><span class="line">        setOperatorGrouping(operator);                          <span class="comment">//è®¾ç½®Boltçš„åˆ†ç»„ç­–ç•¥  â¬…ï¸</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å“ªäº›Operatorç®—å­ä¼šä½œä¸ºBolt, OutpoutBolt, Spoutéƒ½æ˜¯ç”±OperatorMngç®¡ç†çš„æ¯”å¦‚getInputStreams,genFunctionOpsOrder<br>è¿™æ ·åˆ›å»ºçš„Boltä¼šç›´æ¥ä¾èµ–äºå¯¹åº”çš„Operator, åœ¨å¤„ç†Boltæ—¶,å°±ä¸éœ€è¦å†åˆ¤æ–­æ˜¯å“ªä¸€ç§ç±»å‹çš„Operatoräº†.<br>æ‰€ä»¥æ­£æ˜¯ç”±äºå¯¹ç®—å­çš„ç§ç±»è¿›è¡Œäº†åˆ†ç¦»(è¾“å…¥,è¾“å‡º,åŠŸèƒ½)æ‰ä½¿å¾—å¤„ç†Stormçš„componentæ—¶å˜å¾—å®¹æ˜“.<br>ä¸€æ—¦æ ¹æ®ç®—å­åˆ›å»ºå¹¶ç»„ç»‡å®Œæ„æˆTopologyçš„Spoutså’ŒBolts, å°±å¯ä»¥æäº¤æ‹“æ‰‘ç»™Stormé›†ç¾¤æ‰§è¡Œäº†. DONEğŸ˜„  </p>
</blockquote>
<h3 id="Bolt_Grouping">Bolt Grouping</h3><p>åœ¨å¼€å‘Stormåº”ç”¨ç¨‹åºæ—¶, ä¸€èˆ¬æ˜¯åœ¨Stormçš„Topologyä»£ç ä¸­åˆ›å»ºBoltå¹¶ç›´æ¥è®¾ç½®Boltçš„åˆ†ç»„ç­–ç•¥.<br>å‡è®¾æœ‰è¿™æ ·çš„Topology, Bolt1è¾“å‡ºåˆ°Bolt3å’ŒBolt4, Bolt2è¾“å‡ºåˆ°Bolt3(ä¸€ä¸ªBoltå¯ä»¥æœ‰å¤šä¸ªè¾“å‡º,ä¹Ÿå¯ä»¥ç”±å¤šä¸ªè¾“å…¥).    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">             |------ |Bolt4|</span><br><span class="line">|Bolt1| -----|</span><br><span class="line">             |------ |Bolt3|</span><br><span class="line">|Bolt2| -----|</span><br><span class="line"></span><br><span class="line"><span class="comment">//Bolt1æœ‰ä¸¤ä¸ªè¾“å‡ºæµ, è¾“å‡ºå­—æ®µéƒ½æ˜¯ä¸€æ ·çš„, ä¸¤ä¸ªè¾“å‡ºæµçš„åç§°stream-idä¸ä¸€æ ·</span></span><br><span class="line">builder.setBolt(<span class="string">"bolt1"</span>, <span class="keyword">new</span> Bolt1(), <span class="number">2</span>)        </span><br><span class="line">            declarer.declareStream(<span class="string">"streamA"</span>, <span class="keyword">new</span> Fields(<span class="string">"f1"</span>,<span class="string">"f2"</span>))</span><br><span class="line">            declarer.declareStream(<span class="string">"streamB"</span>, <span class="keyword">new</span> Fields(<span class="string">"f1"</span>,<span class="string">"f2"</span>))</span><br><span class="line"><span class="comment">//Bolt2åªæœ‰ä¸€ä¸ªè¾“å‡ºæµ</span></span><br><span class="line">builder.setBolt(<span class="string">"bolt2"</span>, <span class="keyword">new</span> Bolt2(), <span class="number">2</span>)</span><br><span class="line">            declarer.declareStream(<span class="string">"streamC"</span>, <span class="keyword">new</span> Fields(<span class="string">"f1"</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//Bolt3æ¥æ”¶Bolt1çš„streamAæµä½¿ç”¨å­—æ®µåˆ†ç»„, æ¥æ”¶Bolt2çš„streamCæµä½¿ç”¨shuffleåˆ†ç»„</span></span><br><span class="line">builder.setBolt(<span class="string">"bolt3"</span>, <span class="keyword">new</span> Bolt3(), <span class="number">4</span>)</span><br><span class="line">        .fieldsGrouping(<span class="string">"bolt1"</span>, <span class="string">"streamA"</span>, <span class="keyword">new</span> Field(<span class="string">"f1"</span>))</span><br><span class="line">        .shuffleGrouping(<span class="string">"bolt2"</span>, <span class="string">"streamC"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//Bolt4æ¥æ”¶Bolt1çš„streamBæµä½¿ç”¨å­—æ®µåˆ†ç»„, åˆ†ç»„å­—æ®µæ˜¯Bolt1äº§ç”Ÿçš„f2å­—æ®µ.  </span></span><br><span class="line">builder.setBolt(<span class="string">"bolt4"</span>, <span class="keyword">new</span> Bolt4(), <span class="number">3</span>)</span><br><span class="line">        .fieldsGrouping(<span class="string">"bolt1"</span>, <span class="string">"streamB"</span>, , <span class="keyword">new</span> Field(<span class="string">"f2"</span>))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>setBoltæ—¶è®¾ç½®çš„componentId/operatorIdéƒ½æ˜¯è‡ªå·±Bolt, åˆ†ç»„æ—¶çš„componentIdåˆ™æ˜¯è¾“å…¥çš„componentId/operatorId.  </p>
</blockquote>
<p>é€šè¿‡è§£æCQLçš„åˆ†ç»„ä»¥åŠç®—å­/ç»„ä»¶ä¹‹é—´çš„è¿æ¥, ç°åœ¨å°±ä¸éœ€è¦åœ¨Topologyå†™æ­»äº†. å› æ­¤éœ€è¦æ¡†æ¶èƒ½å¤ŸåŠ¨æ€åœ°æ„å»ºTopology.  </p>
<blockquote>
<p>ä¸ºä»€ä¹ˆIRichOperatorçš„getInputStream()å’ŒgetOutputStream()è¡¨ç¤ºçš„æ˜¯è¾“å…¥æµå’Œè¾“å‡ºæµçš„åç§°, è€Œä¸æ˜¯è¾“å…¥æµå¯¹è±¡å’Œè¾“å‡ºæµå¯¹è±¡(æ¯”å¦‚ç®—å­æœ¬èº«).<br>è¿™æ˜¯å› ä¸ºOperatorç®—å­ä¼šç”¨äºTopologyçš„Spout/Bolt, åˆ›å»ºå®ŒSpout/Boltä¹‹å, ç”¨äºæ„å»ºTopologyå…¶ä»–å¿…è¦çš„ä¿¡æ¯é™¤äº†åˆ†ç»„å¤–,<br>è¿˜æœ‰Stormçš„component-idå¯¹åº”ç®—å­çš„id å’Œ Stormçš„stream-idå¯¹åº”ç®—å­çš„è¾“å…¥/è¾“å‡ºæµåç§°  </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setOperatorGrouping</span><span class="params">(IRichOperator operator)</span> </span>&#123;</span><br><span class="line">    BoltDeclarer bolt = createBoltDeclarer(operator);</span><br><span class="line">    <span class="comment">//ä¸€ä¸ªBoltå¯èƒ½æœ‰å¤šä¸ªè¾“å…¥å³å¤šä¸ªInputStream, åŒæ—¶è¾“å‡ºä¹Ÿå¯èƒ½æœ‰å¤šä¸ª: è®¾ç½®ä¸åŒçš„Groupingç­–ç•¥</span></span><br><span class="line">    <span class="comment">//æ³¨æ„: Boltè®¾ç½®åˆ†ç»„æ—¶çš„componentIdæ˜¯å…¶è¾“å…¥æºçš„ComponentId,è€Œä¸æ˜¯è‡ªå·±çš„componentId, è‡ªå·±æ˜¯åœ¨builder.setBoltæ—¶è®¾ç½®çš„</span></span><br><span class="line">    <span class="keyword">for</span> (String strname : operator.getInputStream()) &#123;              <span class="comment">//strnameæ˜¯å½“å‰ç®—å­çš„è¾“å…¥æµåç§°</span></span><br><span class="line">        GroupInfo groupInfo = operator.getGroupInfo().get(strname); <span class="comment">//ç®—å­çš„åˆ†ç»„ä¿¡æ¯</span></span><br><span class="line">        setBoltGrouping(bolt, strname, groupInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setBoltGrouping</span><span class="params">(BoltDeclarer bolt, String strname, GroupInfo groupInfo)</span> </span>&#123;        </span><br><span class="line">    DistributeType distribute = groupInfo.getDitributeType();</span><br><span class="line">    <span class="keyword">switch</span> (distribute) &#123;</span><br><span class="line">        <span class="keyword">case</span> FIELDS:</span><br><span class="line">            Fields fields = <span class="keyword">new</span> Fields(groupInfo.getFields());</span><br><span class="line">            <span class="comment">//æ ¹æ®è¾“å…¥æµçš„åç§°, è·å–è¿™ä¸ªè¾“å…¥æµæ˜¯ä¸ªä»€ä¹ˆç®—å­, ä¸ºçš„æ˜¯è·å¾—è¿™ä¸ªè¾“å…¥ç®—å­çš„operatorId,ä½œä¸ºåˆ†ç»„ç­–ç•¥çš„ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">            IRichOperator operator = getOperatorByOutputStreamName(strname);</span><br><span class="line">            <span class="comment">//å­—æ®µåˆ†ç»„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«è¡¨ç¤º: componentId, streamId, fields. è¿™é‡Œçš„componentIdè¡¨ç¤ºä»å“ªä¸ªæ•°æ®æºæ¥å…¥æ•°æ®,è€Œä¸æ˜¯å½“å‰ç®—å­çš„operatorId</span></span><br><span class="line">            bolt.fieldsGrouping(operator.getOperatorId(), strname, fields);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">//... å…¶ä»–åˆ†ç»„ç±»å‹ ...   </span></span><br><span class="line">        <span class="keyword">default</span>:               </span><br><span class="line">            setDefaultBoltGrouping(bolt, strname);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setDefaultBoltGrouping</span><span class="params">(BoltDeclarer bolt, String strname)</span> </span>&#123;</span><br><span class="line">    IRichOperator operator = getOperatorByOutputStreamName(strname);</span><br><span class="line">    <span class="comment">//shuffleåˆ†ç»„ä¸¤ä¸ªå‚æ•°åˆ†åˆ«è¡¨ç¤º: è¾“å…¥æµçš„operatorId/componentId, streamId</span></span><br><span class="line">    bolt.shuffleGrouping(operator.getOperatorId(), strname);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Operatorç®—å­çš„idä¼šä½œä¸ºStormä¸­Spout/Boltçš„component-id, è€ŒOperatorçš„è¾“å…¥æµ/è¾“å‡ºæµåç§°æ˜¯ä½œä¸ºSpout/Boltçš„stream-id.<br>component-idåªæ˜¯ç”¨äºåŒºåˆ«ä¸åŒçš„ç»„ä»¶,æˆ–è€…ç”¨äºä»å“ªä¸ªè¾“å…¥ç»„ä»¶è·å–æ•°æ®. è€Œstream-idåˆ™å¯ä»¥ä½œä¸ºåˆ†æµ/å¤šæµ/åˆå¹¶æµç­‰.  </p>
</blockquote>
<h3 id="Bolt_Creation">Bolt Creation</h3><p>createBoltsè®¾ç½®Operatorçš„åˆ†ç»„ç­–ç•¥, é¦–å…ˆåˆ›å»ºIRichBolt,å¹¶è¿”å›Boltçš„å£°æ˜BoltDeclarer,ä»¥ä¾¿åç»­æ“ä½œå¯ä»¥åœ¨BoltDeclarerç»§ç»­è¿›è¡Œ(æ¯”å¦‚ä¸Šé¢çš„åˆ†ç»„ç­–ç•¥).  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> BoltDeclarer <span class="title">createBoltDeclarer</span><span class="params">(IRichOperator operator)</span></span>&#123;</span><br><span class="line">    IRichBolt bolt;</span><br><span class="line">    <span class="keyword">if</span> ((operator <span class="keyword">instanceof</span> FunctionOperator) || (operator <span class="keyword">instanceof</span> FunctionStreamOperator)) &#123;</span><br><span class="line">        bolt = createStormBolt(operator);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        bolt = createOutputStormBolt(operator);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> builder.setBolt(operator.getOperatorId(), bolt, operator.getParallelNumber());</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> IRichBolt <span class="title">createOutputStormBolt</span><span class="params">(IRichOperator f)</span></span>&#123;</span><br><span class="line">    StormOutputBolt outputbolt = <span class="keyword">new</span> StormOutputBolt();     </span><br><span class="line">    outputbolt.setOperator(f);          <span class="comment">//ç±»ä¼¼äºStormSpoutå°†ç®—å­èµ‹å€¼,çœŸæ­£æ‰§è¡Œæ—¶ä¼šä½¿ç”¨ç®—å­è¿›è¡Œæ“ä½œ</span></span><br><span class="line">    <span class="keyword">return</span> outputbolt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StormSpout,StormBolt,StormOutputBoltéƒ½æ˜¯å¯¹Stormçš„ç»„ä»¶çš„å°è£…. é™¤äº†ç»§æ‰¿å„è‡ªçš„IRichSpoutå’ŒIRichBoltå¤–,è¿˜è¦å®ç°StreamAdapteræ¥å£çš„setOperatoræ–¹æ³•.<br>æµå¤„ç†ç®—å­é€‚é…æ¥å£: ä¾é è¿™ä¸ªæ¥å£ï¼Œå°†æµå¤„ç†çš„ç®—å­æ³¨å…¥åˆ°å…·ä½“çš„Stormçš„Spout/Boltä¸­. <code>åˆ›å»ºBoltä¸ºå•¥ä¸ç”¨æ„é€ å‡½æ•°ä¸€å¥è¯çš„äº‹å„¿: new StormBolt(operator)</code>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StormSpout</span> <span class="keyword">implements</span> <span class="title">IRichSpout</span>, <span class="title">StreamAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> IRichOperator input;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOperator</span><span class="params">(IRichOperator operator)</span></span>&#123;</span><br><span class="line">        input = operator;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StormOutputBolt</span> <span class="keyword">implements</span> <span class="title">IRichBolt</span>, <span class="title">StreamAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> OutputCollector outputCollector;</span><br><span class="line">    <span class="keyword">private</span> OutputOperator output;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOperator</span><span class="params">(IRichOperator operator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.output = (OutputOperator)operator;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StormBoltçš„executeæ–¹æ³•  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple input)</span> </span>&#123;</span><br><span class="line">    String sourceStreamName = input.getSourceStreamId();        <span class="comment">//è·å–Tupleçš„è¾“å…¥æµstream-id</span></span><br><span class="line">    List&lt;String&gt; inStreams = functionStream.getInputStream();   <span class="comment">//è¾“å…¥æµåç§°åˆ—è¡¨,å› ä¸ºä¸€ä¸ªBoltå¯ä»¥æœ‰å¤šä¸ªè¾“å…¥æµ</span></span><br><span class="line">    <span class="keyword">for</span> (String streamName : inStreams) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!sourceStreamName.equals(streamName)) <span class="keyword">continue</span>;     <span class="comment">//åªæœ‰Tupleçš„è¾“å…¥æµstream-idå’ŒIRichOperatorçš„è¾“å…¥æµåç§°ç›¸åŒæ—¶,æ‰å¤„ç†è¿™ä¸ªTuple</span></span><br><span class="line">        TupleEvent event = TupleTransform.tupeToEvent(input, functionStream.getInputSchema().get(streamName));</span><br><span class="line">        functionStream.execute(streamName, event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">2015-11-25 02:32:39 | INFO  | [main] | start to submit application example | com.huawei.streaming.cql.executor.PhysicalPlanExecutor (PhysicalPlanExecutor.java:201)</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | reset submit jar to /private/var/folders/xc/x0b8crk9667ddh1zhfs29_zr0000gn/T/example.5f8ed0baaeb243a49308fd75144cf715.jar | com.huawei.streaming.storm.StormApplication (StormApplication.java:314)</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | Using defaults.yaml from resources | backtype.storm.utils.Utils (Utils.java:253)</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | The baseSleepTimeMs [2000] the maxSleepTimeMs [60000] the maxRetries [5] | backtype.storm.utils.StormBoundedExponentialBackoffRetry (StormBoundedExponentialBackoffRetry.java:47)</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | Using defaults.yaml from resources | backtype.storm.utils.Utils (Utils.java:253)</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | GenFunctionOpsOrder enter. | com.huawei.streaming.application.OperatorMng (OperatorMng.java:205)</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | Using defaults.yaml from resources | backtype.storm.utils.Utils (Utils.java:253)</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | Generated ZooKeeper secret payload for MD5-digest: -5668598407594625313:-5703359794945963404 | backtype.storm.StormSubmitter (StormSubmitter.java:82)</span><br><span class="line">2015-11-25 02:32:39 | INFO  | [main] | Uploading topology jar /private/var/folders/xc/x0b8crk9667ddh1zhfs29_zr0000gn/T/example.5f8ed0baaeb243a49308fd75144cf715.jar to assigned location: storm-local/nimbus/inbox/stormjar-a5b95134-e3f2-431d-b675-924d8c468cf3.jar | backtype.storm.StormSubmitter (StormSubmitter.java:371)</span><br><span class="line">2015-11-25 02:32:40 | INFO  | [main] | Successfully uploaded topology jar to assigned location: storm-local/nimbus/inbox/stormjar-a5b95134-e3f2-431d-b675-924d8c468cf3.jar | backtype.storm.StormSubmitter (StormSubmitter.java:396)</span><br><span class="line">2015-11-25 02:32:40 | INFO  | [main] | Finished submitting topology: example | backtype.storm.StormSubmitter (StormSubmitter.java:248)</span><br><span class="line">2015-11-25 02:32:40 | INFO  | [main] | delete user packed jar after submit | com.huawei.streaming.cql.executor.PhysicalPlanExecutor (PhysicalPlanExecutor.java:156)</span><br><span class="line">2015-11-25 02:32:40 | INFO  | [main] | unRegister jars from class loader. | com.huawei.streaming.cql.DriverContext (DriverContext.java:427)</span><br></pre></td></tr></table></figure>

      
    </div>
    
  </div>
  
    
<div class="copyright">
  <p><span>æœ¬æ–‡æ ‡é¢˜:</span><a href="/2015/11/29/2015-11-29-StreamCQL-application/">StreamCQLæºç é˜…è¯»(4) åº”ç”¨ç¨‹åºæ‰§è¡Œ</a></p>
  <p><span>æ–‡ç« ä½œè€…:</span><a href="/" title="è®¿é—® ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½ çš„ä¸ªäººåšå®¢">ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½</a></p>
  <p><span>å‘å¸ƒæ—¶é—´:</span>2015å¹´11æœˆ29æ—¥ - 00æ—¶00åˆ†</p>
  <p><span>æœ€åæ›´æ–°:</span>2019å¹´02æœˆ14æ—¥ - 21æ—¶42åˆ†</p>
  <p>
    <span>åŸå§‹é“¾æ¥:</span><a href="/2015/11/29/2015-11-29-StreamCQL-application/" title="StreamCQLæºç é˜…è¯»(4) åº”ç”¨ç¨‹åºæ‰§è¡Œ">http://github.com/zqhxuyuan/2015/11/29/2015-11-29-StreamCQL-application/</a>
    <span class="btn" data-clipboard-text="åŸæ–‡: http://github.com/zqhxuyuan/2015/11/29/2015-11-29-StreamCQL-application/ã€€ã€€ä½œè€…: ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½" title="ç‚¹å‡»å¤åˆ¶æ–‡ç« é“¾æ¥">
        <i class="fa fa-clipboard"></i>
    </span>
  </p>
  <p><span>è®¸å¯åè®®:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="ä¸­å›½å¤§é™† (CC BY-NC-SA 3.0 CN)">"ç½²å-éå•†ç”¨-ç›¸åŒæ–¹å¼å…±äº« 3.0"</a> è½¬è½½è¯·ä¿ç•™åŸæ–‡é“¾æ¥åŠä½œè€…ã€‚</p>
  <script src="/js/clipboard.min.js"></script>
  <script> var clipboard = new Clipboard('.btn'); </script>
</div>
<style type="text/css">
  .copyright p .btn {
    margin-left: 1em;
  }
  .copyright:hover p .btn::after {
    content: "å¤åˆ¶"
  }
  .copyright p .btn:hover {
      color: gray;
      cursor: pointer;
    };
</style>



<nav id="article-nav">
  
    <div id="article-nav-newer" class="article-nav-title">
      <a href="/2015/12/02/2015-12-02-Hello-Druid/">
        Druid åˆ†å¸ƒå¼OLAPå…¥é—¨
      </a>
    </div>
  
  
    <div id="article-nav-older" class="article-nav-title">
      <a href="/2015/11/27/2015-11-27-StreamCQL-operator/">
        StreamCQLæºç é˜…è¯»(3) æ‹†åˆ†ç»„åˆç®—å­
      </a>
    </div>
  
</nav>

  
  
    <div class="post-donate">
	<br>
	<p>
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="æ‰“èµ"></a>
        <span class="donate_txt">
           &uarr;<br>
		   æ‹›äººå¹¿å‘Šï¼šå¯¹èš‚èšé‡‘æœä¸­é—´ä»¶æ„Ÿå…´è¶£çš„å¯ä»¥å‘é‚®ä»¶åˆ°ï¼šqihuang.zqh at antfin.com
        </span>
        <br>
    </div>  
	<div id="donate_guide" class="donate_bar center hidden">
		<img src="/img/zhifubao.png" alt="æ”¯ä»˜å®æ‰“èµ"> 
		<img src="/img/weixin.png" alt="å¾®ä¿¡æ‰“èµ">  
    </div>
	<script type="text/javascript">
		document.getElementById('btn_donate').onclick = function(){
			$('#donate_board').addClass('hidden');
			$('#donate_guide').removeClass('hidden');
		}
	</script>
</p></div>
  
</article>

<!-- é»˜è®¤æ˜¾ç¤ºæ–‡ç« ç›®å½•ï¼Œåœ¨æ–‡ç« ---å‰è¾“å…¥toc: falseå…³é—­ç›®å½• -->
<!-- Show TOC and tocButton in default, Hide TOC via putting "toc: false" before "---" at [post].md -->
<div id="toc" class="toc-article">
<strong class="toc-title">æ–‡ç« ç›®å½•</strong>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#å‰æˆ:_CQLä»£ç ç»“æ„"><span class="toc-number">1.</span> <span class="toc-text">å‰æˆ: CQLä»£ç ç»“æ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ­£æ–‡:_submitApplication"><span class="toc-number">2.</span> <span class="toc-text">æ­£æ–‡: submitApplication</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#api-Application_->_application-Application"><span class="toc-number">2.1.</span> <span class="toc-text">api.Application -&gt; application.Application</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#IRichOperator"><span class="toc-number">2.1.1.</span> <span class="toc-text">IRichOperator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PhysicalPlanExecutor_->_ExecutorPlanGenerator"><span class="toc-number">2.1.2.</span> <span class="toc-text">PhysicalPlanExecutor -&gt; ExecutorPlanGenerator</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#parseSchemas:_Schema_->_TupleEventType"><span class="toc-number">2.2.</span> <span class="toc-text">parseSchemas: Schema -&gt; TupleEventType</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#parseOperators:_ç®—å­è§£æ"><span class="toc-number">2.3.</span> <span class="toc-text">parseOperators: ç®—å­è§£æ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#createOperatorInfos"><span class="toc-number">2.3.1.</span> <span class="toc-text">createOperatorInfos</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#combineOperators"><span class="toc-number">2.3.2.</span> <span class="toc-text">combineOperators</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StormApplication"><span class="toc-number">3.</span> <span class="toc-text">StormApplication</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Bolt_Grouping"><span class="toc-number">3.1.</span> <span class="toc-text">Bolt Grouping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bolt_Creation"><span class="toc-number">3.2.</span> <span class="toc-text">Bolt Creation</span></a></li></ol></li></ol>
</div>
<style type="text/css">
  .left-col .switch-btn {
    display: none;
  }
  .left-col .switch-area {
    display: none;
  }
</style>

<input type="button" id="tocButton" value="éšè—ç›®å½•" title="ç‚¹å‡»æŒ‰é’®éšè—æˆ–è€…æ˜¾ç¤ºæ–‡ç« ç›®å½•">
<script type="text/javascript">
  var toc_button= document.getElementById("tocButton");
  var toc_div= document.getElementById("toc");
  /* Show or hide toc when click on tocButton.
  é€šè¿‡ç‚¹å‡»è®¾ç½®çš„æŒ‰é’®æ˜¾ç¤ºæˆ–è€…éšè—æ–‡ç« ç›®å½•.*/
  toc_button.onclick=function(){
  if(toc_div.style.display=="none"){
  toc_div.style.display="block";
  toc_button.value="éšè—ç›®å½•";
  document.getElementById("switch-btn").style.display="none";
  document.getElementById("switch-area").style.display="none";
  }
  else{
  toc_div.style.display="none";
  toc_button.value="æ˜¾ç¤ºç›®å½•";
  document.getElementById("switch-btn").style.display="block";
  document.getElementById("switch-area").style.display="block";
  }
  }
    if ($(".toc").length < 1) {
        $("#toc").css("display","none");
        $("#tocButton").css("display","none");
        $(".switch-btn").css("display","block");
        $(".switch-area").css("display","block");
    }
</script>


    <style>
        .toc {
            white-space: nowrap;
            overflow-x: hidden;
        }
    </style>

    <script>
        $(document).ready(function() {
            $(".toc li a").mouseover(function() {
                var title = $(this).attr('href');
                $(this).attr("title", title);
            });
        })
    </script>




<div class="share">
	<div class="bdsharebuttonbox">
	<a href="#" class="bds_more" data-cmd="more"></a>
	<a href="#" class="bds_tsina" data-cmd="tsina" title="åˆ†äº«åˆ°æ–°æµªå¾®åš"></a>
	<a href="#" class="bds_sqq" data-cmd="sqq" title="åˆ†äº«ç»™ QQ å¥½å‹"></a>
	<a href="#" class="bds_copy" data-cmd="copy" title="å¤åˆ¶ç½‘å€"></a>
	<a href="#" class="bds_mail" data-cmd="mail" title="é€šè¿‡é‚®ä»¶åˆ†äº«"></a>
	<a href="#" class="bds_weixin" data-cmd="weixin" title="ç”Ÿæˆæ–‡ç« äºŒç»´ç "></a>
	</div>
	<script>
	window._bd_share_config={
		"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	</script>
</div>



<div class="duoshuo" id="comments">
	<!-- å¤šè¯´è¯„è®ºæ¡† start -->
	<div class="ds-thread" data-thread-key="2015/11/29/2015-11-29-StreamCQL-application/" data-title="StreamCQLæºç é˜…è¯»(4) åº”ç”¨ç¨‹åºæ‰§è¡Œ" data-url="http://github.com/zqhxuyuan/2015/11/29/2015-11-29-StreamCQL-application/"></div>
	<!-- å¤šè¯´è¯„è®ºæ¡† end -->
	<!-- å¤šè¯´å…¬å…±JSä»£ç  start (ä¸€ä¸ªç½‘é¡µåªéœ€æ’å…¥ä¸€æ¬¡) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"zqhxuyuan"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- å¤šè¯´å…¬å…±JSä»£ç  end -->
</div>






    <style type="text/css">
    #scroll {
      display: none;
    }
    </style>
    <div class="scroll">
    <a href="#" title="è¿”å›é¡¶éƒ¨"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="æŸ¥çœ‹è¯„è®º"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="è½¬åˆ°åº•éƒ¨"><i class="fa fa-arrow-down"></i></a>
    </div>


  
  
    
    <div class="post-nav-button">
    <a href="/2015/12/02/2015-12-02-Hello-Druid/" title="ä¸Šä¸€ç¯‡: Druid åˆ†å¸ƒå¼OLAPå…¥é—¨">
    <i class="fa fa-angle-left"></i>
    </a>
    <a href="/2015/11/27/2015-11-27-StreamCQL-operator/" title="ä¸‹ä¸€ç¯‡: StreamCQLæºç é˜…è¯»(3) æ‹†åˆ†ç»„åˆç®—å­">
    <i class="fa fa-angle-right"></i>
    </a>
    </div>
  



    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2019 ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank" title="å¿«é€Ÿã€ç®€æ´ä¸”é«˜æ•ˆçš„é™æ€åšå®¢æ¡†æ¶">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="ç®€è€Œä¸å‡åŒæ  Hexo åšå®¢ä¸»é¢˜">Yelee</a> by MOxFIVE
        </div>
    </div>
    <div class="visit">
      <span id="busuanzi_container_site_pv" style="display:none">
        <span id="site-visit">æœ¬ç«™åˆ°è®¿æ•°: 
        <span id="busuanzi_value_site_uv"></span>
        </span>
      </span>
      <span id="busuanzi_container_page_pv" style="display:none">
        <span id="page-visit">, æœ¬é¡µé˜…è¯»é‡: 
        <span id="busuanzi_value_page_pv"></span>
        </span>
      </span>
    </div>
  </div>
</footer>
    </div>
    

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

<script>
  var backgroundnum = 5;
  var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));

  $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
</script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-80646710-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
<a href="#" title="è¿”å›é¡¶éƒ¨"><i class="fa fa-arrow-up"></i></a>
<a href="#footer" title="è½¬åˆ°åº•éƒ¨"><i class="fa fa-arrow-down"></i></a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>