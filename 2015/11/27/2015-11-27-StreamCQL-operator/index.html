<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>StreamCQLæºç é˜…è¯»(3) æ‹†åˆ†ç»„åˆç®—å­ | zqhxuyuan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="StreamCQLçš„ç®—å­ç»„æˆäº†Application">
<meta name="keywords" content="storm">
<meta property="og:type" content="article">
<meta property="og:title" content="StreamCQLæºç é˜…è¯»(3) æ‹†åˆ†ç»„åˆç®—å­">
<meta property="og:url" content="http://github.com/zqhxuyuan/2015/11/27/2015-11-27-StreamCQL-operator/index.html">
<meta property="og:site_name" content="zqhxuyuan">
<meta property="og:description" content="StreamCQLçš„ç®—å­ç»„æˆäº†Application">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://images.weserv.nl/?url=http://img.blog.csdn.net/20151126173430754">
<meta property="og:image" content="https://images.weserv.nl/?url=http://img.blog.csdn.net/20151129160212682">
<meta property="og:updated_time" content="2019-02-14T13:42:29.195Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="StreamCQLæºç é˜…è¯»(3) æ‹†åˆ†ç»„åˆç®—å­">
<meta name="twitter:description" content="StreamCQLçš„ç®—å­ç»„æˆäº†Application">
<meta name="twitter:image" content="https://images.weserv.nl/?url=http://img.blog.csdn.net/20151126173430754">
  
    <link rel="alternative" href="/atom.xml" title="zqhxuyuan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½</a></h1>
		</hgroup>

		
				


		
			<div id="switch-btn" class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>èœå•</li>
						<li>æ ‡ç­¾</li>
						
						
						<li>å…³äºæˆ‘</li>
						
					</ul>
				</div>
			</div>
		

		<div id="switch-area" class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">ä¸»é¡µ</a></li>
				        
							<li><a href="/archives/">å½’æ¡£</a></li>
				        
							<li><a href="/tags/">æ ‡ç­¾</a></li>
				        
							<li><a href="/about/">å…³äº</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<ul class="social">
							
								<li id="æ–°æµªå¾®åš"><a class="æ–°æµªå¾®åš" target="_blank" href="http://weibo.com/xuyuantree" title="æ–°æµªå¾®åš"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
								<li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
					        
						</ul>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/apex/" style="font-size: 10px;">apex</a> <a href="/tags/bigdata/" style="font-size: 10px;">bigdata</a> <a href="/tags/book/" style="font-size: 10px;">book</a> <a href="/tags/cassandra/" style="font-size: 18.89px;">cassandra</a> <a href="/tags/clojure/" style="font-size: 10px;">clojure</a> <a href="/tags/drill/" style="font-size: 16.67px;">drill</a> <a href="/tags/druid/" style="font-size: 13.33px;">druid</a> <a href="/tags/dubbo/" style="font-size: 10px;">dubbo</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/etl/" style="font-size: 10px;">etl</a> <a href="/tags/geode/" style="font-size: 10px;">geode</a> <a href="/tags/graph/" style="font-size: 12.22px;">graph</a> <a href="/tags/hadoop/" style="font-size: 11.11px;">hadoop</a> <a href="/tags/hbase/" style="font-size: 15.56px;">hbase</a> <a href="/tags/ignite/" style="font-size: 10px;">ignite</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/tags/kafka/" style="font-size: 20px;">kafka</a> <a href="/tags/midd/" style="font-size: 10px;">midd</a> <a href="/tags/ops/" style="font-size: 12.22px;">ops</a> <a href="/tags/redis/" style="font-size: 11.11px;">redis</a> <a href="/tags/rocketmq/" style="font-size: 10px;">rocketmq</a> <a href="/tags/scala/" style="font-size: 13.33px;">scala</a> <a href="/tags/spark/" style="font-size: 17.78px;">spark</a> <a href="/tags/storm/" style="font-size: 17.78px;">storm</a> <a href="/tags/tcc/" style="font-size: 10px;">tcc</a> <a href="/tags/timeseries/" style="font-size: 12.22px;">timeseries</a> <a href="/tags/work/" style="font-size: 14.44px;">work</a> <a href="/tags/æµå¤„ç†/" style="font-size: 11.11px;">æµå¤„ç†</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">BIG(DATA)</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"><a href="/" title="å›åˆ°ä¸»é¡µ">ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½</a></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<a href="/" class="profilepic">
				<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			</a>
			<hgroup>
			  <h1 class="header-author"><a href="/" title="å›åˆ°ä¸»é¡µ">ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½</a></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">ä¸»é¡µ</a></li>
		        
					<li><a href="/archives/">å½’æ¡£</a></li>
		        
					<li><a href="/tags/">æ ‡ç­¾</a></li>
		        
					<li><a href="/about/">å…³äº</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
						<ul class="social">
							
								<li id="æ–°æµªå¾®åš"><a class="æ–°æµªå¾®åš" target="_blank" href="http://weibo.com/xuyuantree" title="æ–°æµªå¾®åš"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
								<li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
					        
						</ul>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-2015-11-27-StreamCQL-operator" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/11/27/2015-11-27-StreamCQL-operator/" class="article-date">
  	<time datetime="2015-11-26T16:00:00.000Z" itemprop="datePublished">2015-11-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      StreamCQLæºç é˜…è¯»(3) æ‹†åˆ†ç»„åˆç®—å­
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Source/">Source</a>
	</div>


        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/storm/">storm</a></li></ul>
	</div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>StreamCQLçš„ç®—å­ç»„æˆäº†Application</p>
<a id="more"></a>
<h2 id="å‰æˆ:_buildApplication">å‰æˆ: buildApplication</h2><p>ä¸Šç¯‡åœ¨è§£æSchemaçš„æ—¶å€™åˆ†æäº†CQLä¸­ä¸€äº›å¸¸ç”¨çš„Statement syntaxå’Œå¯¹åº”çš„è¯­æ³•/è¯­ä¹‰è§£æå™¨ç»“æœ,<br>ç°åœ¨ç»§ç»­ApplicationBuilder.buildApplicationä¸­parseSchemasçš„ä¸‹ä¸€æ­¥splitOperators.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    app = <span class="keyword">new</span> Application(applicationName);</span><br><span class="line">    parseSchemas();</span><br><span class="line">    List&lt;SplitContext&gt; splitContexts = splitOperators();            <span class="comment">//æ‹†åˆ†ç®—å­  â¬…ï¸</span></span><br><span class="line">    SplitContext splitContext = combineOperators(splitContexts);    <span class="comment">//ç»„åˆç®—å­, å°†æ‹†åˆ†ç®—å­åˆ—è¡¨è½¬æ¢ä¸ºåªæœ‰ä¸€ä¸ªSplitContext  â¬…ï¸</span></span><br><span class="line">    changeUnionOperators(splitContext);</span><br><span class="line">    changeSchemaAfterAggregate(splitContext);</span><br><span class="line">    app.setOperators(splitContext.getOperators());                  <span class="comment">//æ‹†åˆ†ç»“æœåŒ…å«äº†operatotså’Œtransitions</span></span><br><span class="line">    app.setOpTransition(splitContext.getTransitions());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>combineOperatorsä¼šåˆ›å»ºOperatorCombiner, å¹¶è°ƒç”¨combineæ–¹æ³•å°†splitContextsåˆå¹¶èµ·æ¥,ç»ˆäºæ‰“å°äº†æ—¥å¿—ä¸­çœ‹åˆ°çš„:<code>combine all split contexts</code>(è§£æsubmitä¹‹å).<br>æ„å»ºApplicationçš„ä¸»è¦å·¥ä½œå°±æ˜¯Splitå’ŒCombine,æœ€åå°†SplitContextçš„operatorså’Œtransitionsè®¾ç½®åˆ°Applicationå¯¹è±¡ä¸­,å®Œæˆåº”ç”¨ç¨‹åºçš„æ„å»º,åœ¨è¿™åŸºç¡€ä¸Šå†è¿›è¡Œç‰©ç†ä¼˜åŒ–.    </p>
<p>ä¸ºä»€ä¹ˆè¦å…ˆæ‹†åˆ†, åé¢åˆè¦å†ç»„åˆ?ğŸ˜– ä»¥ä¸‹é¢çš„CQLä¸ºä¾‹:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">insert into stream s1           INSERT  </span><br><span class="line">select type,count(id) count     AGGREGATE  </span><br><span class="line">from s0 (id&gt;10)[ROWS 10]        FROM: FilterBeforeWindow  </span><br><span class="line">having count(id)&gt;10             HAVING: Expression  </span><br><span class="line">group by type                   GROUPBY</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆéœ€è¦é€šè¿‡ä¹‹å‰åˆ†æçš„AnalyzeContextè§£æå‡ºç³»ç»Ÿä¸­æ‰€æœ‰çš„ç®—å­.<br>â‘  INSERT INTO SELECT, å³INSERTè¯­å¥ä¸­åŒ…å«äº†SELECTå­å¥. å¯¹äºINSERTè€Œè¨€åªè¦ç¡®å®šè¾“å‡ºæµåç§°<br>â‘¡ SELECTè¯­å¥åˆ™åŒ…å«æ¯”è¾ƒå¤šçš„ç®—å­, FilterBeforeWindow,Having,GroupBy,COUNTèšåˆ  </p>
<blockquote>
<p>åªè¦å°†CQLä¸­çš„ç®—å­éƒ½æ‹†åˆ†å‡ºæ¥, æ‰èƒ½è¿›ä¸€æ­¥è¿›è¡Œæ•´ç†. æ‰€ä»¥æ‹†åˆ†ç®—å­çš„å·¥ä½œç±»ä¼¼äºä¸ºæ¯ä¸ªå…³é”®è¯è¿›è¡Œå½’ç±».<br>è¯•æƒ³ä¸€ä¸‹: è¦æ•´ç†å¾ˆå¤šæ‚ä¹±çš„ä¸œè¥¿, é¦–å…ˆå¯¹æ¯ä»¶ç‰©å“è¿›è¡Œå½’ç±», æœ€åå†è¿›è¡Œæ€»çš„æ±‡æ€»ğŸ˜Š.  </p>
</blockquote>
<h2 id="æ­£æ–‡:_Split_and_Combine_Operators">æ­£æ–‡: Split and Combine Operators</h2><p>ç¬¬ä¸€æ­¥SplitOperatorsæ‹†åˆ†ç®—å­: åˆ›å»ºå¯¹åº”çš„Splitter,è°ƒç”¨å…¶splitæ–¹æ³•.   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;SplitContext&gt; <span class="title">splitOperators</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;SplitContext&gt; splitContexts = Lists.newArrayList();</span><br><span class="line">    <span class="keyword">for</span> (AnalyzeContext pContext : parseContexts) &#123;         <span class="comment">//parseContextsæ˜¯è¯­ä¹‰è§£æå™¨ç»“æœåˆ—è¡¨</span></span><br><span class="line">        parseAutoCreatePipeStream(splitContexts, pContext); <span class="comment">//ç”±äºschemaæ¨æ–­çš„å­˜åœ¨,ä¸­é—´çš„æµschemaæ²¡æœ‰é€šè¿‡create inputè¯­å¥å®šä¹‰,æ‰€ä»¥æ˜¾ç¤ºçš„åˆ›å»ºä¸€ä¸ªcreate inputçš„è§£æå†…å®¹</span></span><br><span class="line">        parseSubQueryOperators(splitContexts, pContext);    <span class="comment">//è§£æå­æŸ¥è¯¢</span></span><br><span class="line">        SplitContext context = OperatorSplitter.split(buildUtils, pContext);    <span class="comment">//ç®—å­æ‹†åˆ† â¬…ï¸ </span></span><br><span class="line">        splitContexts.add(context);                         <span class="comment">//æ¯ä¸ªAnalyzeContextæ‹†åˆ†åéƒ½å¯¹åº”ä¸€ä¸ªSplitContext</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> splitContexts;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>AnalyzeContextæ˜¯CQLè¯­å¥çš„è¯­ä¹‰è§£æç»“æœ, CQLçš„ä¸Šä¸‹æ–‡ä¿¡æ¯éƒ½å°è£…åœ¨è¯­ä¹‰è§£æç»“æœé‡Œé¢.  ç”±äºè¯­ä¹‰è§£ææ˜¯ä¸ªæ¯”è¾ƒå¤§çš„åˆ‡é¢,<br>éœ€è¦æŠŠè¯­ä¹‰è§£æç»“æœåˆ†æˆæ›´ç»†ç²’åº¦, å³ç®—å­. å¯ä»¥è®¤ä¸ºAnalyzeContext -&gt; SplitContextçš„è½¬æ¢æ˜¯å°†ä»»åŠ¡æ›´åŠ å…·ä½“åŒ–.  </p>
</blockquote>
<p>OperatorSplitterçš„splittersé‡‡ç”¨staticå—æå‰æ·»åŠ äº†ç³»ç»Ÿä¸­ä¹Ÿæœ‰çš„ç®—å­æ‹†åˆ†ç±». ç»“åˆä¸Šé¢çš„splitOperatorså°±æ˜¯ä¸€ä¸ªåŒå±‚å¾ªç¯äº†:<br>é’ˆå¯¹Applicationçš„æ¯ä¸€ä¸ªAnalyzeContext, åˆ¤æ–­å“ªä¸ªSplitterå¯ä»¥è§£æè¿™ä¸ªAnalyzeContext(æ¯ä¸ªAnalyzeContextåªä¼šå¯¹åº”ä¸€ä¸ªSplitter).   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SplitContext <span class="title">split</span><span class="params">(BuilderUtils buildUtils, AnalyzeContext parseContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Splitter splitter : splitters) &#123;</span><br><span class="line">        <span class="keyword">if</span> (splitter.validate(parseContext)) &#123;</span><br><span class="line">            <span class="keyword">return</span> createSplitter(splitter.getClass(), buildUtils).split(parseContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ªå…·ä½“çš„Splitteréƒ½å®ç°äº†validateæ–¹æ³•æ ¹æ®ä¼ å…¥çš„AnalyzeContextå®ç°ç±»(pContext)ç”¨æ¥éªŒè¯èƒ½å¦è¿›è¡Œè§£æ  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Splitter                                AnalyzeContext</span><br><span class="line">    |-- SelectSplitter                      |-- SelectAnalyzeContext     </span><br><span class="line">            |-- DataSourceSplitter          |</span><br><span class="line">            |-- AggregateSplitter           |</span><br><span class="line">            |-- JoinSplitter                |</span><br><span class="line">    |-- InsertSplitter                      |-- InsertAnalyzeContext &gt;&gt; InsertOnlyAnalyzeContext</span><br><span class="line">    |-- SourceOperatorSplitter              |-- CreateStreamAnalyzeContext</span><br><span class="line">    |-- MultiInsertSplitter                 |-- MultiInsertStatementAnalyzeContext</span><br><span class="line">    |-- UserOperatorSplitter                |-- InsertUserOperatorStatementAnalyzeContext</span><br></pre></td></tr></table></figure>
<p>æ¯”å¦‚AggregateSplitterçš„validateæ–¹æ³•ä¼šéªŒè¯æ˜¯ä¸æ˜¯SelectAnalyzeContext.     </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">validate</span><span class="params">(AnalyzeContext parseContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(parseContext <span class="keyword">instanceof</span> SelectAnalyzeContext))    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    SelectAnalyzeContext selectAnalyzeContext = (SelectAnalyzeContext)parseContext;</span><br><span class="line">    FromClauseAnalyzeContext clauseContext = selectAnalyzeContext.getFromClauseContext();</span><br><span class="line">    <span class="keyword">if</span> (clauseContext.getJoinexpression() != <span class="keyword">null</span>)          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (clauseContext.getCombineConditions().size() != <span class="number">0</span>)   <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;  <span class="comment">//å±äºselect,ç„¶åæ—¢ä¸æ˜¯combineï¼Œåˆä¸æ˜¯joinï¼Œé‚£ä¹ˆå°±æ˜¯aggregate</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ™®é€šçš„selectå¯ä»¥çœ‹åšæ˜¯aggregate,æ¯”å¦‚<code>select count(id) from a where</code>å°±æ˜¯ä¸€ç§èšåˆ. å› ä¸ºselectå­å¥æ˜¯count(id)<br>ä½†æ˜¯å¦‚æœæ˜¯<code>select id from a join b on a.id=b.id</code>å› ä¸ºæœ‰joinæ“ä½œå°±ä¸æ˜¯aggregateäº†.<br>æ‰€ä»¥å¯ä»¥çœ‹åˆ°SelectSplitteré’ˆå¯¹è¿™ä¸¤ç§è¯­å¥åˆ†æˆäº†AggregateSplitterå’ŒJoinSplitter.  </p>
</blockquote>
<p>åªæœ‰éªŒè¯æˆåŠŸ,æ‰å¯ä»¥åœ¨æ­¤Splitterä¸Šè°ƒç”¨split: æ ¹æ®AnalyzeContextåˆ›å»ºOperatorç®—å­, å³æ ¹æ®è¯­ä¹‰åˆ†æç»“æœæ‹†åˆ†å†…å®¹</p>
<h3 id="SourceOperatorSplitter_-&gt;_Input/Output_Operator">SourceOperatorSplitter -&gt; Input/Output Operator</h3><p>SourceOperatorSplitterçš„splitä¼šåˆ›å»ºInputå’ŒOutputç®—å­å’Œä¸´æ—¶çš„pipeç®—å­.   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SourceOperatorSplitter</span> <span class="keyword">implements</span> <span class="title">Splitter</span> </span>&#123;   <span class="comment">//æºç®—å­æ‹†åˆ†,åŒ…æ‹¬è¾“å…¥ç®—å­å’Œè¾“å‡ºç®—å­</span></span><br><span class="line">    <span class="keyword">private</span> SplitContext result = <span class="keyword">new</span> SplitContext();</span><br><span class="line">    <span class="keyword">private</span> CreateStreamAnalyzeContext context;             <span class="comment">//ç”±validateä¿è¯,æ‰€ä»¥ä¸‹é¢çš„splitæ–¹æ³•å¯ä»¥å¼ºè½¬</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SplitContext <span class="title">split</span><span class="params">(AnalyzeContext parseContext)</span> </span>&#123;</span><br><span class="line">        context = (CreateStreamAnalyzeContext)parseContext;  <span class="comment">//è¯­ä¹‰è§£æç»“æœ</span></span><br><span class="line">        setParallelNumber();</span><br><span class="line">        addToInput();                       <span class="comment">//åˆ›å»ºè¾“å…¥ç®—å­å¹¶åŠ å…¥åˆ°resultä¸­: InputStreamOperator</span></span><br><span class="line">        addToOutput();                      <span class="comment">//åˆ›å»ºè¾“å‡ºç®—å­å¹¶åŠ å…¥åˆ°resultä¸­: OutputStreamOperator</span></span><br><span class="line">        addToPipe();                        <span class="comment">//è¿æ¥ç®—å­: FilterOperator</span></span><br><span class="line">        result.setParseContext(context);    <span class="comment">//æœ€åéƒ½è¦å°†AnalyzeContextè®¾ç½®åˆ°SplitContextä¸­,è¯´ä¸å®šåé¢è¿˜æ˜¯éœ€è¦å®ƒçš„çˆ¶äº²(context)ç«™å‡ºæ¥æ’‘è…°å‘¢.</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šç¯‡è¯­æ³•ç»“æ„çš„<code>C</code>éƒ¨åˆ†,AnalyzeContext.analyzeä¼šå°†<code>è¯­æ³•è§£æçš„ä¸Šä¸‹æ–‡ç»“æœ</code>è®¾ç½®åˆ°<code>è¯­ä¹‰è§£æç»“æœ</code>ä¸­. è¿™é‡Œåˆ›å»ºçš„<code>ç®—å­</code>åˆ™è¿›ä¸€æ­¥ä¾èµ–äºè¯­ä¹‰è§£æç»“æœ.<br>æ‰€è°“ä»»ä½•äº‹ç‰©éƒ½æ˜¯å¯ä»¥è¿½æœ”åˆ°æºå¤´çš„: <strong><code>StatementContext-&gt;AnalyzeContext-&gt;Operator-&gt;SplitContext-&gt;Application</code></strong>, Operatorå¹¶ä¸æ˜¯ä¸€æ­¥ç™»å¤©,ä¸ç”Ÿä¿±æ¥çš„.<br>å¯ä»¥çœ‹åˆ°contextä¸­çš„RecordReaderClass,DeserializerClass,ReadWriterProperties,SerDePropertiesä¾æ¬¡<code>ç™»åœº</code>å¹¶è¿›å…¥åˆ°Operatorçš„<code>æˆå±€</code>é‡Œ.<br>æ‰€ä»¥Operatoræ²¿è¢­äº†<code>ç¥–å…ˆ</code>çš„ä¸Šä¸‹æ–‡æ•°æ®, ç°åœ¨æ–°çš„ä¸–ç•Œæ ¼å±€å°†æ˜¯ä»¥Operatorä¸º<code>ä¸»è§’</code>çš„äº†, ç¥–å…ˆä»¬å°±å¯ä»¥<code>éšé€€æ±Ÿæ¹–</code>äº†.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addToInput</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (context.getDeserializerClassName() != <span class="keyword">null</span> &amp;&amp; context.getSerializerClassName() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Operator inop = createInputSourceOperator();    <span class="comment">//åˆ›å»ºç®—å­</span></span><br><span class="line">        <span class="keyword">if</span> (inputConverter.validate(inop)) &#123;</span><br><span class="line">            inop = inputConverter.convert(inop);</span><br><span class="line">        &#125;</span><br><span class="line">        result.addOperators(inop);      <span class="comment">//è¿™ä¸ªå¾ˆé‡è¦,å°†æ–°åˆ›å»ºçš„ç®—å­æ·»åŠ åˆ°SplitContextä¸­, åé¢æ‰ä¼šåœ¨è®¾ç½®åˆ°Applicationä¸­ â¬…ï¸ </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> InputStreamOperator <span class="title">createInputSourceOperator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String operatorName = getOperatorName(context.getRecordReaderClassName(),<span class="string">"Input"</span>);</span><br><span class="line">    <span class="comment">//åˆ›å»ºè¾“å…¥æµç®—å­</span></span><br><span class="line">    InputStreamOperator op = <span class="keyword">new</span> InputStreamOperator(buildUtils.getNextOperatorName(operatorName), parallelNumber);</span><br><span class="line">    <span class="comment">//è®¾ç½®è¾“å…¥ç®—å­çš„å±æ€§: ååºåˆ—åŒ–ç±», è¯»å–è®°å½•ç±»</span></span><br><span class="line">    op.setName(context.getStreamAlias());</span><br><span class="line">    op.setDeserializerClassName(context.getDeserializerClassName());</span><br><span class="line">    op.setRecordReaderClassName(context.getRecordReaderClassName());</span><br><span class="line">    <span class="comment">//ååºåˆ—åŒ–ç±»çš„å±æ€§å’Œè¯»å–è®°å½•çš„å±æ€§, å¯¹åº”CQLæœ€åŸå§‹çš„properties. </span></span><br><span class="line">    op.setArgs(<span class="keyword">new</span> TreeMap&lt;String, String&gt;());</span><br><span class="line">    op.getArgs().putAll(context.getReadWriterProperties());</span><br><span class="line">    op.getArgs().putAll(context.getSerDeProperties());</span><br><span class="line">    <span class="keyword">return</span> op;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>pipe streamç®—å­å±äºä¸­é—´ç®—å­ï¼Œæœ¬æ¥æ˜¯ä¸ä¼šå¯¹åº”ä»»ä½•ç®—å­ï¼Œåªè¦è§£æå‡ºschemaå³å¯çš„. ä½†æ˜¯ä¸ºäº†å’ŒCQLçš„æ•´ä½“è§„åˆ™ä¸€è‡´ï¼Œä¾¿äºåé¢åˆ›å»ºç®—å­ä¹‹é—´çš„è¿çº¿ï¼Œ<br>æ‰€ä»¥è¿™é‡Œåˆ›å»ºä¸€ä¸ªç©ºçš„filterç®—å­ï¼Œä¸å¸¦ä»»ä½•è¿‡æ»¤ã€‚ è¿™æ ·ï¼Œå°±å¯ä»¥åœ¨ä¼˜åŒ–å™¨é˜¶æ®µå°†è¿™ä¸ªfilterç®—å­ä¼˜åŒ–æ‰  </p>
</blockquote>
<blockquote>
<p>æ¯ä¸ªoperatorçš„å‚æ•°ç”¨ä¸€ä¸ªMap argsæ¥ä¿å­˜, æ¯”å¦‚ä¸Šé¢è¾“å…¥ç®—å­çš„å‚æ•°åŒ…æ‹¬äº†ReadWriterPropertieså’ŒSerDeProperties.<br>å› ä¸ºæ‰§è¡Œå™¨ä¸çŸ¥é“æ¯ä¸ªoperatorä¸­åˆ°åº•éœ€è¦å“ªäº›å‚æ•°ï¼Œæ‰€ä»¥åªèƒ½éƒ½æ”¾åœ¨mapä¸­, ç”±ä¸Šå±‚å®¢æˆ·ç«¯è¿›è¡Œå¡«å……ï¼Œå¹¶åœ¨åº•å±‚è¿è¡Œæ—¶æ£€æµ‹</p>
</blockquote>
<h3 id="InsertSplitter_-&gt;_Insert_Operator">InsertSplitter -&gt; Insert Operator</h3><p>insert intoè¯­å¥çš„AnalyzeContextåŒ…å«äº†outputStreamNameå’Œselectå­å¥, è¾“å‡ºæµå¯ä»¥ç›´æ¥è®¾ç½®åˆ°SplitContextç»“æœä¸­. è€Œselectå­å¥éœ€è¦<br>å†æ¬¡è°ƒç”¨æŸ¥è¯¢ç›¸å…³çš„Splitter(è¿”å›å€¼ä¹Ÿæ˜¯SplitContext), å¹¶å°†å…¶ç»“æœäº§ç”Ÿçš„operatorså’Œtransitionsæ·»åŠ åˆ°insertçš„SplitContextä¸­.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InsertSplitter</span> <span class="keyword">implements</span> <span class="title">Splitter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> InsertAnalyzeContext context;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SplitContext <span class="title">split</span><span class="params">(AnalyzeContext parseContext)</span> </span>&#123;</span><br><span class="line">        context = (InsertAnalyzeContext)parseContext;</span><br><span class="line">        result.setOutputStreamName(context.getOutputStreamName());</span><br><span class="line">        <span class="comment">//insertä¸­åŒ…å«äº†select, æ‰€ä»¥è¦å…ˆåˆ›å»ºselectç®—å­, è°ƒç”¨SelectSplitter.split</span></span><br><span class="line">        SplitContext selectResult = OperatorSplitter.split(buildUtils, context.getSelectContext());</span><br><span class="line">        <span class="comment">//å°†selectçš„ç»“æœç®—å­å’Œè¿æ¥éƒ½åŠ å…¥åˆ°insertç®—å­ä¸­</span></span><br><span class="line">        result.getOperators().addAll(selectResult.getOperators());</span><br><span class="line">        result.getTransitions().addAll(selectResult.getTransitions());</span><br><span class="line">        result.setParseContext(context);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>SourceOperatorSplitterå’ŒInsertSplitterè®¾ç½®åˆ°SplitContext resultä¸­çš„å†…å®¹å¹¶ä¸æ˜¯ä¸€æ ·çš„. è¿™æ˜¯ç”±äºä¸åŒçš„AnalyzeContextæ‰€å­˜å‚¨çš„<br>æ•°æ®ä¹Ÿæ˜¯ä¸åŒçš„, æ•°æ®æºåªéœ€è¦åºåˆ—åŒ–ç±»,è¯»å–ç±»ç­‰. è€Œæ’å…¥è¯­å¥åˆ™æœ‰è¾“å‡ºæµå’Œè¾“å…¥æº(select). æ‰€ä»¥ä½ <code>åƒçš„æ˜¯ä»€ä¹ˆè‰, æŒ¤å‡ºæ¥çš„å¥¶ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„</code>.  </p>
</blockquote>
<h3 id="SelectSplitter">SelectSplitter</h3><p>SelectSplitteråŒ…å«äº†<code>DataSource,â‘ Aggregate,â‘¡JoinSplitter</code>.é’ˆå¯¹selectè¯­å¥çš„æ‹†åˆ†ä»¥åŠSchemaåˆ†ä¸º:  </p>
<p>1ã€æœ€ä¸€èˆ¬çš„selectå­å¥ã€‚<br>åªæœ‰ä¸€ä¸ªschema, è¾“å…¥å’Œè¾“å‡ºéƒ½æ˜¯(åŒ)ä¸€ä¸ªschema, ä¸è®ºæœ‰æ²¡æœ‰çª—å£ï¼Œéƒ½å¿…é¡»æ”¾åœ¨èšåˆç®—å­(AggregateSplitter)ä¸­ã€‚<br>åªè¦æœ‰whereï¼Œå°±éƒ½æ”¾åœ¨functorç®—å­(è¡¨è¾¾å¼)ä¸­ï¼Œåœ¨ä¼˜åŒ–å™¨ä¸­ï¼Œå†è¿›è¡Œè°ƒæ•´ï¼Œå¯ä»¥æ”¹ä¸ºfilteræˆ–è€…ç»§æ‰¿å†èšåˆç®—å­ä¸­ã€‚  </p>
<blockquote>
<p>å•å•ä¸€ä¸ªselectä¸ºä»€ä¹ˆè¦æ·»åŠ èšåˆç®—å­?<br>ç­”: èšåˆä¸ä¸€å®šå°±æ˜¯group by, å¯èƒ½æ˜¯filterè¿‡æ»¤,limité™åˆ¶æ¡æ•°ç­‰.<br>è€Œselectåé¢æ˜¯å¯ä»¥è·Ÿä¸Šfilteræˆ–è€…limitç­‰. èšåˆè¿˜å¯ä»¥æ˜¯count,sumç­‰.  </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">                     |SELECTå­å¥</span><br><span class="line">insert into stream s0 select id,name from s0 where id&gt;10</span><br><span class="line">                      ---------------        ----------- </span><br><span class="line">                      Aggregate              Functor(expression)</span><br></pre></td></tr></table></figure>
<p>2ã€Join: å¤šä¸ªJoinçš„schemaï¼Œä¸€ä¸ªoutputschema. å…ˆæŸ¥è¯¢å‡ºå¤šä¸ªè¡¨æ‰€æœ‰çš„åˆ—ï¼Œå†åœ¨functorç®—å­ä¸­è¿›è¡Œåˆ—è¿‡æ»¤ã€‚  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select s0.id,s1.name from s0 join s1 on s0.id = s1.id</span><br><span class="line">                     ------- -------</span><br><span class="line">                     s0å…ƒæ•°æ® s1å…ƒæ•°æ®</span><br><span class="line">                            â¬‡ï¸</span><br><span class="line">       -----------------------------</span><br><span class="line">       Functoråˆ—è¿‡æ»¤</span><br></pre></td></tr></table></figure>
<p>3ã€Groupby: èšåˆç®—å­<br>4ã€orderby: åŒä¸€èˆ¬selectå­å¥<br>5ã€Joinè¯­å¥ä¸­ä¸æ”¯æŒèšåˆå’Œgroupbyï¼Œè‡³å°‘ç›®å‰ä¸æ”¯æŒ<br>6ã€ä¸‰ç§è¿‡æ»¤<br>A.çª—å£ä¹‹åçš„è¿‡æ»¤ï¼šwhereï¼Œæ”¾åœ¨èšåˆç®—å­ä¸­<br>B.çª—å£ä¹‹å‰çš„è¿‡æ»¤ï¼šfilterï¼Œå‰é¢åŠ ä¸€ä¸ªfilterç®—å­, ä½†æ˜¯è¿™æ ·å°±ç‰µæ‰¯åˆ°schemaçš„å˜åŒ–ï¼Œè¿™ä¸ªå°±éº»çƒ¦ä¸€äº›äº†ã€‚å…ˆè§£æå‡ºæ‰€æœ‰çš„åˆ—ï¼Œå†è¿›è¡Œè¿‡æ»¤ã€‚<br>C.èšåˆä¹‹åçš„è¿‡æ»¤ï¼šhavingï¼Œæ”¾åœ¨èšåˆç®—å­ä¸­  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT type,count(id) FROM s0 where code=&apos;test&apos; (id&gt;10)[ROWS 10] HAVING count(id)&gt;100 </span><br><span class="line">                              ----------------  -------          --------------------</span><br><span class="line">                              Aâ¬‡                Bâ¬‡ï¸              Câ¬‡ï¸</span><br><span class="line">                              Aggregate         Filter+Agg       Aggregate</span><br></pre></td></tr></table></figure>
<p>æ€»ç»“ä¸‹ï¼š<br>1ã€<code>èšåˆç®—å­</code>æ˜¯å¿…é¡»æœ‰çš„ã€‚<br>2ã€Orderbyå¿…é¡»æ”¾åœ¨ç‹¬ç«‹sortç®—å­ä¸­<br>3ã€limitæ”¾åœ¨outputä¸­ä½œä¸ºé™åˆ¶ï¼Œä½†æ˜¯ç›®å‰è¿˜ä¸æ”¯æŒ<br>4ã€<code>ä¸€ä¸ªselectè¯­å¥ï¼Œæ— è®ºå¦‚ä½•æ‹†åˆ†ï¼Œéƒ½åªæœ‰ä¸€ä¸ªè¾“å‡ºschema</code>. (è‡³å°‘ç›®å‰æ˜¯è¿™æ ·,åé¢åœ¨ä¼˜åŒ–å™¨ä¸­ä¼šè¿›è¡Œè°ƒæ•´,å°†whereä¸­çš„ä¸€äº›åˆ—åŠ å…¥åˆ°selectä¸­,è¿›è¡Œä¸€äº›åˆ—å˜æ¢)<br>5ã€Joinæ—¶å€™ï¼Œå…ˆæŸ¥è¯¢è¯¥æµ<code>æ‰€æœ‰åˆ—</code>çš„Joinç»“æœï¼Œä¹‹åå†è¿›è¡Œ<code>åˆ—è¿‡æ»¤</code><br>6ã€Sortã€Joinã€Aggregateç®—å­éƒ½æ˜¯æŒ‰ç…§<code>å­—æ®µ</code>è¿›è¡Œåˆ†å‘ï¼Œå…¶ä»–éƒ½æ˜¯<code>éšæœº</code>åˆ†å‘  </p>
<p>æŠ½è±¡ç±»SelectSplitterçš„splitFromClauseäº¤ç»™å­ç±»(Join,DataSource,AggregatePlitter)è‡ªå·±å»å®ç°:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectSplitter</span> <span class="keyword">implements</span> <span class="title">Splitter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> SplitContext result = <span class="keyword">new</span> SplitContext();       <span class="comment">//ç®—å­çš„æ‹†åˆ†ç»“æœ, æ•°æ®ä¸»è¦ç”±AnalyzeContextè€Œæ¥</span></span><br><span class="line">    <span class="keyword">private</span> SelectAnalyzeContext selectAnalyzeContext;      <span class="comment">//AnalyzeContextè¯­ä¹‰è§£æç»“æœ    </span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SplitContext <span class="title">split</span><span class="params">(AnalyzeContext parseContext)</span> </span>&#123;</span><br><span class="line">        initParameters(parseContext);   <span class="comment">//åˆå§‹åŒ–, ç”±äºSelectè¯­å¥åŒ…å«äº†å¾ˆå¤šå­å¥,å› æ­¤è¿˜è¦åœ¨è¿™é‡Œå®šä¹‰å…¶ä»–å­å¥çš„AnalyzeContext.</span></span><br><span class="line">        setParallelNumber();</span><br><span class="line">        splitFromClause();              <span class="comment">//æŠ½è±¡æ–¹æ³•</span></span><br><span class="line">        result.setParseContext(selectAnalyzeContext);       <span class="comment">//è®¾ç½®åˆ°SplitContextç»“æœä¸­</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SelectClauseAnalyzeContext selectClauseContext; <span class="comment">//æ—¢ç„¶è¦è§£æSlectè¯­å¥,å°±è¦è§£æå®ƒåŒ…å«çš„æ‰€æœ‰å­å¥! æ­£å¦‚å‰é¢çš„insertä¹Ÿè¦å…ˆè·å¾—select!</span></span><br><span class="line">    <span class="keyword">private</span> FromClauseAnalyzeContext fromClauseContext;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initParameters</span><span class="params">(AnalyzeContext parseContext)</span> </span>&#123;</span><br><span class="line">        selectAnalyzeContext = (SelectAnalyzeContext)parseContext;</span><br><span class="line">        selectClauseContext = selectAnalyzeContext.getSelectClauseContext();</span><br><span class="line">        fromClauseContext = selectAnalyzeContext.getFromClauseContext();</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å…³äºå±‚çº§åµŒå¥—: æ¯”å¦‚insertä¸­åµŒå¥—äº†select. æ‰€ä»¥è§£æinsertæ—¶è¦å…ˆè§£æselect,å†æŠŠselectè®¾ç½®åˆ°insertä¸­.<br>åŒæ ·selectè¯­å¥åŒ…å«äº†æ›´å¤šçš„å­å¥,æ¯”å¦‚selectå­å¥,fromå­å¥, æ‰€ä»¥ä¹Ÿè¦æŠŠæ——ä¸‹åŒ…å«çš„æ‰€æœ‰å­å¥éƒ½è§£æå®Œäº†,è‡ªå·±æ‰æ˜¯å®Œæ•´çš„å¯ç”¨çš„.  </p>
</blockquote>
<h3 id="AggregateSplitter_-&gt;_FilterOp_+_AggregateOp_+_Transition">AggregateSplitter -&gt; FilterOp + AggregateOp + Transition</h3><p>AggregateSplitterçš„çˆ¶ç±»æ˜¯SelectSplitter, è€ŒSelectåŒ…å«Fromå­å¥. Fromä¸­å¯ä»¥æœ‰â‘ FilterOperator: <code>filter before window</code><br>æµå‰çš„è¿‡æ»¤: <code>FROM transform (evnetid&gt;10)[range UNBOUNDED]</code>. å…¶ä¸­[]è¡¨ç¤ºwindow, è€Œ[]å‰é¢çš„()åˆ™æ˜¯filterè¿‡æ»¤.<br>â‘¡æ‹†åˆ†AggregateOperator, å› ä¸ºèšåˆç®—å­å¯èƒ½åŒ…æ‹¬å¤šç§èšåˆæ“ä½œ, å¦‚æœå­˜åœ¨åˆ™éƒ½è®¾ç½®åˆ°AggregateOperatorå¯¹åº”çš„å­—æ®µä¸­.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">splitFromClause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è·å–Selectä¸­Fromå­å¥çš„è¯­ä¹‰è§£æç»“æœ</span></span><br><span class="line">    FromClauseAnalyzeContext clauseContext = getFromClauseContext();    <span class="comment">//å®šä¹‰åœ¨çˆ¶ç±»SelectSplitterä¸­,åˆå§‹åŒ–æ—¶ç”±Selectè·å–</span></span><br><span class="line">    String streamName = clauseContext.getInputStreams().get(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//â‘  åœ¨Windowæ“ä½œå‰å¯ä»¥æœ‰Filteræ“ä½œ, æ‹†åˆ†å‡ºFilterç®—å­, åœ¨çˆ¶ç±»SelectSplitterä¸­å®ç°</span></span><br><span class="line">    FilterOperator fop = splitFiterBeforeWindow(streamName);</span><br><span class="line">    <span class="comment">//â‘¡ èšåˆç®—å­</span></span><br><span class="line">    AggregateOperator aggregateOperator = splitAggregateOperator(clauseContext, streamName);</span><br><span class="line">    <span class="comment">//â‘¢ åˆ›å»ºç®—å­ä¹‹é—´çš„è¿æ¥</span></span><br><span class="line">    OperatorTransition transition = createTransition(fop, aggregateOperator, streamName);</span><br><span class="line">    </span><br><span class="line">    getResult().addOperators(fop);                  <span class="comment">//è¿‡æ»¤ç®—å­</span></span><br><span class="line">    getResult().addOperators(aggregateOperator);    <span class="comment">//èšåˆç®—å­</span></span><br><span class="line">    getResult().addTransitions(transition);         <span class="comment">//ä»è¿‡æ»¤ç®—å­åˆ°èšåˆç®—å­çš„è¿çº¿</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> FilterOperator <span class="title">splitFiterBeforeWindow</span><span class="params">(String streamName)</span> </span>&#123;</span><br><span class="line">    FromClauseAnalyzeContext clauseContext = getFromClauseContext();</span><br><span class="line">    <span class="comment">//æ–°åˆ›å»ºä¸€ä¸ªFilterè¿‡æ»¤ç®—å­, from stream(id&gt;1)[RANGE 10s] å¯ä»¥åœ¨æµä¹‹å,çª—å£ä¹‹å‰çš„ä¸­é—´å­˜åœ¨Filterè¿‡æ»¤: åœ¨è¿›å…¥çª—å£å‰è¿‡æ»¤</span></span><br><span class="line">    FilterOperator fop = <span class="keyword">new</span> FilterOperator(buildUtils.getNextOperatorName(<span class="string">"Filter"</span>), parallelNumber);</span><br><span class="line">    <span class="comment">//ä»Fromè¯­ä¹‰è§£æç»“æœä¸­è·å–filterBeforeWindowå¯¹åº”å½“å‰streamçš„filterè¡¨è¾¾å¼,æ¯”å¦‚ä¸Šé¢çš„id&gt;1</span></span><br><span class="line">    ExpressionDescribe expression = clauseContext.getFilterBeForeWindow().get(streamName);</span><br><span class="line">    fop.setFilterExpression(expression.toString());                     <span class="comment">//è¿‡æ»¤æ¡ä»¶è¡¨è¾¾å¼,æ¯”å¦‚id&gt;1</span></span><br><span class="line">    fop.setOutputExpression(createFilterOutputExpression(streamName));  <span class="comment">//è¾“å‡ºåˆ—</span></span><br><span class="line">    <span class="keyword">return</span> fop;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> AggregateOperator <span class="title">splitAggregateOperator</span><span class="params">(FromClauseAnalyzeContext clauseContext, String streamName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºæ–°çš„èšåˆç®—å­</span></span><br><span class="line">    AggregateOperator aggop = <span class="keyword">new</span> AggregateOperator(getBuildUtils().getNextOperatorName(<span class="string">"Aggregator"</span>), getParallelNumber());</span><br><span class="line">    parseWindow(clauseContext, streamName, aggop);  <span class="comment">//è§£æçª—å£. Windowå…¶å®ä¹Ÿæ˜¯Fromçš„ä¸€éƒ¨åˆ†,æ‰€ä»¥éœ€è¦ä»Fromå­å¥ä¸­è·å–Windowsè®¾ç½®åˆ°aggopé‡Œ</span></span><br><span class="line">    parseWhere(aggop);                              <span class="comment">//è§£æè¿‡æ»¤: setFilterBeforeAggregate,åœ¨èšåˆä¹‹å‰çš„è¿‡æ»¤.</span></span><br><span class="line">    aggop.setFilterAfterAggregate(parseHaving());   <span class="comment">//è§£æhaving</span></span><br><span class="line">    aggop.setGroupbyExpression(parseGroupby());     <span class="comment">//è§£æåˆ†ç»„</span></span><br><span class="line">    aggop.setOrderBy(parseOrderBy());               <span class="comment">//è§£ææ’åº</span></span><br><span class="line">    aggop.setLimit(parseLimit());                   <span class="comment">//è§£æé™åˆ¶</span></span><br><span class="line">    aggop.setOutputExpression(getSelectClauseContext().toString());     <span class="comment">//è¾“å‡ºè¡¨è¾¾å¼: selectå…³é”®å­—åé¢çš„éƒ½æ˜¯è¾“å‡º</span></span><br><span class="line">    <span class="keyword">return</span> aggop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>AggregateOperatorå¯¹Selectå­å¥çš„è§£ææœ€åéƒ½æ˜¯å­—ç¬¦ä¸².  </p>
</blockquote>
<table>
<thead>
<tr>
<th>aggregation</th>
<th>setXXX</th>
<th>AnalyzerContext</th>
<th>parseXXX</th>
</tr>
</thead>
<tbody>
<tr>
<td>window</td>
<td>setWindow</td>
<td>FromClauseAnalyzeContext.windows.get(streamName)</td>
<td>parseWindow</td>
</tr>
<tr>
<td>where</td>
<td>setFilterBeforeAggregate</td>
<td>FilterClauseAnalzyeContext whereClauseContext</td>
<td>parseWhere</td>
</tr>
<tr>
<td>having</td>
<td>setFilterAfterAggregate</td>
<td>FilterClauseAnalzyeContext havingClauseContext</td>
<td>parseHaving</td>
</tr>
<tr>
<td>group by</td>
<td>setGroupbyExpression</td>
<td>SelectClauseAnalyzeContext groupbyClauseContext</td>
<td>parseGroupby</td>
</tr>
<tr>
<td>order by</td>
<td>setOrderBy</td>
<td>OrderByClauseAnalyzeContext</td>
<td>parseOrderBy</td>
</tr>
<tr>
<td>limit</td>
<td>setLimit</td>
<td>LimitClauseAnalzyeContext</td>
<td>parseLimit</td>
</tr>
<tr>
<td>output exp</td>
<td>setOutputExpression</td>
<td>SelectClauseAnalyzeContext selectClauseContext</td>
<td>getSelectClauseContext</td>
</tr>
</tbody>
</table>
<p>é€šè¿‡ä¸Šé¢çš„AggregateSplitter.splitæ–¹æ³•,æˆ‘ä»¬çŸ¥é“äº†èšåˆç®—å­ç”±FilterBeforeWindow,Window,FilterBeforeAggregate,Having,GroupBy,OrderBy,Limitç»„æˆ.  </p>
<blockquote>
<p>è¯­æ³•ç»“æ„ä¸­å¹¶æ²¡æœ‰Aggregateè¿™ç§ç±»å‹, ä½†æ˜¯æˆ‘ä»¬å‘ç°Aggregateç”¨åˆ°çš„è¿™äº›å’ŒSelectè¯­å¥ä¸­åŒ…å«çš„å­å¥éƒ½å·®ä¸å¤š. å…¶ä¸­ä¸¤ä¸ªWindowå¯ä»¥è®¤ä¸ºæ˜¯Fromå­å¥.<br>FilterBeforeAggregateæ˜¯Whereå­å¥, è¿™æ ·Selectè¯­å¥çš„æ‰€æœ‰éƒ¨åˆ†å°±å’ŒAggregateéƒ½å»åˆäº†! æ‰€ä»¥è¯´Selectä¹Ÿæ˜¯ä¸€ç§Aggregate! (^_^è¿™ä¸æ˜¯å·§åˆå§) </p>
</blockquote>
<h4 id="AggregateOperator">AggregateOperator</h4><p><img src="https://images.weserv.nl/?url=http://img.blog.csdn.net/20151126173430754" alt="stream-operators"></p>
<p>AggregateOperatorèšåˆç®—å­:åŒ…å«äº†window,ä»¥åŠwindowå‰åçš„filteræ“ä½œ. å½“ç„¶è¿˜å°‘ä¸äº†count,sumä¹‹ç±»çš„UDAFå‡½æ•°è®¡ç®—å’ŒUDFå‡½æ•°è®¡ç®—(BasicAggFunctionOperator)<br>AggregateOperator &gt;&gt; BasicAggFunctionOperator &gt;&gt; InnerFunctionOperator è¿™äº›ç±»çš„å­—æ®µæ­£å¥½å¯¹åº”äº†èšåˆç®—å­çš„æ‰€æœ‰ç»„æˆéƒ¨åˆ†.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AggregateOperator</span> <span class="keyword">extends</span> <span class="title">BasicAggFunctionOperator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Window window;                  <span class="comment">//çª—å£ ==&gt; Fromå­å¥</span></span><br><span class="line">    <span class="keyword">private</span> String filterBeforeAggregate;   <span class="comment">//filterçš„è¿‡æ»¤æ¡ä»¶ ==&gt; Whereå­å¥</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicAggFunctionOperator</span> <span class="keyword">extends</span> <span class="title">InnerFunctionOperator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String filterAfterAggregate;    <span class="comment">//èšåˆç±»çš„è¿‡æ»¤æ¡ä»¶, è¿™é‡Œéƒ½æ˜¯udafå‡½æ•°, è¿‡æ»¤ä¸€å®šå‘ç”Ÿåœ¨æ•°æ®èšåˆä¹‹å, è¿™é‡Œçš„è¡¨è¾¾å¼ä¸€å®šä½¿ç”¨çš„æ˜¯outputSchemaä¸­çš„åˆ—åç§°</span></span><br><span class="line">    <span class="keyword">private</span> String groupbyExpression;       <span class="comment">//åˆ†ç»„çš„è¡¨è¾¾å¼</span></span><br><span class="line">    <span class="keyword">private</span> String orderBy;                 <span class="comment">//æ’åº: å…è®¸æœ‰å¤šä¸ªå­—æ®µï¼Œä¹‹é—´æŒ‰ç…§é€—å·åˆ†å‰², å…è®¸å‡ºç°udfå’Œudafå‡½æ•°</span></span><br><span class="line">    <span class="keyword">private</span> Integer limit;                  <span class="comment">//çª—å£çš„è¾“å‡ºé™åˆ¶</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerFunctionOperator</span> <span class="keyword">extends</span> <span class="title">Operator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String outputExpression;        <span class="comment">//è¾“å‡ºçš„åˆ—å®šä¹‰,ä¸å…‰æœ‰å•çº¯çš„åˆ—ï¼Œè¿˜æœ‰udfä»¥åŠudafå‡½æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿‡æ»¤æ¡ä»¶æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å½¢å¼çš„é€»è¾‘è¡¨è¾¾å¼, å…è®¸æœ‰and,orä»¥åŠå¤§æ‹¬å·å’Œudfå‡½æ•°, ä½†æ˜¯ç»å¯¹ä¸å…è®¸å‡ºç°udafå‡½æ•°ï¼Œå› ä¸ºè¿™æ²¡æœ‰èšåˆæ“ä½œ<br><strong>è¿‡æ»¤å‘ç”Ÿåœ¨æ•°æ®è¿›å…¥çª—å£ä¹‹åï¼Œèšåˆä¹‹å‰</strong>. æ¯”å¦‚ (a&gt;1 and a &lt;100) or (b is not null) å°±æ˜¯whereçš„è¿‡æ»¤ï¼Œ </p>
<p>InnerFunctionOperatoråŠŸèƒ½æ€§ç®—å­ï¼Œä¸»è¦ä¸ºç³»ç»Ÿæä¾›windowï¼Œjoinï¼Œorder byï¼Œgroup byç­‰èšåˆæ“ä½œã€‚<br>è¿™é‡Œçš„åç§°å’ŒoperatoråŒ…ä¸­çš„ä¸ä¸€æ ·. è¿™é‡Œå®šä¹‰çš„è¿™äº›operatorï¼Œä¸»è¦æ˜¯è¿›è¡Œæ‰§è¡Œè®¡åˆ’çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ã€‚<br>æ‰€æœ‰çš„æ•°æ®ç±»å‹å…¨éƒ¨æ˜¯<code>å­—ç¬¦ä¸²ç±»å‹</code>ï¼Œä¹‹åè¿˜è¦ç»è¿‡è¯­æ³•çš„è§£æï¼Œç‰©ç†æ‰§è¡Œè®¡åˆ’çš„ä¼˜åŒ–ä¹‹åï¼Œæ‰ä¼šåœ¨applicationä¸­æäº¤ã€‚ </p>
<h4 id="Transition">Transition</h4><p>åˆ«å¿˜äº†,è¿˜æœ‰createTransitionåˆ›å»ºè¿çº¿å“¦: åœ¨AggregateSplitter.splitFromClauseä¸­fromOpæ˜¯FilterBeforeWindow FilterOperator, toOpæ˜¯AggregateOperator.  </p>
<p>ç®—å­ä¹‹é—´è¿›è¡Œè¿æ¥, æ¶‰åŠåˆ°åˆ†ç»„ç­–ç•¥, Stormä¸­Boltå¯ä»¥æŒ‡å®šæ€ä¹ˆæ ¹æ®è¾“å…¥æºè¿›è¡Œåˆ†ç»„, å³è¾“å…¥æºå°†æ•°æ®æ€ä¹ˆåˆ†æµåˆ°å½“å‰Bolt. åˆ†ç»„æ˜¯æœ‰ä¸€å®šä¾æ®çš„,ä¸èƒ½èƒ¡ä¹±è¿æ¥.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> OperatorTransition <span class="title">createTransition</span><span class="params">(Operator fromOp, Operator toOp, String streamName)</span> </span>&#123;</span><br><span class="line">    FromClauseAnalyzeContext clauseContext = getFromClauseContext();</span><br><span class="line">    DistributeType distype = DistributeType.SHUFFLE;</span><br><span class="line">    String disFields = <span class="keyword">null</span>;</span><br><span class="line">    Schema schema = clauseContext.getInputSchemas().get(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//å¦‚æœæœ‰GroupBy,åˆ†ç»„ç­–ç•¥å°±æ˜¯å­—æ®µåˆ†ç»„(distype=FIELDS), æ¯”å¦‚group by type, åˆ™æŒ‰ç…§typeå­—æ®µåˆ†ç»„(disFields=type).  </span></span><br><span class="line">    <span class="keyword">if</span> (getGroupbyClauseContext() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        disFields = removeDataSourceColumnsFromGroupbyExpression(schema, getGroupbyClauseContext().toString());</span><br><span class="line">        distype = DistributeType.FIELDS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç°åœ¨æ˜¯åœ¨SelectSpiltterä¸­, æ‰€ä»¥å¯èƒ½æ˜¯Aggregate,Join,DataSourceä¸­ä»»æ„ä¸€ç§.  </span></span><br><span class="line">    <span class="keyword">if</span> (toOp <span class="keyword">instanceof</span> JoinFunctionOperator) &#123;</span><br><span class="line">        List&lt;Schema&gt; inputSchemas = getFromClauseContext().getInputSchemas();</span><br><span class="line">        schema = BaseAnalyzer.getSchemaByName(streamName, inputSchemas);</span><br><span class="line">        <span class="keyword">if</span> (((JoinFunctionOperator)toOp).getJoinType() != JoinType.CROSS_JOIN) &#123;</span><br><span class="line">            disFields = getJoinExpression(schema);</span><br><span class="line">            distype = DistributeType.FIELDS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºèµ·å§‹ç®—å­åˆ°ç»“æŸç®—å­ä¹‹é—´çš„è¿çº¿, å¹¶ç¡®å®šåˆ†ç»„ç­–ç•¥,åˆ†ç»„å­—æ®µ, å‘èµ·è¿æ¥çš„ç®—å­çš„schemaä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> OperatorTransition(buildUtils.getNextStreamName(), fromOp, toOp, distype, disFields, schema);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ç°åœ¨ä¼¼ä¹è¦é€æ­¥ç”¨Stormçš„ä¾‹å­æ¥ç†è§£äº†,å¦åˆ™ç®—å­ä¹‹é—´ä¸ºä»€ä¹ˆè¦è¿›è¡Œè¿æ¥? è¿æ¥ä¹‹åå°±ç¡®å®šäº†ä¸Šæ¸¸ç®—å­æ€ä¹ˆå‘é€æ•°æ®åˆ°ä¸‹æ¸¸ç®—å­. å‡è®¾Stormæœ‰ä¸¤ä¸ªBolt: Bolt1å’ŒBolt2.<br>Bolt1è¿‡æ»¤æ•°æ®,è¾“å‡º(word,count)ä¸¤ä¸ªå­—æ®µ. ä¸ºäº†èƒ½ä½¿å¾—å¯¹Bolt1è¿‡æ»¤åçš„æ•°æ®è¿›è¡Œåˆ†æµ,Bolt2ä½¿ç”¨Bolt1çš„wordå­—æ®µè¿›è¡ŒFieldGrouping. è¿™æ ·Bolt1ç›¸åŒçš„wordå­—æ®µ<br>åªä¼šåˆ°ç›¸åŒçš„Boltä»»åŠ¡ä¸­, ä¸åŒçš„wordå­—æ®µä¼šåˆ†å‘åˆ°ä¸åŒçš„Bolt2ä»»åŠ¡. æ‰€ä»¥å¯ä»¥æŠŠBolt1çœ‹åšè¿‡æ»¤ç®—å­, Bolt2çœ‹åšæ˜¯èšåˆç®—å­, ä¸­é—´å­˜åœ¨åˆ†ç»„è¿æ¥å¯¹Bolt1çš„æ•°æ®åˆ†æµ.  </p>
</blockquote>
<blockquote>
<p>é‚£ä¹ˆå…·ä½“ä¸‹æ¸¸ç®—å­è¦æ€ä¹ˆæ¥æ”¶ä¸Šæ¸¸ç®—å­çš„æ•°æ®å‘¢? ä¸ç”¨æ‹…å¿ƒ! è¿™é‡Œå…ˆåªæ˜¯åˆ›å»ºè¿æ¥,åªè¦æœ‰è¿æ¥,å°±éƒ½å¥½åŠäº†,æ‰¾å¯¹å…³ç³»æ‰¾å¯¹é—¨è·¯æ˜¯æœ€é‡è¦çš„!</p>
</blockquote>
<h4 id="SplitContext">SplitContext</h4><p>ç°åœ¨ä¸éš¾çœ‹å‡ºSplitContextçš„ä½œç”¨æ˜¯å„ç±»è¯­ä¹‰åˆ†æç»“æœæ‹†åˆ†å†…å®¹. å’Œå‰é¢å‡ ä¸ªXXXContextä¸€æ ·éƒ½åªæ˜¯ä¿å­˜æ•°æ®çš„ä»‹è´¨(è¿˜è®°å¾—StatementContext,AnalyzeContextå—)<br>å¸¸è§çš„CQLè¯­å¥æ ¼å¼<code>insert into stream s0 select</code>ä¸­insertè¯­å¥ç¡®å®šäº†<code>outputStreamName</code>, selectè¯­å¥ç¡®å®šç®—å­æ‹†åˆ†çš„ç»“æœ:<code>operatorså’Œtransitions</code>.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplitContext</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;OperatorTransition&gt; transitions = <span class="keyword">new</span> ArrayList&lt;OperatorTransition&gt;();</span><br><span class="line">    <span class="keyword">private</span> List&lt;Operator&gt; operators = <span class="keyword">new</span> ArrayList&lt;Operator&gt;();</span><br><span class="line">    <span class="keyword">private</span> String outputStreamName;        <span class="comment">//è¾“å‡ºçš„æµåç§°: æŒ‡çš„æ˜¯åœ¨CQLä¸­æ˜¾ç¤ºæŒ‡å®šè¾“å‡ºæµåç§°çš„ã€‚ä¾‹å¦‚insert into ä¹‹ç±»çš„è¯­å¥</span></span><br><span class="line">    <span class="keyword">private</span> AnalyzeContext parseContext;    <span class="comment">//CQLè§£æç»“æœ: é€šè¿‡è¿™ä¸ªç»“æœï¼Œå¯ä»¥è¿›è¡Œå¤šä¸ªCQLä¹‹é—´çš„è¿æ¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ¯ä¸€æ¡CQLè¯­å¥éƒ½å¯¹åº”ä¸€ä¸ªAnalyzeContext, æ¯ä¸ªAnalyzeContextéƒ½æœ‰ä¸€ä¸ªSplitterç”¨æ¥åˆ›å»ºç®—å­. å³ä½¿ä¸Šé¢æˆ‘ä»¬åˆ›å»ºäº†Transitionè¿æ¥, ä½†ä¹Ÿæ˜¯åœ¨åŒä¸€ä¸ªCQLè¯­å¥å†…çš„!<br>è€Œä¸€ä¸ªå®Œæ•´çš„Topologyæ˜¯è¦æ±‚èƒ½æŠŠå¤šä¸ªCQLè¯­å¥çš„ä¸Šä¸‹æ–‡éƒ½ä¸²è”èµ·æ¥ç»„æˆä¸€ä¸ªDAGå›¾çš„. æ‰€ä»¥è¿™å°±æ˜¯åœ¨SplitContextä¸­ä¿ç•™AnalyzeContextçš„å«ä¹‰: Itâ€™ time to Combine!  </p>
</blockquote>
<h3 id="OperatorCombiner">OperatorCombiner</h3><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“ä¸ºä»€ä¹ˆè¦è¿›è¡Œåˆå¹¶äº†,å› ä¸ºå¦‚æœä»…ä»…æ˜¯æ‹†åˆ†æ¯ä¸€æ¡CQLè¯­å¥, è¿™æ ·æœ€åéƒ½æ˜¯ä¸€æ®µä¸€æ®µçš„,æˆ‘ä»¬éœ€è¦æŠŠè¿™äº›ä¸€æ®µä¸€æ®µæ‹¼æ¥æˆå®Œæ•´çš„å›¾.<br>ç›®å‰åªæœ‰ä¸¤ç§CQLè¯­å¥: ä¸€ç§æ˜¯æµå®šä¹‰create streamè¯­å¥, ä¸€ç§æ˜¯insert intoè¯­å¥. å¯¹äºæµå®šä¹‰æ²¡æœ‰ç®—å­ä¹‹é—´çš„è¿æ¥,ä½†æ˜¯schemaè¿˜æ˜¯éœ€è¦çš„.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SplitContext <span class="title">combine</span><span class="params">(List&lt;SplitContext&gt; splitContexts)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; splitContexts.size(); i++) &#123;</span><br><span class="line">        combineSplitContext(splitContexts.get(i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">combineSplitContext</span><span class="params">(SplitContext context)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//åŸå§‹æ¯ä¸€æ¡CQLçš„ç®—å­å’Œè¿çº¿ä¸èƒ½è¢«ç ´åçš„! è¦é‡æ–°åŠ å…¥æœ€åçš„è¿”å›ç»“æœä¸­. </span></span><br><span class="line">    result.getOperators().addAll(context.getOperators());</span><br><span class="line">    result.getTransitions().addAll(context.getTransitions());</span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯SourceOperatorSplitterå¯¹åº”çš„CreateStreamAnalyzeContext, æ˜¯æ²¡æœ‰transitionçš„.  </span></span><br><span class="line">    <span class="keyword">if</span> (context.getParseContext() <span class="keyword">instanceof</span> CreateStreamAnalyzeContext)&#123;</span><br><span class="line">        addSchemasFromCreateStream(context);    <span class="comment">//æ·»åŠ åˆ°inputStreams,outputStreams,pipeStreams</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆå¹¶æ—¶æ–°æ·»åŠ çš„åªæ˜¯CQLä¸CQLä¹‹é—´çš„è¿çº¿! å¯¹äºç®—å­å·²ç»éƒ½æ˜¯å®Œæ•´çš„äº†,ä¸ä¼šç¼ºèƒ³è†Šæ–­è…¿çš„,ä¸éœ€è¦å†æ·»åŠ . â¬…ï¸</span></span><br><span class="line">    createTransition(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createTransition</span><span class="params">(SplitContext context)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//MultiInsertStatementAnalyzeContext</span></span><br><span class="line">    <span class="comment">//InsertUserOperatorStatementAnalyzeContext</span></span><br><span class="line">    InsertAnalyzeContext insertContext = (InsertAnalyzeContext)context.getParseContext();</span><br><span class="line">    createFromTransition(context, insertContext);</span><br><span class="line">    createToTransition(context, insertContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Splitterä¸­SourceOperatorSplitteræ˜¯æ²¡æœ‰operatorså’Œtransitions, InsertSplitterçš„ç®—å­å’Œè¿çº¿åˆ™ä¾èµ–äºSelectSpitter.<br>æ‰€ä»¥å¦‚æœæ˜¯CreateStreamAnalyzeContextåˆ™ä¸ä¼šè°ƒç”¨createTransition, åªæœ‰ä¸‰ç§insertæ‰ä¼šè°ƒç”¨:Insert,MultiInsert,UDFInsert    </p>
</blockquote>
<p>å°†å¤šä¸ªç®—å­ç»„åˆèµ·æ¥, ç»„å»ºç®—å­ä¹‹é—´çš„ä¸Šä¸‹çº§å…³ç³». ç®—å­ä¹‹é—´çš„è¿çº¿ï¼Œæœ‰ä¸¤ç§æ¥æºï¼š<br>1ã€ç®—å­æ˜¯ç”±<code>ä¸€æ¡CQLè¯­å¥</code>æ‹†åˆ†å‡ºå¤šä¸ªç®—å­ç»„æˆï¼Œè¿™æ ·ï¼Œè¿çº¿å°±å¯ä»¥åœ¨æ‹†åˆ†çš„æ—¶å€™ç¡®å®šã€‚<br>2ã€ç®—å­æ˜¯ç”±<code>å¤šæ¡CQLè¯­å¥</code>ç»„åˆè€Œæ¥ï¼Œé€šè¿‡ä½¿ç”¨<code>insert into select from</code>è¿™æ ·çš„è¯­å¥ï¼Œå°±å¯ä»¥å®ç°å¤šä¸ªç®—å­ä¹‹é—´çš„çº§è”ã€‚<br>ç”šè‡³å¯ä»¥æ”¹å˜ç®—å­ä¹‹é—´çš„è¿æ¥å…³ç³»ã€‚æ¯”å¦‚åœ¨aggregateç®—å­ä¹‹å‰åŠ å…¥unionç®—å­, åœ¨aggregateç®—å­ä¹‹ååŠ å…¥splitç®—å­ã€‚  </p>
<p>ä¸ºæ¯ä¸ª<code>insert into select</code>è¯­å¥è§£æå‡ºæ¥çš„ç»“æœåŠ å…¥ä¸Šä¸‹æ–‡è¿çº¿ã€‚<br>CQLè¯­å¥ä¹‹é—´çš„è¿çº¿ï¼Œå¿…ç„¶ä»inputStreamæˆ–è€…PipeStreamå‘èµ·ï¼Œè¿æ¥åˆ°outputStreamæˆ–è€…PipeStream.  </p>
<p><img src="https://images.weserv.nl/?url=http://img.blog.csdn.net/20151129160212682" alt="input-pipe-output"></p>
<h4 id="PipeStream">PipeStream</h4><p>splitOperatorsåœ¨æ‹†åˆ†ä¹‹å‰, ä¼šé¦–å…ˆè§£ææ˜¯å¦éœ€è¦åˆ›å»ºä¹‹å‰æ²¡æœ‰å£°æ˜è¿‡çš„æµ. å¦‚æœä¸å­˜åœ¨,åˆ™åˆ›å»ºPipeStream.   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseAutoCreatePipeStream</span><span class="params">(List&lt;SplitContext&gt; splitContexts, AnalyzeContext pcontext)</span> </span>&#123;</span><br><span class="line">    parseAutoCreatePipeStreamForInsert(splitContexts, pcontext);</span><br><span class="line">    parseAutoCreatePipeStreamForMultiInsert(splitContexts, pcontext);</span><br><span class="line">    parseAutoCreatePipeStreamForUserOperator(splitContexts, pcontext);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseAutoCreatePipeStreamForInsert</span><span class="params">(List&lt;SplitContext&gt; splitContexts, AnalyzeContext pcontext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pcontext <span class="keyword">instanceof</span> InsertAnalyzeContext) &#123;</span><br><span class="line">        InsertAnalyzeContext ipc = (InsertAnalyzeContext)pcontext;</span><br><span class="line">        <span class="keyword">if</span> (!ipc.isPipeStreamNotCreated()) <span class="keyword">return</span>;      <span class="comment">//å…è®¸ç±»å‹ä¸æ˜¯è¾“å…¥/è¾“å‡ºæµçš„æµä¸å­˜åœ¨   </span></span><br><span class="line">        SplitContext sc = createPipeStreamSplitContext(ipc.getOutputSchema());</span><br><span class="line">        splitContexts.add(sc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> SplitContext <span class="title">createPipeStreamSplitContext</span><span class="params">(Schema schema)</span> </span>&#123;</span><br><span class="line">    LOG.info(<span class="string">"create pipe Stream while stream is not created!"</span>);</span><br><span class="line">    CreateStreamAnalyzeContext pipe = <span class="keyword">new</span> CreateStreamAnalyzeContext();</span><br><span class="line">    pipe.setSchema(schema);</span><br><span class="line">    pipe.setStreamName(schema.getId());</span><br><span class="line">    <span class="keyword">return</span> OperatorSplitter.split(buildUtils, pipe);    <span class="comment">//è¾“å…¥è¾“å‡ºæµä½¿ç”¨SourceOperatorSplitteræ‹†åˆ†ç®—å­</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯”å¦‚ä¸‹é¢çš„<code>multi insert</code>è¯­å¥, å…¶ä¸­teststreamæ˜¯äº‹å…ˆåˆ›å»ºå¥½çš„, è€Œs1,s2,s3éƒ½æ²¡æœ‰åˆ›å»ºè¿‡, åœ¨è§£æçš„æ—¶å€™åˆ¤æ–­è¿™äº›insertå¯¹åº”çš„streamæ²¡æœ‰åˆ›å»ºè¿‡,<br>å°±ä¼šåˆ›å»ºè¿™äº›pipe-stream. å› ä¸ºinsertçš„schemaå–å†³äºselect, æ‰€ä»¥è¿™äº›pipe-streamçš„schemaç­‰äºInsertAnalyzeContextçš„outputSchema.   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM teststream</span><br><span class="line">  INSERT INTO STREAM s1 SELECT *</span><br><span class="line">  INSERT INTO STREAM s2 SELECT a</span><br><span class="line">  INSERT INTO STREAM s3 SELECT id, name WHERE id &gt; 10</span><br><span class="line">PRARLLEL 4;</span><br></pre></td></tr></table></figure>
<p>åˆ¤æ–­PipeStreamæ˜¯å¦åˆ›å»ºè¿‡åœ¨InsertStatementAnalyzer.analyzeä¸­. åªè¦æ˜¯insertè¯­å¥, å¦‚æœåœ¨ç³»ç»Ÿå·²æœ‰çš„schemasä¸­ä¸å­˜åœ¨, å°±è®¾ç½®setPipeStreamNotCreated=true<br>è¿™æ ·parseAutoCreatePipeStreamForInsertåœ¨åˆ¤æ–­åˆ°isPipeStreamNotCreatedæ‰ä¼šåˆ›å»ºcreatePipeStreamSplitContext. å¦åˆ™schemaå·²ç»å­˜åœ¨å°±ä¸å†éœ€è¦åˆ›å»ºäº†.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (checkSchemaExists(streamName)) &#123;</span><br><span class="line">    context.setOutputSchema(getSchemaByName(streamName));</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    context.setPipeStreamNotCreated(true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="From_&amp;_To_Transition">From &amp; To Transition</h4><p>é¦–å…ˆæ‰¾åˆ°insert intoè¯­å¥ä¸­è®¡ç®—å‡ºæ¥çš„è¿çº¿çš„èµ·ç‚¹ã€‚æ‰¾åˆ°å¯¹åº”çš„ç®—å­. ç„¶åæ ¹æ®èµ·ç‚¹çš„schemaåç§°ï¼Œæ‰¾åˆ°å¯¹åº”çš„æµåç§°ï¼Œåˆ›å»ºè¿çº¿  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createFromTransition</span><span class="params">(SplitContext context, InsertAnalyzeContext insertContext)</span> </span>&#123;</span><br><span class="line">    List&lt;OperatorTransition&gt; startTransitions = context.getFirstTransitons();</span><br><span class="line">    <span class="keyword">for</span> (OperatorTransition transition : startTransitions) &#123;</span><br><span class="line">        Operator op = context.getOperatorById(transition.getFromOperatorId());</span><br><span class="line">        String startStreamName = transition.getSchemaName();</span><br><span class="line">        SplitContext fromContext = getFromSplitContext(startStreamName);</span><br><span class="line">        Schema schema = getInputSchema(startStreamName, insertContext);</span><br><span class="line">        String nextStreamName = buildUtils.getNextStreamName();</span><br><span class="line">        </span><br><span class="line">        Operator fromOp = fromContext.getLastOperator();</span><br><span class="line">        OperatorTransition fromtransition = <span class="keyword">new</span> OperatorTransition(nextStreamName, fromOp, op, DistributeType.SHUFFLE, <span class="keyword">null</span>, schema);</span><br><span class="line">        result.addTransitions(fromtransition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createToTransition</span><span class="params">(SplitContext context, InsertAnalyzeContext insertContext)</span> </span>&#123;</span><br><span class="line">    Set&lt;Operator&gt; ops = getLastOperator(context);</span><br><span class="line">    <span class="keyword">for</span> (Operator op : ops) &#123;</span><br><span class="line">        String startStreamName = insertContext.getOutputStreamName();</span><br><span class="line">        SplitContext toContext = getToSplitContext(startStreamName);</span><br><span class="line">        Schema schema = insertContext.getOutputSchema();</span><br><span class="line">        String nextStreamName = buildUtils.getNextStreamName();</span><br><span class="line">        </span><br><span class="line">        Operator toOp = toContext.getFirstOperator();</span><br><span class="line">        OperatorTransition totransition = <span class="keyword">new</span> OperatorTransition(nextStreamName, op, toOp, DistributeType.SHUFFLE, <span class="keyword">null</span>, schema);</span><br><span class="line">        result.addTransitions(totransition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç‰©ç†ä¼˜åŒ–">ç‰©ç†ä¼˜åŒ–</h3><p>æ‹†åˆ†å¹¶ç»„åˆç®—å­å,å› ä¸ºæ¯ä¸ªç®—å­ä¹‹é—´éƒ½é€šè¿‡transitionæ¥è¿æ¥(æ²¡æœ‰é€šè¿‡è¿çº¿è¿æ¥çš„ç®—å­æ˜¯ä¸€ä¸ªå­¤å²›,æ˜¯ä¸ä¼šèµ·ä½œç”¨çš„),æ‰€ä»¥å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–.<br>changeUnionOperators:unionç®—å­æ›¿æ¢å’ŒchangeSchemaAfterAggregate: æ›¿æ¢æ‰€æœ‰çš„havingå’Œorderbyè¿™äº›åœ¨èšåˆä¹‹åçš„è¡¨è¾¾å¼.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhysicOptimizer</span> <span class="keyword">implements</span> <span class="title">Optimizer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Application <span class="title">optimize</span><span class="params">(Application app)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> AggregateConverter().optimize(app);</span><br><span class="line">        <span class="keyword">new</span> FilterPruner().optimize(app);</span><br><span class="line">        <span class="keyword">new</span> SameStreamCombiner().optimize(app);</span><br><span class="line">        <span class="keyword">new</span> SameTransitionPruner().optimize(app);</span><br><span class="line">        <span class="keyword">return</span> app;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
  </div>
  
    
<div class="copyright">
  <p><span>æœ¬æ–‡æ ‡é¢˜:</span><a href="/2015/11/27/2015-11-27-StreamCQL-operator/">StreamCQLæºç é˜…è¯»(3) æ‹†åˆ†ç»„åˆç®—å­</a></p>
  <p><span>æ–‡ç« ä½œè€…:</span><a href="/" title="è®¿é—® ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½ çš„ä¸ªäººåšå®¢">ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½</a></p>
  <p><span>å‘å¸ƒæ—¶é—´:</span>2015å¹´11æœˆ27æ—¥ - 00æ—¶00åˆ†</p>
  <p><span>æœ€åæ›´æ–°:</span>2019å¹´02æœˆ14æ—¥ - 21æ—¶42åˆ†</p>
  <p>
    <span>åŸå§‹é“¾æ¥:</span><a href="/2015/11/27/2015-11-27-StreamCQL-operator/" title="StreamCQLæºç é˜…è¯»(3) æ‹†åˆ†ç»„åˆç®—å­">http://github.com/zqhxuyuan/2015/11/27/2015-11-27-StreamCQL-operator/</a>
    <span class="btn" data-clipboard-text="åŸæ–‡: http://github.com/zqhxuyuan/2015/11/27/2015-11-27-StreamCQL-operator/ã€€ã€€ä½œè€…: ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½" title="ç‚¹å‡»å¤åˆ¶æ–‡ç« é“¾æ¥">
        <i class="fa fa-clipboard"></i>
    </span>
  </p>
  <p><span>è®¸å¯åè®®:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="ä¸­å›½å¤§é™† (CC BY-NC-SA 3.0 CN)">"ç½²å-éå•†ç”¨-ç›¸åŒæ–¹å¼å…±äº« 3.0"</a> è½¬è½½è¯·ä¿ç•™åŸæ–‡é“¾æ¥åŠä½œè€…ã€‚</p>
  <script src="/js/clipboard.min.js"></script>
  <script> var clipboard = new Clipboard('.btn'); </script>
</div>
<style type="text/css">
  .copyright p .btn {
    margin-left: 1em;
  }
  .copyright:hover p .btn::after {
    content: "å¤åˆ¶"
  }
  .copyright p .btn:hover {
      color: gray;
      cursor: pointer;
    };
</style>



<nav id="article-nav">
  
    <div id="article-nav-newer" class="article-nav-title">
      <a href="/2015/11/29/2015-11-29-StreamCQL-application/">
        StreamCQLæºç é˜…è¯»(4) åº”ç”¨ç¨‹åºæ‰§è¡Œ
      </a>
    </div>
  
  
    <div id="article-nav-older" class="article-nav-title">
      <a href="/2015/11/26/2015-11-26-StreamCQL-schema/">
        StreamCQLæºç é˜…è¯»(2) è¯­æ³•å’Œè¯­ä¹‰è§£æ
      </a>
    </div>
  
</nav>

  
  
    <div class="post-donate">
	<br>
	<p>
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="æ‰“èµ"></a>
        <span class="donate_txt">
           &uarr;<br>
		   æ‹›äººå¹¿å‘Šï¼šå¯¹èš‚èšé‡‘æœä¸­é—´ä»¶æ„Ÿå…´è¶£çš„å¯ä»¥å‘é‚®ä»¶åˆ°ï¼šqihuang.zqh at antfin.com
        </span>
        <br>
    </div>  
	<div id="donate_guide" class="donate_bar center hidden">
		<img src="/img/zhifubao.png" alt="æ”¯ä»˜å®æ‰“èµ"> 
		<img src="/img/weixin.png" alt="å¾®ä¿¡æ‰“èµ">  
    </div>
	<script type="text/javascript">
		document.getElementById('btn_donate').onclick = function(){
			$('#donate_board').addClass('hidden');
			$('#donate_guide').removeClass('hidden');
		}
	</script>
</p></div>
  
</article>

<!-- é»˜è®¤æ˜¾ç¤ºæ–‡ç« ç›®å½•ï¼Œåœ¨æ–‡ç« ---å‰è¾“å…¥toc: falseå…³é—­ç›®å½• -->
<!-- Show TOC and tocButton in default, Hide TOC via putting "toc: false" before "---" at [post].md -->
<div id="toc" class="toc-article">
<strong class="toc-title">æ–‡ç« ç›®å½•</strong>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#å‰æˆ:_buildApplication"><span class="toc-number">1.</span> <span class="toc-text">å‰æˆ: buildApplication</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ­£æ–‡:_Split_and_Combine_Operators"><span class="toc-number">2.</span> <span class="toc-text">æ­£æ–‡: Split and Combine Operators</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SourceOperatorSplitter_->_Input/Output_Operator"><span class="toc-number">2.1.</span> <span class="toc-text">SourceOperatorSplitter -&gt; Input/Output Operator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#InsertSplitter_->_Insert_Operator"><span class="toc-number">2.2.</span> <span class="toc-text">InsertSplitter -&gt; Insert Operator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SelectSplitter"><span class="toc-number">2.3.</span> <span class="toc-text">SelectSplitter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AggregateSplitter_->_FilterOp_+_AggregateOp_+_Transition"><span class="toc-number">2.4.</span> <span class="toc-text">AggregateSplitter -&gt; FilterOp + AggregateOp + Transition</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AggregateOperator"><span class="toc-number">2.4.1.</span> <span class="toc-text">AggregateOperator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Transition"><span class="toc-number">2.4.2.</span> <span class="toc-text">Transition</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SplitContext"><span class="toc-number">2.4.3.</span> <span class="toc-text">SplitContext</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OperatorCombiner"><span class="toc-number">2.5.</span> <span class="toc-text">OperatorCombiner</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PipeStream"><span class="toc-number">2.5.1.</span> <span class="toc-text">PipeStream</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#From_&_To_Transition"><span class="toc-number">2.5.2.</span> <span class="toc-text">From &amp; To Transition</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ç‰©ç†ä¼˜åŒ–"><span class="toc-number">2.6.</span> <span class="toc-text">ç‰©ç†ä¼˜åŒ–</span></a></li></ol></li></ol>
</div>
<style type="text/css">
  .left-col .switch-btn {
    display: none;
  }
  .left-col .switch-area {
    display: none;
  }
</style>

<input type="button" id="tocButton" value="éšè—ç›®å½•" title="ç‚¹å‡»æŒ‰é’®éšè—æˆ–è€…æ˜¾ç¤ºæ–‡ç« ç›®å½•">
<script type="text/javascript">
  var toc_button= document.getElementById("tocButton");
  var toc_div= document.getElementById("toc");
  /* Show or hide toc when click on tocButton.
  é€šè¿‡ç‚¹å‡»è®¾ç½®çš„æŒ‰é’®æ˜¾ç¤ºæˆ–è€…éšè—æ–‡ç« ç›®å½•.*/
  toc_button.onclick=function(){
  if(toc_div.style.display=="none"){
  toc_div.style.display="block";
  toc_button.value="éšè—ç›®å½•";
  document.getElementById("switch-btn").style.display="none";
  document.getElementById("switch-area").style.display="none";
  }
  else{
  toc_div.style.display="none";
  toc_button.value="æ˜¾ç¤ºç›®å½•";
  document.getElementById("switch-btn").style.display="block";
  document.getElementById("switch-area").style.display="block";
  }
  }
    if ($(".toc").length < 1) {
        $("#toc").css("display","none");
        $("#tocButton").css("display","none");
        $(".switch-btn").css("display","block");
        $(".switch-area").css("display","block");
    }
</script>


    <style>
        .toc {
            white-space: nowrap;
            overflow-x: hidden;
        }
    </style>

    <script>
        $(document).ready(function() {
            $(".toc li a").mouseover(function() {
                var title = $(this).attr('href');
                $(this).attr("title", title);
            });
        })
    </script>




<div class="share">
	<div class="bdsharebuttonbox">
	<a href="#" class="bds_more" data-cmd="more"></a>
	<a href="#" class="bds_tsina" data-cmd="tsina" title="åˆ†äº«åˆ°æ–°æµªå¾®åš"></a>
	<a href="#" class="bds_sqq" data-cmd="sqq" title="åˆ†äº«ç»™ QQ å¥½å‹"></a>
	<a href="#" class="bds_copy" data-cmd="copy" title="å¤åˆ¶ç½‘å€"></a>
	<a href="#" class="bds_mail" data-cmd="mail" title="é€šè¿‡é‚®ä»¶åˆ†äº«"></a>
	<a href="#" class="bds_weixin" data-cmd="weixin" title="ç”Ÿæˆæ–‡ç« äºŒç»´ç "></a>
	</div>
	<script>
	window._bd_share_config={
		"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	</script>
</div>



<div class="duoshuo" id="comments">
	<!-- å¤šè¯´è¯„è®ºæ¡† start -->
	<div class="ds-thread" data-thread-key="2015/11/27/2015-11-27-StreamCQL-operator/" data-title="StreamCQLæºç é˜…è¯»(3) æ‹†åˆ†ç»„åˆç®—å­" data-url="http://github.com/zqhxuyuan/2015/11/27/2015-11-27-StreamCQL-operator/"></div>
	<!-- å¤šè¯´è¯„è®ºæ¡† end -->
	<!-- å¤šè¯´å…¬å…±JSä»£ç  start (ä¸€ä¸ªç½‘é¡µåªéœ€æ’å…¥ä¸€æ¬¡) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"zqhxuyuan"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- å¤šè¯´å…¬å…±JSä»£ç  end -->
</div>






    <style type="text/css">
    #scroll {
      display: none;
    }
    </style>
    <div class="scroll">
    <a href="#" title="è¿”å›é¡¶éƒ¨"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="æŸ¥çœ‹è¯„è®º"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="è½¬åˆ°åº•éƒ¨"><i class="fa fa-arrow-down"></i></a>
    </div>


  
  
    
    <div class="post-nav-button">
    <a href="/2015/11/29/2015-11-29-StreamCQL-application/" title="ä¸Šä¸€ç¯‡: StreamCQLæºç é˜…è¯»(4) åº”ç”¨ç¨‹åºæ‰§è¡Œ">
    <i class="fa fa-angle-left"></i>
    </a>
    <a href="/2015/11/26/2015-11-26-StreamCQL-schema/" title="ä¸‹ä¸€ç¯‡: StreamCQLæºç é˜…è¯»(2) è¯­æ³•å’Œè¯­ä¹‰è§£æ">
    <i class="fa fa-angle-right"></i>
    </a>
    </div>
  



    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2019 ä»»ä½•å¿§ä¼¤,éƒ½æŠµä¸è¿‡ä¸–ç•Œçš„ç¾ä¸½
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank" title="å¿«é€Ÿã€ç®€æ´ä¸”é«˜æ•ˆçš„é™æ€åšå®¢æ¡†æ¶">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="ç®€è€Œä¸å‡åŒæ  Hexo åšå®¢ä¸»é¢˜">Yelee</a> by MOxFIVE
        </div>
    </div>
    <div class="visit">
      <span id="busuanzi_container_site_pv" style="display:none">
        <span id="site-visit">æœ¬ç«™åˆ°è®¿æ•°: 
        <span id="busuanzi_value_site_uv"></span>
        </span>
      </span>
      <span id="busuanzi_container_page_pv" style="display:none">
        <span id="page-visit">, æœ¬é¡µé˜…è¯»é‡: 
        <span id="busuanzi_value_page_pv"></span>
        </span>
      </span>
    </div>
  </div>
</footer>
    </div>
    

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

<script>
  var backgroundnum = 5;
  var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));

  $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
</script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-80646710-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
<a href="#" title="è¿”å›é¡¶éƒ¨"><i class="fa fa-arrow-up"></i></a>
<a href="#footer" title="è½¬åˆ°åº•éƒ¨"><i class="fa fa-arrow-down"></i></a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>