<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>Apache Drill源码阅读(1) 环境准备和查看日志 | zqhxuyuan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="大数据源码阅读系列之ApacheDrill: 通过日志分析Apache Drill的主要流程">
<meta name="keywords" content="drill">
<meta property="og:type" content="article">
<meta property="og:title" content="Apache Drill源码阅读(1) 环境准备和查看日志">
<meta property="og:url" content="http://github.com/zqhxuyuan/2015/07/10/2015-07-10-drill-log/index.html">
<meta property="og:site_name" content="zqhxuyuan">
<meta property="og:description" content="大数据源码阅读系列之ApacheDrill: 通过日志分析Apache Drill的主要流程">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://7xjs7x.com1.z0.glb.clouddn.com/drill1.png">
<meta property="og:image" content="http://7xjs7x.com1.z0.glb.clouddn.com/drill2.png">
<meta property="og:image" content="http://drill.apache.org/docs/img/client-phys-plan.png">
<meta property="og:image" content="http://drill.apache.org/docs/img/slide-15-638.png">
<meta property="og:image" content="http://7xjs7x.com1.z0.glb.clouddn.com/drill3.png">
<meta property="og:image" content="http://7xjs7x.com1.z0.glb.clouddn.com/drill5.png">
<meta property="og:image" content="http://7xjs7x.com1.z0.glb.clouddn.com/drill4.png">
<meta property="og:updated_time" content="2019-02-14T13:42:29.173Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Apache Drill源码阅读(1) 环境准备和查看日志">
<meta name="twitter:description" content="大数据源码阅读系列之ApacheDrill: 通过日志分析Apache Drill的主要流程">
<meta name="twitter:image" content="http://7xjs7x.com1.z0.glb.clouddn.com/drill1.png">
  
    <link rel="alternative" href="/atom.xml" title="zqhxuyuan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">任何忧伤,都抵不过世界的美丽</a></h1>
		</hgroup>

		
				


		
			<div id="switch-btn" class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div id="switch-area" class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives/">归档</a></li>
				        
							<li><a href="/tags/">标签</a></li>
				        
							<li><a href="/about/">关于</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
								<li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
					        
						</ul>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/apex/" style="font-size: 10px;">apex</a> <a href="/tags/bigdata/" style="font-size: 10px;">bigdata</a> <a href="/tags/book/" style="font-size: 10px;">book</a> <a href="/tags/cassandra/" style="font-size: 18.89px;">cassandra</a> <a href="/tags/clojure/" style="font-size: 10px;">clojure</a> <a href="/tags/drill/" style="font-size: 16.67px;">drill</a> <a href="/tags/druid/" style="font-size: 13.33px;">druid</a> <a href="/tags/dubbo/" style="font-size: 10px;">dubbo</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/etl/" style="font-size: 10px;">etl</a> <a href="/tags/geode/" style="font-size: 10px;">geode</a> <a href="/tags/graph/" style="font-size: 12.22px;">graph</a> <a href="/tags/hadoop/" style="font-size: 11.11px;">hadoop</a> <a href="/tags/hbase/" style="font-size: 15.56px;">hbase</a> <a href="/tags/ignite/" style="font-size: 10px;">ignite</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/tags/kafka/" style="font-size: 20px;">kafka</a> <a href="/tags/midd/" style="font-size: 10px;">midd</a> <a href="/tags/ops/" style="font-size: 12.22px;">ops</a> <a href="/tags/redis/" style="font-size: 11.11px;">redis</a> <a href="/tags/rocketmq/" style="font-size: 10px;">rocketmq</a> <a href="/tags/scala/" style="font-size: 13.33px;">scala</a> <a href="/tags/spark/" style="font-size: 17.78px;">spark</a> <a href="/tags/storm/" style="font-size: 17.78px;">storm</a> <a href="/tags/tcc/" style="font-size: 10px;">tcc</a> <a href="/tags/timeseries/" style="font-size: 12.22px;">timeseries</a> <a href="/tags/work/" style="font-size: 14.44px;">work</a> <a href="/tags/流处理/" style="font-size: 11.11px;">流处理</a>
					</div>
				</section>
				
				
				

				
				
				<section class="switch-part switch-part3">
				
					<div id="js-aboutme">BIG(DATA)</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<a href="/" class="profilepic">
				<img lazy-src="https://avatars1.githubusercontent.com/u/1088525?v=3&amp;s=180" class="js-avatar">
			</a>
			<hgroup>
			  <h1 class="header-author"><a href="/" title="回到主页">任何忧伤,都抵不过世界的美丽</a></h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives/">归档</a></li>
		        
					<li><a href="/tags/">标签</a></li>
		        
					<li><a href="/about/">关于</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
						<ul class="social">
							
								<li id="新浪微博"><a class="新浪微博" target="_blank" href="http://weibo.com/xuyuantree" title="新浪微博"></a></li>
					        
								<li id="GitHub"><a class="GitHub" target="_blank" href="http://github.com/zqhxuyuan" title="GitHub"></a></li>
					        
								<li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
					        
						</ul>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-2015-07-10-drill-log" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/07/10/2015-07-10-drill-log/" class="article-date">
  	<time datetime="2015-07-09T16:00:00.000Z" itemprop="datePublished">2015-07-10</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Apache Drill源码阅读(1) 环境准备和查看日志
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/Source/">Source</a>
	</div>


        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/drill/">drill</a></li></ul>
	</div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <p>大数据源码阅读系列之ApacheDrill: 通过日志分析Apache Drill的主要流程</p>
<a id="more"></a>
<h2 id="准备工作">准备工作</h2><p>修改logback.xml的日志级别为debug</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;logger name=&quot;org.apache.drill&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">  &lt;level value=&quot;debug&quot; /&gt;</span><br><span class="line">  &lt;appender-ref ref=&quot;FILE&quot; /&gt;</span><br><span class="line">&lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">&lt;logger name=&quot;query.logger&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">  &lt;level value=&quot;debug&quot; /&gt;</span><br><span class="line">  &lt;appender-ref ref=&quot;QUERY&quot; /&gt;</span><br><span class="line">&lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">&lt;root&gt;</span><br><span class="line">  &lt;level value=&quot;debug&quot; /&gt;</span><br><span class="line">  &lt;appender-ref ref=&quot;STDOUT&quot; /&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure>
<p>使用单机模式,而不是集群模式. 启动<code>drill-embedded</code>  </p>
<p>除了在上面的drill-embedded观察输出, 还要观察log目录下的sqlline.log文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">2015-07-10 11:11:41,636 [main] DEBUG o.apache.drill.exec.server.Drillbit - Construction started.</span><br><span class="line">2015-07-10 11:11:42,481 [main] INFO  o.apache.drill.exec.server.Drillbit - Construction completed (845 ms).</span><br><span class="line">2015-07-10 11:11:42,481 [main] DEBUG o.apache.drill.exec.server.Drillbit - Startup begun.</span><br><span class="line">2015-07-10 11:11:42,481 [main] DEBUG o.a.d.e.c.l.LocalClusterCoordinator - Local Cluster Coordinator started.</span><br><span class="line">2015-07-10 11:11:42,607 [main] DEBUG o.a.drill.exec.rpc.user.UserServer - Server of type UserServer started on port 31010.</span><br><span class="line">2015-07-10 11:11:42,650 [main] DEBUG o.a.d.exec.rpc.control.ControlServer - Server of type ControlServer started on port 31011.</span><br><span class="line">2015-07-10 11:11:42,688 [main] DEBUG o.a.drill.exec.rpc.data.DataServer - Server of type DataServer started on port 31012.</span><br><span class="line">2015-07-10 11:11:42,924 [main] DEBUG o.a.drill.common.util.PathScanner - Classpath scanning took 60ms</span><br><span class="line">2015-07-10 11:11:42,924 [main] DEBUG o.a.d.e.p.base.PhysicalOperatorUtil - Adding Physical Operator sub types: .................</span><br><span class="line">2015-07-10 11:11:43,047 [main] DEBUG org.apache.drill.common.JSONOptions - Creating Deserializer.</span><br><span class="line">2015-07-10 11:11:43,146 [main] DEBUG o.a.d.e.p.i.OperatorCreatorRegistry - Adding Operator Creator map:..............</span><br><span class="line">2015-07-10 11:11:43,385 [main] DEBUG o.a.d.e.e.f.FunctionImplementationRegistry - Generating function registry.</span><br><span class="line">2015-07-10 11:11:48,643 [main] DEBUG o.a.d.e.s.h.HBaseStoragePluginConfig - Initializing HBase StoragePlugin configuration with zookeeper quorum &apos;localhost&apos;, port &apos;2181&apos;.</span><br><span class="line">2015-07-10 11:11:48,977 [main] DEBUG o.a.d.e.c.l.LocalClusterCoordinator - Endpoint registered address: &quot;localhost&quot;</span><br><span class="line">user_port: 31010</span><br><span class="line">control_port: 31011</span><br><span class="line">data_port: 31012</span><br><span class="line">.</span><br><span class="line">2015-07-10 11:11:51,700 [main] INFO  o.apache.drill.exec.server.Drillbit - Startup completed (9218 ms).</span><br><span class="line">2015-07-10 11:11:51,741 [main] DEBUG o.a.drill.exec.client.DrillClient - Connecting to server localhost:31010</span><br></pre></td></tr></table></figure>
<p>可以看到命令行执行drill-embedded, 会连接到本地的Drill Server上.</p>
<p>在sqlline上执行一条SQL命令, 可以看到最终调用的是FragmentExecutor线程的run方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:drill:zk=local&gt; select count(*) from cp.`employee.json`;</span><br><span class="line">11:22:02.300 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.h.security.UserGroupInformation - PrivilegedAction as:zhengqh (auth:SIMPLE) from:org.apache.drill.exec.util.ImpersonationUtil.createFileSystem(ImpersonationUtil.java:141)</span><br><span class="line">11:22:02.390 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.h.security.UserGroupInformation - PrivilegedAction as:zhengqh (auth:SIMPLE) from:org.apache.drill.exec.work.fragment.FragmentExecutor.run(FragmentExecutor.java:255)</span><br><span class="line">+---------+</span><br><span class="line">| EXPR$0  |</span><br><span class="line">+---------+</span><br><span class="line">| 1155    |</span><br><span class="line">+---------+</span><br><span class="line">1 row selected (0.221 seconds)</span><br></pre></td></tr></table></figure>
<h2 id="日志分析">日志分析</h2><p>sqlline.log日志我们一段一段地分析</p>
<p>首先注册查询语句, 即在sqlline输入的sql语句, 会分配一个query-id. 访问<a href="http://localhost:8047/profiles" target="_blank" rel="noopener">http://localhost:8047/profiles</a>可以找到这个Query Job.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2015-07-10 11:22:02,257 [main] DEBUG o.a.d.j.impl.DrillStatementRegistry - Adding to open-statements registry: org.apache.drill.jdbc.impl.DrillStatementImpl@4eb2bb3d</span><br><span class="line">2015-07-10 11:22:02,258 [main] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [#3] Query listener created.</span><br><span class="line">2015-07-10 11:22:02,259 [UserServer-1] DEBUG o.a.drill.exec.rpc.user.UserServer - Received query to run.  Returning query handle.</span><br><span class="line">2015-07-10 11:22:02,273 [UserServer-1] DEBUG o.a.d.exec.memory.TopLevelAllocator - New child allocator with initial reservation 1048576</span><br><span class="line">2015-07-10 11:22:02,274 [UserServer-1] DEBUG o.a.drill.exec.rpc.user.UserServer - Sending response with Sender 575856913</span><br><span class="line">2015-07-10 11:22:02,275 [Client-1] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [#3] Received query ID: 2a60c5a4-e01a-ac02-84fd-a01023a1319a.</span><br><span class="line">2015-07-10 11:22:02,276 [Client-1] DEBUG o.a.d.e.rpc.user.QueryResultHandler - Received QueryId 2a60c5a4-e01a-ac02-84fd-a01023a1319a successfully. Adding results listener org.apache.drill.jdbc.impl.DrillResultSetImpl$ResultsListener@6f3634b1.</span><br></pre></td></tr></table></figure>
<p>使用了Optiq生成Logical逻辑计划, 查看SQL语句对应的逻辑计划/物理计划是从下到上的, 比如下面的TableScan-&gt;Project-&gt;Aggregate<br>对于<code>SELECT COUNT(COLUMN) FOME TABLE</code>, 实际上逻辑计划的顺序是:<br>FROM TABLE(TableScan扫描) -&gt; SELECT COLUMN(Project映射) -&gt; COUNT(Aggregate聚合计算)  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2015-07-10 11:22:02,315 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.p.s.h.DefaultSqlHandler - Optiq Logical :</span><br><span class="line">LogicalAggregate(group=[&#123;&#125;], EXPR$0=[COUNT()]): rowcount = 10.0, cumulative cost = &#123;211.25 rows, 201.0 cpu, 0.0 io, 0.0 network, 0.0 memory&#125;, id = 211</span><br><span class="line">  LogicalProject($f0=[0]): rowcount = 100.0, cumulative cost = &#123;200.0 rows, 201.0 cpu, 0.0 io, 0.0 network, 0.0 memory&#125;, id = 209</span><br><span class="line">    EnumerableTableScan(table=[[cp, employee.json]]): rowcount = 100.0, cumulative cost = &#123;100.0 rows, 101.0 cpu, 0.0 io, 0.0 network, 0.0 memory&#125;, id = 205</span><br></pre></td></tr></table></figure>
<p>Optiq的逻辑计划最终会形成Drill的逻辑计划,再到Drill的物理计划: Drill Logial -&gt; Drill Physical的过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">2015-07-10 11:22:02,320 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.BlockMapBuilder - Took 0 ms to build endpoint map</span><br><span class="line">2015-07-10 11:22:02,323 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.BlockMapBuilder - FileWork group (classpath:/employee.json,0) max bytes 474631</span><br><span class="line">2015-07-10 11:22:02,323 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.BlockMapBuilder - Took 2 ms to set endpoint bytes</span><br><span class="line">2015-07-10 11:22:02,323 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] INFO  o.a.d.e.s.schedule.BlockMapBuilder - Get block maps: Executed 1 out of 1 using 1 threads. Time: 2ms total, 2.240000ms avg, 2ms max.</span><br><span class="line">2015-07-10 11:22:02,323 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] INFO  o.a.d.e.s.schedule.BlockMapBuilder - Get block maps: Executed 1 out of 1 using 1 threads. Earliest start: 1.000000 μs, Latest start: 1.000000 μs, Average start: 1.000000 μs .</span><br><span class="line"></span><br><span class="line">2015-07-10 11:22:02,324 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.AffinityCreator - Work: [File: classpath:/employee.json start: 0 length: 474630] Endpoint: localhost Bytes: 474630</span><br><span class="line">2015-07-10 11:22:02,324 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.AffinityCreator - Endpoint localhost has affinity 1.0</span><br><span class="line">2015-07-10 11:22:02,324 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.AffinityCreator - Took 0 ms to get operator affinity</span><br><span class="line">2015-07-10 11:22:02,329 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.p.s.h.DefaultSqlHandler - VolCalciteRel :</span><br><span class="line">2015-07-10 11:22:02,331 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.p.s.h.DefaultSqlHandler - HepCalciteRel :</span><br><span class="line">2015-07-10 11:22:02,333 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.p.s.h.DefaultSqlHandler - Drill Logical :</span><br><span class="line">DrillScreenRel: rowcount = 1.0, cumulative cost = &#123;927.1 rows, 1853.1 cpu, 0.0 io, 0.0 network, 0.0 memory&#125;, id = 239</span><br><span class="line">  DrillAggregateRel(group=[&#123;&#125;], EXPR$0=[COUNT()]): rowcount = 1.0, cumulative cost = &#123;927.0 rows, 1853.0 cpu, 0.0 io, 0.0 network, 0.0 memory&#125;, id = 236</span><br><span class="line">    DrillProjectRel($f0=[0]): rowcount = 463.0, cumulative cost = &#123;926.0 rows, 1852.0 cpu, 0.0 io, 0.0 network, 0.0 memory&#125;, id = 234</span><br><span class="line">      DrillScanRel(table=[[cp, employee.json]], groupscan=[EasyGroupScan [selectionRoot=classpath:/employee.json, numFiles=1, columns=[`*`], files=[classpath:/employee.json]]]): rowcount = 463.0, cumulative cost = &#123;463.0 rows, 0.0 cpu, 0.0 io, 0.0 network, 0.0 memory&#125;, id = 222</span><br><span class="line"></span><br><span class="line">2015-07-10 11:22:02,368 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.p.s.h.DefaultSqlHandler - Drill Physical :</span><br><span class="line">00-00    Screen : rowType = RecordType(BIGINT EXPR$0): rowcount = 1.0, cumulative cost = &#123;1389.1 rows, 7408.1 cpu, 0.0 io, 0.0 network, 0.0 memory&#125;, id = 317</span><br><span class="line">00-01      StreamAgg(group=[&#123;&#125;], EXPR$0=[COUNT()]) : rowType = RecordType(BIGINT EXPR$0): rowcount = 1.0, cumulative cost = &#123;1389.0 rows, 7408.0 cpu, 0.0 io, 0.0 network, 0.0 memory&#125;, id = 316</span><br><span class="line">00-02        Project($f0=[0]) : rowType = RecordType(INTEGER $f0): rowcount = 463.0, cumulative cost = &#123;926.0 rows, 1852.0 cpu, 0.0 io, 0.0 network, 0.0 memory&#125;, id = 315</span><br><span class="line">00-03          Scan(groupscan=[EasyGroupScan [selectionRoot=classpath:/employee.json, numFiles=1, columns=[`*`], files=[classpath:/employee.json]]]) : rowType = RecordType(): rowcount = 463.0, cumulative cost = &#123;463.0 rows, 0.0 cpu, 0.0 io, 0.0 network, 0.0 memory&#125;, id = 314</span><br></pre></td></tr></table></figure>
<p>访问<a href="http://localhost:8047/profiles/2a60c5a4-e01a-ac02-84fd-a01023a1319a" target="_blank" rel="noopener">http://localhost:8047/profiles/2a60c5a4-e01a-ac02-84fd-a01023a1319a</a>查看这个作业的物理计划<br>可以看到物理计划从下到上的顺序是: Scan-&gt;Project-&gt;StreamAgg. 因为物理计划实际上是从逻辑计划计算出来的.    </p>
<p>然后会输出详细的json格式的计划.  graph有几个字段pop代表操作类型,@id是编号,child是VisualizedPlan树从上到下第几层.<br>graph域的fs-scan代表扫描文件系统,扫描所有列*; project映射字段,$f0实际上就是columns中的第一个字段;<br>streaming-aggregate的计算表达式count(1), 最后通过screen输出    </p>
<p>我们先看一下Web页面的可视化计划数, 先来个比较直观的映象<br>以Scan 00-03为例,00是major id,03是fs-scan的@id=3</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill1.png" alt></p>
<p>下面不同的pop,对应的metadata也不一样, 比如project映射需要表达式,因为选择一个列,是可以在列上做计算的  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">2015-07-10 11:22:02,370 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.p.s.h.DefaultSqlHandler - Drill Plan :</span><br><span class="line">&#123;</span><br><span class="line">  &quot;head&quot; : &#123;</span><br><span class="line">    &quot;version&quot; : 1,</span><br><span class="line">    &quot;generator&quot; : &#123;</span><br><span class="line">      &quot;type&quot; : &quot;DefaultSqlHandler&quot;,</span><br><span class="line">      &quot;info&quot; : &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;type&quot; : &quot;APACHE_DRILL_PHYSICAL&quot;,</span><br><span class="line">    &quot;options&quot; : [ ],</span><br><span class="line">    &quot;queue&quot; : 0,</span><br><span class="line">    &quot;resultMode&quot; : &quot;EXEC&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;graph&quot; : [ &#123;</span><br><span class="line">    &quot;pop&quot; : &quot;fs-scan&quot;,</span><br><span class="line">    &quot;@id&quot; : 3,</span><br><span class="line">    &quot;userName&quot; : &quot;zhengqh&quot;,</span><br><span class="line">    &quot;files&quot; : [ &quot;classpath:/employee.json&quot; ],</span><br><span class="line">    ...</span><br><span class="line">    &quot;columns&quot; : [ &quot;`*`&quot; ],</span><br><span class="line">    &quot;selectionRoot&quot; : &quot;classpath:/employee.json&quot;,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    &quot;pop&quot; : &quot;project&quot;,</span><br><span class="line">    &quot;@id&quot; : 2,</span><br><span class="line">    &quot;exprs&quot; : [ &#123;</span><br><span class="line">      &quot;ref&quot; : &quot;`$f0`&quot;,</span><br><span class="line">      &quot;expr&quot; : &quot;0&quot;</span><br><span class="line">    &#125; ],</span><br><span class="line">    &quot;child&quot; : 3</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    &quot;pop&quot; : &quot;streaming-aggregate&quot;,</span><br><span class="line">    &quot;@id&quot; : 1,</span><br><span class="line">    &quot;child&quot; : 2,</span><br><span class="line">    &quot;keys&quot; : [ ],</span><br><span class="line">    &quot;exprs&quot; : [ &#123;</span><br><span class="line">      &quot;ref&quot; : &quot;`EXPR$0`&quot;,</span><br><span class="line">      &quot;expr&quot; : &quot;count(1) &quot;</span><br><span class="line">    &#125; ]</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    &quot;pop&quot; : &quot;screen&quot;,</span><br><span class="line">    &quot;@id&quot; : 0,</span><br><span class="line">    &quot;child&quot; : 1</span><br><span class="line">  &#125; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Drill的执行引擎会将逻辑计划组成一个Fragment树. 下面是Root Fragment.<br>对照WebUI, 这个Query在本地测试时,只生成了一个Fragment.<br>Root Fragment的major和minor id都是0.  下面的fragment_json和上面graph不同的是它是嵌套的.  </p>
<blockquote>
<p>为什么可视化的Plan对应的graph是扁平的,而Root Fragment是嵌套的?<br>可以这么理解: 如果图的结构是嵌套的,那么就要在Screen这个组件里画上streaming-aggregate<br>并在streaming-aggregate里再画上project,以此类推,就不叫图了,图是一个DAG有向无环图.<br>而树如果是扁平的,则只能像上面的图一样一直下去,没有分支. 使用嵌套,就有了分支的概念了.  </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">2015-07-10 11:22:02,372 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.s.schedule.AssignmentCreator - Took 0 ms to assign 1 work units to 1 fragments</span><br><span class="line">2015-07-10 11:22:02,378 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.p.f.SimpleParallelizer - Root fragment:</span><br><span class="line"> handle &#123;</span><br><span class="line">  query_id &#123;</span><br><span class="line">    part1: 3053657859282349058</span><br><span class="line">    part2: -8863752500417580646</span><br><span class="line">  &#125;</span><br><span class="line">  major_fragment_id: 0</span><br><span class="line">  minor_fragment_id: 0</span><br><span class="line">&#125;</span><br><span class="line">fragment_json: &quot;&#123;</span><br><span class="line">  &quot;pop&quot; : &quot;screen&quot;,</span><br><span class="line">  &quot;@id&quot; : 0,</span><br><span class="line">  &quot;child&quot; : &#123;</span><br><span class="line">    &quot;pop&quot; : &quot;streaming-aggregate&quot;,</span><br><span class="line">    &quot;@id&quot; : 1,</span><br><span class="line">    &quot;child&quot; : &#123;</span><br><span class="line">      &quot;pop&quot; : &quot;project&quot;,</span><br><span class="line">      &quot;@id&quot; : 2,</span><br><span class="line">      &quot;exprs&quot; : [ &#123;</span><br><span class="line">        &quot;ref&quot; : &quot;`$f0`&quot;,</span><br><span class="line">        &quot;expr&quot; : &quot;0&quot;</span><br><span class="line">      &#125; ],</span><br><span class="line">      &quot;child&quot; : &#123;</span><br><span class="line">        &quot;pop&quot; : &quot;fs-sub-scan&quot;,</span><br><span class="line">        &quot;@id&quot; : 3,</span><br><span class="line">        &quot;userName&quot; : &quot;zhengqh&quot;,</span><br><span class="line">        &quot;files&quot; : [ &#123;</span><br><span class="line">          &quot;start&quot; : 0,</span><br><span class="line">          &quot;length&quot; : 474630,</span><br><span class="line">          &quot;path&quot; : &quot;classpath:/employee.json&quot;</span><br><span class="line">        &#125; ],</span><br><span class="line">        &quot;columns&quot; : [ &quot;`*`&quot; ],</span><br><span class="line">        &quot;selectionRoot&quot; : &quot;classpath:/employee.json&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;initialAllocation&quot; : 1000000,</span><br><span class="line">      &quot;maxAllocation&quot; : 10000000000,</span><br><span class="line">      &quot;cost&quot; : 463.0</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;keys&quot; : [ ],</span><br><span class="line">    &quot;exprs&quot; : [ &#123;</span><br><span class="line">      &quot;ref&quot; : &quot;`EXPR$0`&quot;,</span><br><span class="line">      &quot;expr&quot; : &quot;count(1) &quot;</span><br><span class="line">    &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&quot;</span><br><span class="line">leaf_fragment: true</span><br><span class="line">assignment &#123;</span><br><span class="line">  address: &quot;localhost&quot;</span><br><span class="line">  user_port: 31010</span><br><span class="line">  control_port: 31011</span><br><span class="line">  data_port: 31012</span><br><span class="line">&#125;</span><br><span class="line">foreman &#123;</span><br><span class="line">  address: &quot;localhost&quot;</span><br><span class="line">  user_port: 31010</span><br><span class="line">  control_port: 31011</span><br><span class="line">  data_port: 31012</span><br><span class="line">&#125;</span><br><span class="line">mem_initial: 3000000</span><br><span class="line">mem_max: 30000000000</span><br><span class="line">credentials &#123;</span><br><span class="line">  user_name: &quot;anonymous&quot;</span><br><span class="line">&#125;</span><br><span class="line">options_json: &quot;[ ]&quot;</span><br><span class="line">context &#123;</span><br><span class="line">  query_start_time: 1436498522273</span><br><span class="line">  time_zone: 299</span><br><span class="line">  default_schema_name: &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面和fragment_json同级的还有foreman,表示接受客户端查询作业的节点, 因为是本地模式,所以是localhost.<br>初始化内存mem_initial和最大内存mem_max在FragmentContext中.  </p>
<p>Fragment提交到Foreman后, 查询开始运行, Foreman的状态从PENDING到RUNNING, FragmentExecutor从AWAITING_ALLOCATION到RUNNING.<br>这里有个比较重要的概念是通过ImplCreator创建的RecordBatch Tree.       </p>
<blockquote>
<p>上面我们已经有了Root Fragment形成的Tree的概念. 这里批记录还有树.<br>什么是RecordBatch,顾名思义是批记录. 那为什么又有树的概念?  </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2015-07-10 11:22:02,378 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.exec.rpc.control.WorkEventBus - Adding fragment status listener for queryId 2a60c5a4-e01a-ac02-84fd-a01023a1319a.</span><br><span class="line">2015-07-10 11:22:02,378 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.drill.exec.work.foreman.Foreman - Submitting fragments to run.</span><br><span class="line">2015-07-10 11:22:02,378 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.drill.exec.ops.FragmentContext - Getting initial memory allocation of 3000000</span><br><span class="line">2015-07-10 11:22:02,378 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.drill.exec.ops.FragmentContext - Fragment max allocation: 30000000000</span><br><span class="line">2015-07-10 11:22:02,378 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.exec.memory.TopLevelAllocator - New child allocator with initial reservation 3000000</span><br><span class="line">2015-07-10 11:22:02,379 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.d.e.work.batch.IncomingBuffers - Came up with a list of 0 required fragments.  Fragments &#123;&#125;</span><br><span class="line">2015-07-10 11:22:02,380 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] INFO  o.a.drill.exec.work.foreman.Foreman - State change requested.  PENDING --&gt; RUNNING</span><br><span class="line">2015-07-10 11:22:02,381 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:foreman] DEBUG o.a.drill.exec.work.foreman.Foreman - Fragments running.</span><br><span class="line">2015-07-10 11:22:02,381 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.memory.BufferAllocator - New child allocator with initial reservation 1000000</span><br><span class="line">2015-07-10 11:22:02,387 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.memory.BufferAllocator - New child allocator with initial reservation 1000000</span><br><span class="line">2015-07-10 11:22:02,387 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.memory.BufferAllocator - New child allocator with initial reservation 1000000</span><br><span class="line">2015-07-10 11:22:02,388 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.memory.BufferAllocator - New child allocator with initial reservation 1000000</span><br><span class="line">2015-07-10 11:22:02,388 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.physical.impl.ImplCreator - Took 7 ms to create RecordBatch tree</span><br><span class="line">2015-07-10 11:22:02,388 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] INFO  o.a.d.e.w.fragment.FragmentExecutor - 2a60c5a4-e01a-ac02-84fd-a01023a1319a:0:0: State change requested from AWAITING_ALLOCATION --&gt; RUNNING for</span><br><span class="line">2015-07-10 11:22:02,388 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] INFO  o.a.d.e.w.f.AbstractStatusReporter - State changed for 2a60c5a4-e01a-ac02-84fd-a01023a1319a:0:0. New state: RUNNING</span><br></pre></td></tr></table></figure>
<p>Fragment的状态会被QueryManager管理, 其中operator_profile是操作算子的选项, 包括了一些字段input_profile, 操作算子id, 操作类型等等.<br>什么是profile, 其实WEB页面<a href="http://localhost:8047/profiles" target="_blank" rel="noopener">http://localhost:8047/profiles</a>就是Drill查询作业运行时的profile收集页面.<br>包括了Query Profile, Fragment Profiles,Operator Profiles,Full JSON Profile.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">2015-07-10 11:22:02,389 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.w.f.NonRootStatusReporter - Sending status change message message to remote node: profile &#123;</span><br><span class="line">  state: RUNNING</span><br><span class="line">  minor_fragment_id: 0</span><br><span class="line">  operator_profile &#123;</span><br><span class="line">    input_profile &#123;</span><br><span class="line">      records: 0</span><br><span class="line">      batches: 0</span><br><span class="line">      schemas: 0</span><br><span class="line">    &#125;</span><br><span class="line">    operator_id: 3</span><br><span class="line">    operator_type: 29</span><br><span class="line">    setup_nanos: 0</span><br><span class="line">    process_nanos: 4651000</span><br><span class="line">    peak_local_memory_allocated: 0</span><br><span class="line">    wait_nanos: 3000</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">2015-07-10 11:22:02,390 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.w.fragment.FragmentExecutor - Starting fragment 0:0 on localhost:31010</span><br><span class="line">2015-07-10 11:22:02,392 [BitServer-4] DEBUG o.a.d.exec.work.foreman.QueryManager - New fragment status was provided to QueryManager of profile &#123;</span><br></pre></td></tr></table></figure>
<p>上面提到的RecordBatch在下面有几个实现类: ProjectRecordBatch, StreamingAggBatch.</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill2.png" alt>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2015-07-10 11:22:02,392 [BitServer-4] DEBUG o.a.d.exec.rpc.control.ControlServer - Sending response with Sender 762133699</span><br><span class="line">2015-07-10 11:22:02,408 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.p.i.p.ProjectRecordBatch - Added eval for project expression.</span><br><span class="line">2015-07-10 11:22:02,410 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.p.i.a.StreamingAggBatch - Creating new aggregator.</span><br><span class="line">2015-07-10 11:22:02,413 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.p.i.a.StreamingAggBatch - Next outcome of OK_NEW_SCHEMA</span><br><span class="line">2015-07-10 11:22:02,413 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.p.i.a.StreamingAggBatch - Creating new aggregator.</span><br><span class="line"></span><br><span class="line">+++++++++++++batch1+++++++++++++</span><br><span class="line">2015-07-10 11:22:02,414 [Client-1] DEBUG o.a.d.e.rpc.user.QueryResultHandler - batchArrived: queryId = part1: 3053657859282349058 part2: -8863752500417580646</span><br><span class="line">2015-07-10 11:22:02,415 [Client-1] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [#3] Received query data batch #1: QueryResultBatch [header=query_id &#123;</span><br><span class="line">2015-07-10 11:22:02,415 [Client-1] DEBUG o.a.drill.exec.rpc.user.UserClient - Sending response with Sender 955795882</span><br><span class="line">2015-07-10 11:22:02,416 [main] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [#3] Dequeued query data batch #1: QueryResultBatch [header=query_id &#123;</span><br></pre></td></tr></table></figure>
<p>上面的batchArrived表示批记录到来, 那么接下去就是处理到来的数据了:<br>对于batch, 总是先<code>Received query data batch, 然后</code>Sending response with Sender,<br>最后<code>Dequeued query data batch</code>. 很显然query data batch会在队列中进进出出.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+++++++++++++batch2+++++++++++++</span><br><span class="line">2015-07-10 11:22:02,419 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.p.i.a.StreamingAggBatch - Aggregator response RETURN_OUTCOME, records 1</span><br><span class="line">2015-07-10 11:22:02,419 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.p.i.a.StreamingAggBatch - Aggregator response CLEANUP_AND_RETURN, records 1</span><br><span class="line"></span><br><span class="line">2015-07-10 11:22:02,421 [Client-1] DEBUG o.a.d.e.rpc.user.QueryResultHandler - batchArrived: queryId = part1: 3053657859282349058 part2: -8863752500417580646</span><br><span class="line">2015-07-10 11:22:02,421 [Client-1] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [#3] Received query data batch #2: QueryResultBatch [header=query_id &#123;</span><br><span class="line">2015-07-10 11:22:02,421 [Client-1] DEBUG o.a.drill.exec.rpc.user.UserClient - Sending response with Sender 1000578767</span><br><span class="line">2015-07-10 11:22:02,422 [main] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [#3] Dequeued query data batch #2: QueryResultBatch [header=query_id &#123;</span><br></pre></td></tr></table></figure>
<p>计算完成, 关闭上下文, FragmentExecutor的状态从RUNNING到FINISHED.  同样也会打印profile.<br>这里我们终于看到了1155这个Query计算出来的结果了.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">2015-07-10 11:22:02,423 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.ops.OperatorContextImpl - Closing context for org.apache.drill.exec.store.dfs.easy.EasySubScan</span><br><span class="line">2015-07-10 11:22:02,423 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.ops.OperatorContextImpl - Closing context for org.apache.drill.exec.physical.config.Project</span><br><span class="line">2015-07-10 11:22:02,423 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.ops.OperatorContextImpl - Closing context for org.apache.drill.exec.physical.config.StreamingAggregate</span><br><span class="line">2015-07-10 11:22:02,423 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.exec.ops.OperatorContextImpl - Closing context for org.apache.drill.exec.physical.config.Screen</span><br><span class="line">2015-07-10 11:22:02,423 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.apache.drill.exec.memory.Accountor - Fragment 0:0  accountor being closed</span><br><span class="line">2015-07-10 11:22:02,423 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] INFO  o.a.d.e.w.fragment.FragmentExecutor - 2a60c5a4-e01a-ac02-84fd-a01023a1319a:0:0: State change requested from RUNNING --&gt; FINISHED for</span><br><span class="line">2015-07-10 11:22:02,423 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] INFO  o.a.d.e.w.f.AbstractStatusReporter - State changed for 2a60c5a4-e01a-ac02-84fd-a01023a1319a:0:0. New state: FINISHED</span><br><span class="line">2015-07-10 11:22:02,424 [2a60c5a4-e01a-ac02-84fd-a01023a1319a:frag:0:0] DEBUG o.a.d.e.w.f.NonRootStatusReporter - Sending status change message message to remote node: profile &#123;</span><br><span class="line">  state: FINISHED</span><br><span class="line">  minor_fragment_id: 0</span><br><span class="line">  operator_profile &#123;</span><br><span class="line">    input_profile &#123;</span><br><span class="line">      records: 1155</span><br><span class="line">      batches: 1</span><br><span class="line">      schemas: 1</span><br><span class="line">    &#125;</span><br><span class="line">    operator_id: 3</span><br><span class="line">    operator_type: 29</span><br><span class="line">    setup_nanos: 0</span><br><span class="line">    process_nanos: 22301000</span><br><span class="line">    peak_local_memory_allocated: 4608</span><br><span class="line">    wait_nanos: 133000</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>最后Forman也会关闭, Foreman的状态从RUNNING到COMPLETED.  打印resultArrived的时候其实结果已经在sqlline上输出了.<br>剩下就是一些资源移除,注销之类的工作了. 其实和最开始的资源申请,注册是对应的.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2015-07-10 11:22:02,427 [BitServer-4] INFO  o.a.drill.exec.work.foreman.Foreman - State change requested.  RUNNING --&gt; COMPLETED</span><br><span class="line">2015-07-10 11:22:02,427 [BitServer-4] INFO  o.a.drill.exec.work.foreman.Foreman - foreman cleaning up.</span><br><span class="line">2015-07-10 11:22:02,429 [BitServer-4] DEBUG o.a.d.exec.rpc.control.WorkEventBus - Removing fragment status listener for queryId 2a60c5a4-e01a-ac02-84fd-a01023a1319a.</span><br><span class="line">2015-07-10 11:22:02,430 [BitServer-4] DEBUG o.apache.drill.exec.memory.Accountor - Fragment 0:0  accountor being closed</span><br><span class="line">2015-07-10 11:22:02,446 [BitServer-4] DEBUG o.a.d.exec.rpc.control.ControlServer - Sending response with Sender 739019148</span><br><span class="line">2015-07-10 11:22:02,447 [Client-1] DEBUG o.a.d.e.rpc.user.QueryResultHandler - resultArrived: queryState: COMPLETED, queryId = part1: 3053657859282349058</span><br><span class="line">part2: -8863752500417580646</span><br><span class="line"></span><br><span class="line">2015-07-10 11:22:02,448 [Client-1] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [#3] Received query completion: COMPLETED.</span><br><span class="line">2015-07-10 11:22:02,448 [Client-1] DEBUG o.a.drill.exec.rpc.user.UserClient - Sending response with Sender 264929084</span><br><span class="line">2015-07-10 11:22:02,479 [main] DEBUG o.a.d.j.i.DrillResultSetImpl$ResultsListener - [#3] Query listener closing.</span><br><span class="line">2015-07-10 11:22:02,479 [main] DEBUG o.a.d.j.impl.DrillStatementRegistry - Removing from open-statements registry: org.apache.drill.jdbc.impl.DrillStatementImpl@4eb2bb3d</span><br></pre></td></tr></table></figure>
<h2 id="Logical_Plan逻辑计划">Logical Plan逻辑计划</h2><p><a href="http://drill.apache.org/docs/drill-plan-syntax/" target="_blank" rel="noopener">http://drill.apache.org/docs/drill-plan-syntax/</a><br><a href="https://docs.google.com/document/d/1QTL8warUYS2KjldQrGUse7zp8eA72VKtLOHwfXy6c7I/edit" target="_blank" rel="noopener">https://docs.google.com/document/d/1QTL8warUYS2KjldQrGUse7zp8eA72VKtLOHwfXy6c7I/edit</a><br><a href="http://yangyoupeng-cn-fujitsu-com.iteye.com/blog/1971728" target="_blank" rel="noopener">http://yangyoupeng-cn-fujitsu-com.iteye.com/blog/1971728</a></p>
<p>在Architecture中我们见到这张图了</p>
<p><img src="http://drill.apache.org/docs/img/client-phys-plan.png" alt></p>
<p>在DesignDoc中是一张比较粗略的图</p>
<p><img src="http://drill.apache.org/docs/img/slide-15-638.png" alt></p>
<p>总的来说过程就是: 查询语句–解析器–逻辑计划–优化器–物理计划–执行引擎</p>
<p>关于逻辑计划比较详细的文档也给出了(上面第二个链接,请自行fq).</p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill3.png" alt></p>
<p>以Logical Plan Operators的Scan为例</p>
<blockquote>
<p>The Scan operator outputs a stream of records. The “storageengine” argument must refer by name to a storage engine defined in the engines clause of the logical plan. The “selection” argument accepts a JSON object that is used by the data source itself to limit the amount of data actually retrieved. The format and content of this object is specific to the actual input source being used. Examples might include an HBase table name, a MongoDB collection, an HDFS path or a partition of a Hive table. Data sources will use the the selection argument in an implementation-specific way.  The provided “ref” argument ensures that all records within the scanned source are held in the provided namespace.<br>{ @id†: &lt; opref &gt;, op: “scan”,<br>   storageengine: &lt; string &gt;,<br>   selection*: &lt; json &gt;,<br>   ref: &lt; name &gt;<br> }</p>
</blockquote>
<p>Scan操作算子会输出记录流. 参数storageengine必须引用逻辑计划中定义的engine声明.<br>selection参数接收JSON对象,会被数据源使用,用于限制接收到的数据的数量.<br>这个JSON对象的格式和内容和实际的数据源有关.比如HBase的表名,MongoDB的集合,HDFS的路径,或者Hive表的一个分区.  </p>
<blockquote>
<p>Talk is cheap, Show me the Code. </p>
</blockquote>
<p>在<code>org.apache.drill.common.logical.data</code>有很多上文提到的操作符比如Scan,Join,Project,Union等.  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill5.png" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@JsonTypeName(&quot;scan&quot;)</span><br><span class="line">public class Scan extends SourceOperator &#123;</span><br><span class="line">  private final String storageEngine;</span><br><span class="line">  private final JSONOptions selection;</span><br><span class="line"></span><br><span class="line">  @JsonCreator</span><br><span class="line">  public Scan(@JsonProperty(&quot;storageengine&quot;) String storageEngine, @JsonProperty(&quot;selection&quot;) JSONOptions selection) &#123;</span><br><span class="line">    super();</span><br><span class="line">    this.storageEngine = storageEngine;</span><br><span class="line">    this.selection = selection;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @JsonProperty(&quot;storageengine&quot;)</span><br><span class="line">  public String getStorageEngine() &#123; return storageEngine; &#125;</span><br><span class="line"></span><br><span class="line">  public JSONOptions getSelection() &#123;  return selection; &#125;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public &lt;T, X, E extends Throwable&gt; T accept(LogicalVisitor&lt;T, X, E&gt; logicalVisitor, X value) throws E &#123;</span><br><span class="line">      return logicalVisitor.visitScan(this, value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>LogicalVisitor</code>是逻辑(操作符)的访问器. Visitor class designed to traversal of a operator tree.  遍历一颗操作符树<br>Basis for a number of operator manipulations including fragmentation and materialization. 对算子的维护包括分片,序列化</p>
<p>Scan操作比较简单, 它继承的是SourceOperator:An operator that produces data without any parents.  (zero input operator)</p>
<blockquote>
<p>Operator分成若干类，每一个operator都标示了它的类型，目前operator类包括：<br>0：可以产生不依赖其他operator的数据，类似于源数据. 比如Scan,<br>1：该operator可以处理一个单独input source, 比如Project,Order,Limit等<br>M：可以处理多个input source数据<br>K：该operator不会产生输出。 </p>
</blockquote>
<p>我们知道Project包括字段和表达式, 比如count(<em>), 其中</em>是ref引用,count是expr表达式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@JsonTypeName(&quot;project&quot;)</span><br><span class="line">public class Project extends SingleInputOperator &#123;</span><br><span class="line">  private final NamedExpression[] selections;</span><br><span class="line"></span><br><span class="line">@JsonPropertyOrder(&#123;&quot;ref&quot;, &quot;expr&quot;&#125;)</span><br><span class="line">public class NamedExpression &#123;</span><br><span class="line">  private final LogicalExpression expr;</span><br><span class="line">  private final FieldReference ref;</span><br></pre></td></tr></table></figure>
<p>在org.apache.drill.common.logical这个包下有个比较重要的类LogicalPlan,先来看看Plan的属性有哪些</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class PlanProperties &#123;</span><br><span class="line">  public static enum PlanType &#123;APACHE_DRILL_LOGICAL, APACHE_DRILL_PHYSICAL&#125;</span><br><span class="line"></span><br><span class="line">  public PlanType type;</span><br><span class="line">  public int version;</span><br><span class="line">  public Generator generator;</span><br><span class="line">  public ResultMode resultMode;</span><br><span class="line">  public JSONOptions options;</span><br><span class="line">  public int queue;</span><br><span class="line"></span><br><span class="line">  public static class Generator &#123;</span><br><span class="line">    public String type;</span><br><span class="line">    public String info;</span><br><span class="line"></span><br><span class="line">    public static enum ResultMode &#123;</span><br><span class="line">      EXEC, LOGICAL, PHYSICAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private Generator(@JsonProperty(&quot;type&quot;) String type, @JsonProperty(&quot;info&quot;) String info) &#123;</span><br><span class="line">      this.type = type;</span><br><span class="line">      this.info = info;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>对应了前面的Drill Plan中head部分的输出(虽然前面我们看到的Drill Plan应该是物理计划,而不是逻辑计划,但是head部分是一样的)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;head&quot; : &#123;</span><br><span class="line">    &quot;version&quot; : 1,</span><br><span class="line">    &quot;generator&quot; : &#123;</span><br><span class="line">      &quot;type&quot; : &quot;DefaultSqlHandler&quot;,</span><br><span class="line">      &quot;info&quot; : &quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;type&quot; : &quot;APACHE_DRILL_PHYSICAL&quot;,</span><br><span class="line">    &quot;options&quot; : [ ],</span><br><span class="line">    &quot;queue&quot; : 0,</span><br><span class="line">    &quot;resultMode&quot; : &quot;EXEC&quot;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<p>逻辑计划LogicalPlan包含了三个部分: head,storage,query.  </p>
<p><a href="http://www.confusedcoders.com/bigdata/apache-drill/understanding-apache-drill-logical-plan" target="_blank" rel="noopener">http://www.confusedcoders.com/bigdata/apache-drill/understanding-apache-drill-logical-plan</a></p>
<blockquote>
<p>The query node is the actual query that we want to execute on Drill. The query itself is a collection of operations on the data.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@JsonPropertyOrder(&#123; &quot;head&quot;, &quot;storage&quot;, &quot;query&quot; &#125;)</span><br><span class="line">public class LogicalPlan &#123;</span><br><span class="line">  static final Logger logger = LoggerFactory.getLogger(LogicalPlan.class);</span><br><span class="line"></span><br><span class="line">  private final PlanProperties properties;</span><br><span class="line">  private final Map&lt;String, StoragePluginConfig&gt; storageEngineMap;</span><br><span class="line">  private final Graph&lt;LogicalOperator, SinkOperator, SourceOperator&gt; graph;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  @JsonCreator</span><br><span class="line">  public LogicalPlan(@JsonProperty(&quot;head&quot;) PlanProperties head,</span><br><span class="line">      @JsonProperty(&quot;storage&quot;) Map&lt;String, StoragePluginConfig&gt; storageEngineMap,</span><br><span class="line">      @JsonProperty(&quot;query&quot;) List&lt;LogicalOperator&gt; operators) &#123;</span><br><span class="line">    this.storageEngineMap = storageEngineMap != null ? storageEngineMap : new HashMap&lt;String, StoragePluginConfig&gt;();</span><br><span class="line">    this.properties = head;</span><br><span class="line">    this.graph = Graph.newGraph(operators, SinkOperator.class, SourceOperator.class);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>query是逻辑操作符集合, 它们和Sink,Source操作符一起构成了一张逻辑计划数据流的执行图graph.<br>LogicalPlan的构建器的build()会创建LogicalPlan对象. 这个Builder对象提供了逻辑计划的编程接口.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class LogicalPlanBuilder &#123;</span><br><span class="line">  private PlanProperties planProperties;</span><br><span class="line">  private ImmutableMap.Builder&lt;String, StoragePluginConfig&gt; storageEngines = ImmutableMap.builder();</span><br><span class="line">  private ImmutableList.Builder&lt;LogicalOperator&gt; operators = ImmutableList.builder();</span><br><span class="line"></span><br><span class="line">  public LogicalPlanBuilder addLogicalOperator(LogicalOperator operator) &#123;</span><br><span class="line">    this.operators.add(operator);</span><br><span class="line">    return this;</span><br><span class="line">  &#125;</span><br><span class="line">  public LogicalPlan build() &#123;</span><br><span class="line">    return new LogicalPlan(this.planProperties, this.storageEngines.build(), this.operators.build());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在build之前,要构建一个完整的图,要调用相应的addXXX()方法,因为方法返回this,所以调用者可以链式调用.<br>build就是构建者模式,一旦调用了build方法,返回的对象就是不可修改的.因此要在build前填充所有的数据.  </p>
<h2 id="PhysicalPlan物理计划">PhysicalPlan物理计划</h2><p>怎么知道前面日志中打印的Drill Plan是物理计划,而不是逻辑计划, 首先可以从调用的类DefaultSqlHandler,搜索Drill Plan</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public PhysicalPlan getPlan(SqlNode sqlNode) &#123;</span><br><span class="line">  final ConvertedRelNode convertedRelNode = validateAndConvert(sqlNode);</span><br><span class="line">  final RelDataType validatedRowType = convertedRelNode.getValidatedRowType();</span><br><span class="line">  final RelNode queryRelNode = convertedRelNode.getConvertedNode();</span><br><span class="line"></span><br><span class="line">  log(&quot;Optiq Logical&quot;, queryRelNode, logger);</span><br><span class="line">  DrillRel drel = convertToDrel(queryRelNode, validatedRowType);</span><br><span class="line"></span><br><span class="line">  log(&quot;Drill Logical&quot;, drel, logger);</span><br><span class="line">  Prel prel = convertToPrel(drel);</span><br><span class="line">  log(&quot;Drill Physical&quot;, prel, logger);</span><br><span class="line">  PhysicalOperator pop = convertToPop(prel);</span><br><span class="line">  PhysicalPlan plan = convertToPlan(pop);</span><br><span class="line">  log(&quot;Drill Plan&quot;, plan, logger);</span><br><span class="line">  return plan;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1.可以看到在上面的getPlan方法中, 依次生成的计划是: Optiq逻辑计划–&gt;Drill逻辑计划–&gt;Drill物理计划<br>2.物理计划和逻辑计划一样也有很多operator, 都在`org.apache.drill.exec.physical包下<br>3.Optiq现在变成Apache的Calcite, 入门教程: <a href="http://blog.csdn.net/yunlong34574/article/details/46375733" target="_blank" rel="noopener">http://blog.csdn.net/yunlong34574/article/details/46375733</a></p>
<p>getPlan调用树是被Foreman线程运行,由Foreman创建的DrillSqlWorker调用执行的.  </p>
<p><img src="http://7xjs7x.com1.z0.glb.clouddn.com/drill4.png" alt></p>
<p>真正运行物理计划,还是在Foreman的runPhysicalPlan中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private void runSQL(final String sql) throws ExecutionSetupException &#123;</span><br><span class="line">  final DrillSqlWorker sqlWorker = new DrillSqlWorker(queryContext);</span><br><span class="line">  final Pointer&lt;String&gt; textPlan = new Pointer&lt;&gt;();</span><br><span class="line">  final PhysicalPlan plan = sqlWorker.getPlan(sql, textPlan);</span><br><span class="line">  queryManager.setPlanText(textPlan.value);</span><br><span class="line">  runPhysicalPlan(plan);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
  </div>
  
    
<div class="copyright">
  <p><span>本文标题:</span><a href="/2015/07/10/2015-07-10-drill-log/">Apache Drill源码阅读(1) 环境准备和查看日志</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 任何忧伤,都抵不过世界的美丽 的个人博客">任何忧伤,都抵不过世界的美丽</a></p>
  <p><span>发布时间:</span>2015年07月10日 - 00时00分</p>
  <p><span>最后更新:</span>2019年02月14日 - 21时42分</p>
  <p>
    <span>原始链接:</span><a href="/2015/07/10/2015-07-10-drill-log/" title="Apache Drill源码阅读(1) 环境准备和查看日志">http://github.com/zqhxuyuan/2015/07/10/2015-07-10-drill-log/</a>
    <span class="btn" data-clipboard-text="原文: http://github.com/zqhxuyuan/2015/07/10/2015-07-10-drill-log/　　作者: 任何忧伤,都抵不过世界的美丽" title="点击复制文章链接">
        <i class="fa fa-clipboard"></i>
    </span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。</p>
  <script src="/js/clipboard.min.js"></script>
  <script> var clipboard = new Clipboard('.btn'); </script>
</div>
<style type="text/css">
  .copyright p .btn {
    margin-left: 1em;
  }
  .copyright:hover p .btn::after {
    content: "复制"
  }
  .copyright p .btn:hover {
      color: gray;
      cursor: pointer;
    };
</style>



<nav id="article-nav">
  
    <div id="article-nav-newer" class="article-nav-title">
      <a href="/2015/07/12/2015-07-12-drill-rpc/">
        Apache Drill源码阅读(2) 分析一次查询过程以及RPC
      </a>
    </div>
  
  
    <div id="article-nav-older" class="article-nav-title">
      <a href="/2015/07/09/2015-07-09-Apache-Drill/">
        Apache Drill入门
      </a>
    </div>
  
</nav>

  
  
    <div class="post-donate">
	<br>
	<p>
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           &uarr;<br>
		   招人广告：对蚂蚁金服中间件感兴趣的可以发邮件到：qihuang.zqh at antfin.com
        </span>
        <br>
    </div>  
	<div id="donate_guide" class="donate_bar center hidden">
		<img src="/img/zhifubao.png" alt="支付宝打赏"> 
		<img src="/img/weixin.png" alt="微信打赏">  
    </div>
	<script type="text/javascript">
		document.getElementById('btn_donate').onclick = function(){
			$('#donate_board').addClass('hidden');
			$('#donate_guide').removeClass('hidden');
		}
	</script>
</p></div>
  
</article>

<!-- 默认显示文章目录，在文章---前输入toc: false关闭目录 -->
<!-- Show TOC and tocButton in default, Hide TOC via putting "toc: false" before "---" at [post].md -->
<div id="toc" class="toc-article">
<strong class="toc-title">文章目录</strong>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作"><span class="toc-number">1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#日志分析"><span class="toc-number">2.</span> <span class="toc-text">日志分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Logical_Plan逻辑计划"><span class="toc-number">3.</span> <span class="toc-text">Logical Plan逻辑计划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PhysicalPlan物理计划"><span class="toc-number">4.</span> <span class="toc-text">PhysicalPlan物理计划</span></a></li></ol>
</div>
<style type="text/css">
  .left-col .switch-btn {
    display: none;
  }
  .left-col .switch-area {
    display: none;
  }
</style>

<input type="button" id="tocButton" value="隐藏目录" title="点击按钮隐藏或者显示文章目录">
<script type="text/javascript">
  var toc_button= document.getElementById("tocButton");
  var toc_div= document.getElementById("toc");
  /* Show or hide toc when click on tocButton.
  通过点击设置的按钮显示或者隐藏文章目录.*/
  toc_button.onclick=function(){
  if(toc_div.style.display=="none"){
  toc_div.style.display="block";
  toc_button.value="隐藏目录";
  document.getElementById("switch-btn").style.display="none";
  document.getElementById("switch-area").style.display="none";
  }
  else{
  toc_div.style.display="none";
  toc_button.value="显示目录";
  document.getElementById("switch-btn").style.display="block";
  document.getElementById("switch-area").style.display="block";
  }
  }
    if ($(".toc").length < 1) {
        $("#toc").css("display","none");
        $("#tocButton").css("display","none");
        $(".switch-btn").css("display","block");
        $(".switch-area").css("display","block");
    }
</script>


    <style>
        .toc {
            white-space: nowrap;
            overflow-x: hidden;
        }
    </style>

    <script>
        $(document).ready(function() {
            $(".toc li a").mouseover(function() {
                var title = $(this).attr('href');
                $(this).attr("title", title);
            });
        })
    </script>




<div class="share">
	<div class="bdsharebuttonbox">
	<a href="#" class="bds_more" data-cmd="more"></a>
	<a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
	<a href="#" class="bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
	<a href="#" class="bds_copy" data-cmd="copy" title="复制网址"></a>
	<a href="#" class="bds_mail" data-cmd="mail" title="通过邮件分享"></a>
	<a href="#" class="bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
	</div>
	<script>
	window._bd_share_config={
		"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
	</script>
</div>



<div class="duoshuo" id="comments">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="2015/07/10/2015-07-10-drill-log/" data-title="Apache Drill源码阅读(1) 环境准备和查看日志" data-url="http://github.com/zqhxuyuan/2015/07/10/2015-07-10-drill-log/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"zqhxuyuan"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>






    <style type="text/css">
    #scroll {
      display: none;
    }
    </style>
    <div class="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
    </div>


  
  
    
    <div class="post-nav-button">
    <a href="/2015/07/12/2015-07-12-drill-rpc/" title="上一篇: Apache Drill源码阅读(2) 分析一次查询过程以及RPC">
    <i class="fa fa-angle-left"></i>
    </a>
    <a href="/2015/07/09/2015-07-09-Apache-Drill/" title="下一篇: Apache Drill入门">
    <i class="fa fa-angle-right"></i>
    </a>
    </div>
  



    
        <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
        <script>
        var yiliaConfig = {
        fancybox: true,
        mathjax: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        open_in_new: false
        }
        </script>
        
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <div class="footer-left">
        &copy; 2019 任何忧伤,都抵不过世界的美丽
      </div>
        <div class="footer-right">
          <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的静态博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减双栏 Hexo 博客主题">Yelee</a> by MOxFIVE
        </div>
    </div>
    <div class="visit">
      <span id="busuanzi_container_site_pv" style="display:none">
        <span id="site-visit">本站到访数: 
        <span id="busuanzi_value_site_uv"></span>
        </span>
      </span>
      <span id="busuanzi_container_page_pv" style="display:none">
        <span id="page-visit">, 本页阅读量: 
        <span id="busuanzi_value_page_pv"></span>
        </span>
      </span>
    </div>
  </div>
</footer>
    </div>
    

<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

<script>
  var backgroundnum = 5;
  var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));

  $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
</script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-80646710-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
<a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
<a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>